:: StoryTitle
Plantilla so i mapes v3 1


:: StoryData
{
  "ifid": "5a630f41-0bdb-4ec1-8358-8b722e3eba30",
  "format": "Harlowe",
  "format-version": "3.3.9",
  "start": "laboratori",
  "tag-colors": {
    "No-tocar": "red",
    "Editar": "orange",
    "Llegir": "green",
    "startup": "orange"
  },
  "zoom": 1
}


:: ExecutaSetter (Borrar?) [No-tocar] {"position":"50,525","size":"100,100"}
(set: $setterParts to (split: $comandaSetter, " to "))
(if: (length: $setterParts) is 2)[
  (set: $nomVar to (trim: $setterParts's 1st))
  (set: $valorVar to (trim: $setterParts's 2nd))
  (if: $nomVar's 1st is "$")[
    (set: $nomNet to (substring: $nomVar, 2))
    (set: (variable: "$" + $nomNet) to $valorVar)
  ]
]
(goto: $retornA)



:: Instruccions per crear mapes d'imatge [Llegir] {"position":"50,150","size":"100,100"}
<!--
1. Anar a https://xaviuab.github.io/mapa_imatges_harlowe/
1.1 Carrega la imatge que utikitzaras a Twine (hauria d'estar en una carpeta anomenada "imatges")
1.2 Dibuixa un rectangle sobre la zona que  vols fer "sensible" (hotspot), Reaccionarà quan el ratolí entri o quan es faci clic
1.3 Selecciona si vols que sigui un hotspot de navegació (que canvii de passatge) o de variable (que canvii el valor d'una variable)
1.4 Afegeix els textos i els sons que han de mostrar-se quan l'usuari interactui amb el hotspot
1.5. Crea tants hotspots com siguin necessaris
1.6. Fes clic al botó de "Copiar Codi"
1.7. Enganxa-ho al passatge de Twine corresponent

AVANÇAT
Pots crear condicions i, mentre no es compleixin, que sonin o es mostrin altres textos.
També pots limitar el nombre de vegades que s'interactua amb un hotspot
Fins i tot pots modificar una "variable secundària" si cal

ATENCIÓ ATENCIÓ ATENCIÓ ATENCIÓ ATENCIÓ ATENCIÓ
Pots carregar codi ja creat dins del "Editor de Hotspots per Twine"
PERÔ ELIMINARÀ TOT EL CODI QUE NO CORRESPONGUI AL  SISTEMA DE HOTSPOTS.
Si has afegit codi al passatge no generat pel sistema, no l'esborris del passatge, ni substitueixis completament el codi generat pel que ja tenies.




Tutorial bàsic de Twine disponible a https://bit.ly/Tutorial_Twine

->


:: Instruccions per incloure so [Llegir] {"position":"175,150","size":"100,100"}
<!--
1. Dins de "hal.tracks" hem de registrar els sons que farem servir

1.1 Dedicarem una línea per a cada so seguint aquesta estructura:
"àlies: URL del So".
Exemple: 
ocellet: https://static.wixstatic.com/mp3/d2f47f_742a2f12b2d745cd9abe728ce9f5671f.mp3
lemur: https://static.wixstatic.com/mp3/d2f47f_c7599443d69947c6b97b8d6efc8af3d7.mp3

1.2 també els pots tenir en una carpeta (anomenada "sons" per exemple)
Hauràs de posar el nom que utilitzaras al Twine + ":" (dos punts) + nom de la carpeta + "/" (barra) + el nom del fitxer MP3. Així:
pc_ok:sons/pc_ok.mp3

2. Per fer sonar els àudios escriu el codi  (track: 'àlies', 'acció') al final del passatge.
2.1. 
Música de fons per a tota la història
A la pàgina inicial has d'incloure dues instruccions: una per indicar que el fitxer es reproduirà indefinidament (loop) i una altre per iniciar el so.
Així:
(track: 'musica', 'loop', true)
(track: 'musica', 'playwhenpossible')

2.2. 
So a l'entrar a una pàgina
Simplement s'ha d'escriure (track: 'NomAssignatAlSo', 'AccióAExecutar').
L'acció a executar serà "play" o "playwhenpossible". Així:
(track: 'ocellet', 'playwhenpossible')
 o 
 (track: 'lemur', 'play')

2.3.
So al fer clic sobre una imatge
A vegades pot ser interessant que el o la jugadora interactui amb les imatges.
Podem fer que al fer clic sobre una imatge, soni una música, un efecte, una veu...
Per fer això hem de conèixer la URL de la imatge i escriure el seguent codi:

{link-repeat:'<img src = "URL DE LA IMAGE">'
[
	(track: 'àlies del so a hal.tracks', 'accio')
	]
}


2.4.
Per aturar un so utilitzar l'acció "stop"
Exemple:  (track: 'lemur', 'stop')


->


:: Per llegir [Llegir] {"position":"50,25","size":"100,100"}
Els passatges marcats en ''verd'' donen informació
Els passatges en ''taronja'' es poden editar
Els passatges ''vermells'' ''NO ES  PODEN MODIFICAR''

''ATENCIÓ''!
El "JavaScript" i el "Stylesheet" (dins de "Story") estan programats perquè tot funcioni correctament. 
Modificar el contingut és possible però cal saber què es fa. Cnaviar alguna cosa pot suposar que el sistema deixi de funcionar


:: Pis superior {"position":"675,500","size":"100,100"}
<div class="twine-image-wrapper" style="min-width:1344px;">
<div id="inventory-container"></div>
<div id="cursor-label"></div>
    <img src="imatges/pis_superior.png" usemap="#hotspotmap" alt="Imatge amb hotspots">
    <map name="hotspotmap">
    <!-- Escala -->
        <area shape="rect"
            coords="422,610,566,692"
            alt="Escala"
            class="hotspot-item"
            data-passage="cabana"
            data_info="Anar a baix"
        >

    </map>
    <div id="twineImageInfoDisplay" style="display: none;">(live: 0.1s)[(print: $tempInfoDisplay)]</div>
</div>

(live: 0.1s)[
    <span id="Ocult" style="display:none;">
    (link: "cabana")[(goto: "cabana")]
    </span>
]



:: StoryInit [startup] {"position":"175,275","size":"100,100"}
(set:_comentari to "No esborrar la variable tempInfoDisplay")\
(set: $tempInfoDisplay to "")\
(set:_comentari to "A partir d'aquí, posa els valors inicials a les variables del joc")\
(set: num-type $diners_peixera to 1502)
(set: $passa to 0)
(set: num-type $rom to 0)


:: beure {"position":"1150,150","size":"100,100"}
Beure
[[laboratori2]]


:: cabana {"position":"500,525","size":"100,100"}
<div class="twine-image-wrapper" style="min-width:1344px;">
<div id="inventory-container"></div>
<div id="cursor-label"></div>
    <img src="imatges/cabana.png" usemap="#hotspotmap" alt="Imatge amb hotspots">
    <img src="imatges/botes.png" class="twine-overlay" data-hotspot-id="1" style="position:absolute; left:41.22%; top:57.03%; width:6.25%; height:17.71%; pointer-events:none;">
    <map name="hotspotmap">
    <!-- Botes -->
        <area shape="rect"
            coords="554,438,638,574"
            alt="Botes"
            class="hotspot-item"
            data-overlay-enabled="true"
            data-overlay-filename="imatges/botes.png"
            data-overlay-inventoriable="true"
            data-overlay-remove-from-scene="true"
            data-overlay-condition-op="is"
            data-inventory-interactions='[{"targetHotspot":"pirata","text":"Jo no vull botes de pescar","var1":"","op1":"to","val1":"","var2":"","op2":"to","val2":""},{"targetHotspot":"Escala","text":"No deixis les botes al mig","var1":"","op1":"to","val1":"","var2":"","op2":"to","val2":""},{"targetHotspot":"Finestra","text":"Per què voldries llençar les botes per la finestra?","var1":"","op1":"to","val1":"","var2":"","op2":"to","val2":""}]'
            data-setter="$res to 0"
            data-variable-name="res"
            data-setter-op="to"
            data-setter-val="0"
            data_info="Unes velles botes de pescador"
            data_info_2="Les agafes"
            data-info-setter-inventori="Són unes botes velles de pescador que fan una olor... peculiar"
            data-info-setter-2-inventori="Un parell de botes de pescador "
            data-sound-click-setter-inventori="pc_error"
            data-sound-setter-inventori="pc_ok"
            data-title-text-setter-inventori="Botes de pescar"
        >

    <!-- caixa -->
        <area shape="rect"
            coords="33,635,183,761"
            alt="caixa"
            class="hotspot-item"
            data-passage="laboratori"
        >

    <!-- Escala -->
        <area shape="rect"
            coords="654,384,789,521"
            alt="Escala"
            class="hotspot-item"
            data-passage="Pis superior"
            data_info="Anar a dalt"
            data_info_2="Puja"
        >

    <!-- Escala -->
        <area shape="rect"
            coords="661,310,753,384"
            alt="Escala"
            class="hotspot-item"
            data-passage="Pis superior"
            data_info="Anar a dalt"
            data_info_2="Puja"
        >

    <!-- Finestra -->
        <area shape="rect"
            coords="773,215,912,381"
            alt="Finestra"
            class="hotspot-item"
            data-passage="finestra"
            data_info="Quines vistes!"
        >

    </map>
    <div id="twineImageInfoDisplay" style="display: none;">(live: 0.1s)[(print: $tempInfoDisplay)]</div>
</div>

(live: 0.1s)[
    <span id="Ocult" style="display:none;">
    (link: "laboratori")[(goto: "laboratori")]
    (link: "Pis superior")[(goto: "Pis superior")]
    (link: "Pis superior")[(goto: "Pis superior")]
    (link: "finestra")[(goto: "finestra")]
    </span>
]



:: finestra {"position":"950,325","size":"100,100"}
<div class="twine-image-wrapper" style="min-width:1344px;">
<div id="inventory-container"></div>
<div id="cursor-label"></div>
    <img src="imatges/llac.png" usemap="#hotspotmap" alt="Imatge amb hotspots">
    <map name="hotspotmap">
    <!-- Porta -->
        <area shape="rect"
            coords="286,391,315,450"
            alt="Porta"
            class="hotspot-item"
            data-passage="cabana"
            data_info="Entra a la cabana"
        >

    </map>
    <div id="twineImageInfoDisplay" style="display: none;">(live: 0.1s)[(print: $tempInfoDisplay)]</div>
</div>

(live: 0.1s)[
    <span id="Ocult" style="display:none;">
    (link: "cabana")[(goto: "cabana")]
    </span>
]


Diners Peixera: ''(print: $diners_peixera)
Diners: ''(print: $diners)''
Titol: ''(print: $llibre)
[[laboratori2]]


:: foc {"position":"750,350","size":"100,100"}
Foc
Diners Peixera: (print: $diners_peixera)
(track: 'ocellet' , 'playwhenpossible')
(t8n-arrive: "rumble")+(t8n-depart: "zoom")[[laboratori2]]


:: hal.tracks [Editar] {"position":"50,275","size":"100,100"}
ocellet:https://static.wixstatic.com/mp3/d2f47f_742a2f12b2d745cd9abe728ce9f5671f.mp3
lemur:https://static.wixstatic.com/mp3/d2f47f_c7599443d69947c6b97b8d6efc8af3d7.mp3
pc_ok:sons/pc_ok.mp3
pc_error:sons/pc_error.mp3


:: laboratori {"position":"400,400","size":"100,100"}
<div class="twine-image-wrapper" style="min-width:1472px;">
<div id="inventory-container"></div>
<div id="cursor-label"></div>
    <img src="imatges/laboratori.jpg" usemap="#hotspotmap" alt="Imatge amb hotspots">
(if: $passa < 2)[    <img src="imatges/pirata sense fons.png" class="twine-overlay" data-hotspot-id="8" style="position:absolute; left:11.68%; top:47.84%; width:22.21%; height:52.40%; pointer-events:none;">
]    <img src="imatges/2ampolles.png" class="twine-overlay" data-hotspot-id="9" style="position:absolute; left:79.14%; top:51.80%; width:7.40%; height:19.23%; pointer-events:none;">
    <map name="hotspotmap">
    <!-- flama -->
        <area shape="rect"
            coords="510,350,574,496"
            alt="flama"
            class="hotspot-item"
            data-sound="ocellet"
            data-passage="foc"
            data_info="És una flama i crema $diners_peixera"
            data-transition-depart="rumble"
            data-transition-arrive="flicker"
            title="crema"
        >

    <!-- finestra -->
        <area shape="rect"
            coords="675,164,813,483"
            alt="finestra"
            class="hotspot-item"
            data-condition="$diners &gt; 999"
            data-condition-var="diners"
            data-condition-op="&gt;"
            data-condition-val="999"
            text_fail_clic="No pots passar si no tens 1000"
            text_fail_enter="Per passar necessites diners"
            data-sound-fail="pc_error"
            data-sound-click-fail="pc_error"
            data-sound="lemur"
            data-sound-click="pc_ok"
            data-passage="finestra"
            data_info="Ja tens els diners!"
            data-transition-depart="zoom"
            data-transition-arrive="flicker"
            title="Vidres transparents"
        >

    <!-- caixa -->
        <area shape="rect"
            coords="959,580,1065,748"
            alt="caixa"
            class="hotspot-item"
            data-condition="$diners &gt; 499"
            data-condition-var="diners"
            data-condition-op="&gt;"
            data-condition-val="499"
            text_fail_clic="Encara et falten diners"
            text_fail_enter="Has d&#039;obrir-la amb 500"
            data-sound-click-fail="pc_error"
            data-sound-click="pc_ok"
            data-passage="tancat"
            data_info="Ja tens 500€ o més. Pots entrar!"
            data-transition-depart="slide-up"
            data-transition-arrive="slide-up"
            title="Caixeta"
        >

    <!-- peixera -->
        <area shape="rect"
            coords="970,413,1154,498"
            alt="peixera"
            class="hotspot-item"
            data-setter="$diners += 501"
            data-variable-name="diners"
            data-setter-op="+="
            data-setter-val="501"
            data_info="Aquí hi ha 1001 euros"
            data_info_2="Has agafat els diners. Ara tens $diners €!"
            title="Fes clic i tindràs 501€ més"
            data-visit-limit="4"
            data-visit-limit-enter="Ups!"
            data-visit-limit-clic="Ja no pots agafar més diners"
        >

    <!-- llibres -->
        <area shape="rect"
            coords="304,326,457,392"
            alt="llibres"
            class="hotspot-item"
            data-condition="$ulleres == 1"
            data-condition-var="ulleres"
            data-condition-op="=="
            data-condition-val="1"
            text_fail_clic="Busca unes ulleres"
            text_fail_enter="No puc llegir bé. Necessito ulleres"
            data-setter="$llibre to Platero y tú"
            data-variable-name="llibre"
            data-setter-op="to"
            data-setter-val="Platero y tú"
            data_info="Com es dirà aquest llibre gruixut?"
            data_info_2="Es diu $llibre"
            title="Nom del llibre?"
        >

    <!-- ulleres -->
        <area shape="rect"
            coords="169,241,241,323"
            alt="ulleres"
            class="hotspot-item"
            data-condition="$diners &gt; 1999"
            data-condition-var="diners"
            data-condition-op="&gt;"
            data-condition-val="1999"
            text_fail_clic="Necessites 2000€"
            text_fail_enter="Són unes ulleres molt cares"
            data-setter="$ulleres to 1"
            data-variable-name="ulleres"
            data-setter-op="to"
            data-setter-val="1"
            data_info="És un estoig d&#039;ulleres"
            data_info_2="Has agafat les ulleres"
            title="És un estoig d&#039;ulleres"
            data-visit-limit="1"
            data-visit-limit-enter="És un estoig d&#039;ulleres buit"
            data-visit-limit-clic="Ja has agafat les ulleres"
        >

    <!-- Brúixola -->
        <area shape="rect"
            coords="327,115,385,189"
            alt="Brúixola"
            class="hotspot-item"
            data-condition="$passa &gt;= 1"
            data-condition-var="passa"
            data-condition-op="&gt;="
            data-condition-val="1"
            text_fail_enter="No pots passar $passa"
            data-setter="$res to 0"
            data-variable-name="res"
            data-setter-op="to"
            data-setter-val="0"
            data_info="És una brúixola màgica"
            data_info_2="Està molt amunt. No pots arribar"
        >

    <!-- Pirata -->
        <area shape="rect"
            coords="172,398,499,834"
            alt="Pirata"
            class="hotspot-item"
            data-overlay-enabled="true"
            data-overlay-filename="imatges/pirata sense fons.png"
            data-overlay-condition="$passa &lt; 2"
            data-overlay-condition-var="passa"
            data-overlay-condition-op="&lt;"
            data-overlay-condition-val="2"
            data-variable-2-setter="$conversa to 1"
            data-variable-2-var="conversa"
            data-variable-2-op="to"
            data-variable-2-val="1"
            data-action="dialog"
            data-character="Pirata"
            data_info="Un vell pirata"
        >

    <!-- Ampolles -->
        <area shape="rect"
            coords="1165,431,1274,591"
            alt="Ampolles"
            class="hotspot-item"
            data-overlay-enabled="true"
            data-overlay-filename="imatges/2ampolles.png"
            data-overlay-inventoriable="true"
            data-overlay-remove-from-scene="true"
            data-overlay-condition-op="&lt;"
            data-inventory-interactions='[{"targetHotspot":"Pirata","text":"Pirata: Mmmmm. M&apos;encanta! Gràcies","var1":"passa","op1":"to","val1":"1","var2":"rom","op2":"to","val2":"0","removeItem":true},{"targetHotspot":"flama","text":"No les posis en el foc, que s&apos;escalfarà i no volem fer rom cremat!","var1":"","op1":"to","val1":"","var2":"","op2":"to","val2":""}]'
            data-variable-2-setter="$Ple to true"
            data-variable-2-var="Ple"
            data-variable-2-op="to"
            data-variable-2-val="true"
            data-condition="$pista_rom == 1"
            data-condition-var="pista_rom"
            data-condition-op="=="
            data-condition-val="1"
            text_fail_clic="A mi no m&#039;agrada el rom.
No sé per què em podrien servir"
            text_fail_enter="Dues ampolles de rom ($conversa)"
            data-setter="$rom to 2"
            data-variable-name="rom"
            data-setter-op="to"
            data-setter-val="2"
            data_info="Dues ampolles de rom més velles que tu i el pirata junts"
            data_info_2="Has agafat les ampolles"
            data-info-setter-inventori="Són dues ampolles de rom gran reserva"
            data-info-setter-2-inventori="2 ampolles de rom"
            data-title-text-setter-inventori="Ampolles de rom"
        >

    </map>
    <div id="twineImageInfoDisplay" style="display: none;">(live: 0.1s)[(print: $tempInfoDisplay)]</div>
</div>

(live: 0.1s)[
    <span id="Ocult" style="display:none;">
    (link: "foc")[(t8n-arrive: "flicker")+(t8n-depart: "rumble")(goto: "foc")]
    (if: $diners > 999)[(link: "finestra")[(t8n-arrive: "flicker")+(t8n-depart: "zoom")(goto: "finestra")]]
    (if: $diners > 499)[(link: "tancat")[(t8n-arrive: "slide-up")+(t8n-depart: "slide-up")(goto: "tancat")]]
    </span>
]

<!-- Dades de diàleg per a Pirata -->
<script type="application/json" id="Pirata">
{
    "id_dialogue": "Pirata",
    "characters": [
        {
            "id": "char_narrator",
            "name": "Pirata",
            "color": "#ff6600",
            "avatarUrl": "imatges/cara pirata.png",
            "avatarFileName": "cara pirata.png",
            "expressions": [
                {
                    "name": "Normal",
                    "url": "imatges/cara pirata.png",
                    "fileName": "cara pirata.png"
                },
                {
                    "name": "Enfadat",
                    "url": "imatges/cara enfadada.png",
                    "fileName": "cara enfadada.png"
                },
                {
                    "name": "Borratxo",
                    "url": "imatges/borratxo.png",
                    "fileName": "borratxo.png"
                },
                {
                    "name": "Trist",
                    "url": "imatges/trist.png",
                    "fileName": "trist.png"
                }
            ]
        }
    ],
    "globalVariables": {
        "rom": 0,
        "passa": 0
    },
    "nodes": [
        {
            "id": "node_start",
            "title": "Inici",
            "characterId": "char_narrator",
            "bgImage": "",
            "textOptions": [
                {
                    "text": "Què vols?",
                    "condition": "passa == 0"
                },
                {
                    "text": "Per què em molestes?",
                    "condition": "passa == 0"
                },
                {
                    "text": "Ja pots passar si vols",
                    "condition": "passa == 1"
                }
            ],
            "options": [
                {
                    "text": "Vull passar",
                    "targetNodeId": "node_1764409464077",
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "passa == 0",
                    "effect": "",
                    "cp1": {},
                    "cp2": {}
                },
                {
                    "text": "Ja me'n vaig",
                    "targetNodeId": null,
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "passa == 0",
                    "effect": ""
                },
                {
                    "text": "OK",
                    "targetNodeId": null,
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "passa == 1",
                    "effect": "passa = 2"
                },
                {
                    "text": "Tinc dues ampolles de rom ben bó... Qui les vol?...",
                    "targetNodeId": "node_1764435679581",
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "rom >= 2",
                    "effect": ""
                }
            ],
            "type": "start",
            "expressionOptions": [
                {
                    "expression": "",
                    "condition": "passa == 0"
                },
                {
                    "expression": "Borratxo",
                    "condition": "passa == 1"
                }
            ],
            "imageAlign": "right"
        },
        {
            "id": "node_1764409464077",
            "title": "Vull passar",
            "characterId": "char_narrator",
            "bgImage": "",
            "textOptions": [
                {
                    "text": "Per aquí no passa ningú",
                    "condition": ""
                },
                {
                    "text": "Impossible",
                    "condition": ""
                },
                {
                    "text": "Tinc ordres molt estrictes de no deixar passar ningú",
                    "condition": ""
                }
            ],
            "options": [
                {
                    "text": "Tothom té un preu",
                    "targetNodeId": "node_1764409798043",
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "rom == 0",
                    "effect": "",
                    "cp1": {},
                    "cp2": {}
                },
                {
                    "text": "Doncs provaré per una altra banda",
                    "targetNodeId": "node_1764409594483",
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "",
                    "effect": ""
                },
                {
                    "text": "Uff... Ni ho intento",
                    "targetNodeId": null,
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "",
                    "effect": ""
                },
                {
                    "text": "Tinc ampolles de rom",
                    "targetNodeId": "node_1764435679581",
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "rom >= 2",
                    "effect": ""
                }
            ],
            "characterExpression": "",
            "expressionOptions": [
                {
                    "expression": "Normal",
                    "condition": ""
                }
            ],
            "type": "decision",
            "imageAlign": "left"
        },
        {
            "id": "node_1764409594483",
            "title": "No hi ha més camins",
            "characterId": "char_narrator",
            "bgImage": "",
            "textOptions": [
                {
                    "text": "L'únic lloc per accedir és per aquí",
                    "condition": ""
                }
            ],
            "options": [
                {
                    "text": "Doncs deixa'm passar",
                    "targetNodeId": "node_1764409464077",
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "",
                    "effect": "",
                    "cp1": {},
                    "cp2": {}
                },
                {
                    "text": "Jo trobaré un altre via",
                    "targetNodeId": "node_1764409684251",
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "",
                    "effect": "",
                    "cp1": {},
                    "cp2": {}
                }
            ],
            "characterExpression": "Enfadat",
            "expressionOptions": [
                {
                    "expression": "Enfadat",
                    "condition": ""
                }
            ],
            "type": "normal",
            "imageAlign": "left"
        },
        {
            "id": "node_1764409684251",
            "title": "Ho dubto",
            "characterId": "char_narrator",
            "bgImage": "",
            "textOptions": [
                {
                    "text": "Ho dubto",
                    "condition": ""
                }
            ],
            "options": [
                {
                    "text": "Ja veurem",
                    "targetNodeId": null,
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "",
                    "effect": ""
                }
            ],
            "characterExpression": "Enfadat",
            "type": "end",
            "expressionOptions": [
                {
                    "expression": "",
                    "condition": ""
                }
            ],
            "imageAlign": "left"
        },
        {
            "id": "node_1764409798043",
            "title": "Tothom té un preu",
            "characterId": "char_narrator",
            "bgImage": "",
            "textOptions": [
                {
                    "text": "Ni que em portessis una ampolla de rom",
                    "condition": ""
                }
            ],
            "options": [
                {
                    "text": "Veig que ets insobornable",
                    "targetNodeId": null,
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "rom == 0",
                    "effect": ""
                },
                {
                    "text": "I si et portés DUES ampolla de rom?",
                    "targetNodeId": "node_1764409934139",
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "rom == 0",
                    "effect": "",
                    "cp1": {},
                    "cp2": {}
                }
            ],
            "characterExpression": "Borratxo",
            "expressionOptions": [
                {
                    "expression": "Borratxo",
                    "condition": ""
                }
            ],
            "type": "normal",
            "imageAlign": "left"
        },
        {
            "id": "node_1764409934139",
            "title": "Per Dues...",
            "characterId": "char_narrator",
            "bgImage": "",
            "textOptions": [
                {
                    "text": "Per dues ampolles vendria ma mare, que és l'únic familiar que encara no he venut",
                    "condition": ""
                }
            ],
            "options": [
                {
                    "text": "Doncs espera, que ara torno",
                    "targetNodeId": null,
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "",
                    "effect": "pista_rom = 1"
                }
            ],
            "expressionOptions": [
                {
                    "expression": "Trist",
                    "condition": ""
                }
            ],
            "type": "normal",
            "imageAlign": "left"
        },
        {
            "id": "node_1764435679581",
            "title": "Dóna rom",
            "characterId": "char_narrator",
            "bgImage": "",
            "textOptions": [
                {
                    "text": "Dóna-me-le i passes",
                    "condition": ""
                }
            ],
            "options": [
                {
                    "text": "Per tu són. Però a la teva mare te la quedes",
                    "targetNodeId": null,
                    "altTargetNodeId": null,
                    "targetCondition": "",
                    "once": false,
                    "condition": "",
                    "effect": "rom -= 2 ; passa = 1"
                }
            ],
            "expressionOptions": [
                {
                    "expression": "Borratxo",
                    "condition": ""
                }
            ],
            "type": "start",
            "imageAlign": "left"
        }
    ]
}
</script>



:: laboratori2 {"position":"475,50","size":"100,100"}
<div class="twine-image-wrapper" style="min-width:1472px;">

    <img src="imatges/laboratori.jpg" usemap="#hotspotmap" alt="Imatge amb hotspots">

    <map name="hotspotmap">
    <!-- flama -->
        <area shape="rect"
            coords="510,350,574,496"
            alt="flama"
            class="hotspot-item"
            data-sound="ocellet"
            data-passage="foc"
            data_info="És una flama i crema $diners_peixera"
            data-transition-depart="rumble"
            data-transition-arrive="flicker"
            title="crema"
        >

    <!-- finestra -->
        <area shape="rect"
            coords="675,164,813,483"
            alt="finestra"
            class="hotspot-item"
            data-condition-var="$diners"
            data-condition-val="&gt;999"
            text_fail_clic="No pots passar si no tens 1000"
            text_fail_enter="Per passar necessites diners"
            data-sound-fail="pc_error"
            data-sound-click-fail="pc_error"
            data-sound="lemur"
            data-sound-click="pc_ok"
            data-passage="finestra"
            data_info="Ja tens els diners!"
            data-transition-depart="zoom"
            data-transition-arrive="flicker"
            title="Vidres transparents"
        >

    <!-- caixa -->
        <area shape="rect"
            coords="959,580,1065,748"
            alt="caixa"
            class="hotspot-item"
            data-condition-var="$diners"
            data-condition-val="&gt;499"
            text_fail_clic="Encara et falten diners"
            text_fail_enter="Has d&#039;obrir-la amb 500"
            data-sound-click-fail="pc_error"
            data-sound-click="pc_ok"
            data-passage="tancat"
            data_info="Ja tens 500€ o més. Pots entrar!"
            data-transition-depart="slide-up"
            data-transition-arrive="slide-up"
            title="Caixeta"
        >

    <!-- peixera -->
        <area shape="rect"
            coords="970,413,1154,498"
            alt="peixera"
            class="hotspot-item"
            data-setter="$diners +=501"
            data_info="Aquí hi ha 1001 euros"
            data_info_2="Has agafat els diners. Ara tens $diners €!"
            title="Fes clic i tindràs 501€ més"
            data_variable="$diners"
            data_valor="+=501"
            data-visit-limit="4"
            data-visit-limit-enter="Ups!"
            data-visit-limit-clic="Ja no pots agafar més diners"
        >

    <!-- llibres -->
        <area shape="rect"
            coords="304,326,457,392"
            alt="llibres"
            class="hotspot-item"
            data-condition-var="$ulleres"
            data-condition-val="1"
            text_fail_clic="Busca unes ulleres"
            text_fail_enter="No puc llegir bé. Necessito ulleres"
            data-setter="$llibre = &quot;Platero y tú&quot;"
            data_info="Com es dirà aquest llibre gruixut?"
            data_info_2="Es diu $llibre"
            title="Nom del llibre?"
            data_variable="$llibre"
            data_valor="Platero y tú"
        >

    <!-- ulleres -->
        <area shape="rect"
            coords="301,430,373,512"
            alt="ulleres"
            class="hotspot-item"
            data-condition-var="$diners"
            data-condition-val="&gt;1999"
            text_fail_clic="Necessites 2000€"
            text_fail_enter="Són unes ulleres molt cares"
            data-setter="$ulleres = 1"
            data_info="És un estoig d&#039;ulleres"
            data_info_2="Has agafat les ulleres"
            title="És un estoig d&#039;ulleres"
            data_variable="$ulleres"
            data_valor="1"
            data-visit-limit="1"
            data-visit-limit-enter="És un estoig d&#039;ulleres buit"
            data-visit-limit-clic="Ja has agafat les ulleres"
        >

    <!-- Bruixola -->
        <area shape="rect"
            coords="327,115,385,189"
            alt="Bruixola"
            class="hotspot-item"
            data-setter="$res = 0"
            data_info="És una brúixola màgica"
            data_info_2="Està molt amunt. No pots arribar"
            data_variable="$res"
            data_valor="0"
        >

    </map>
 
    <div id="twineImageInfoDisplay" style="display: none;">(live: 0.1s)[(print: $tempInfoDisplay)]</div>
</div>   


(live: 0.1s)[
    <span id="Ocult" style="display:none;">
    (link: "foc")[(t8n-arrive: "flicker")+(t8n-depart: "rumble")(goto: "foc")]
    (if: $diners >999)[(link: "finestra")[(t8n-arrive: "flicker")+(t8n-depart: "zoom")(goto: "finestra")]]
    (if: $diners >499)[(link: "tancat")[(t8n-arrive: "slide-up")+(t8n-depart: "slide-up")(goto: "tancat")]]
    </span>
]


<!-- CODI DIÀLEG PER ENGANXAR AL PASSATGE -->
<script>
    // 1. Dades
    var jsonDiàleg = `
{
  "characters": [
    {
      "id": "char_narrator",
      "name": "Pirata",
      "color": "#ff6600"
    }
  ],
  "globalVariables": {
    "rom": 0,
    "passa": 0
  },
  "nodes": [
    {
      "id": "node_start",
      "title": "Inici",
      "characterId": "char_narrator",
      "textOptions": [
        {
          "text": "Què vols?",
          "condition": "passa ==0"
        },
        {
          "text": "Per què em molestes?",
          "condition": "passa == 0"
        },
        {
          "text": "Ja pots passar si vols",
          "condition": "passa == 1"
        }
      ],
      "options": [
        {
          "text": "Vull passar",
          "targetNodeId": "node_1764409464077",
          "once": false,
          "condition": "passa == 0"
        },
        {
          "text": "Ja me'n vaig",
          "once": false,
          "condition": "passa == 0"
        },
        {
          "text": "OK",
          "once": false,
          "condition": "passa == 1"
        }
      ]
    },
    {
      "id": "node_1764409464077",
      "title": "Vull passar",
      "characterId": "char_narrator",
      "textOptions": [
        {
          "text": "Per aquí no passa ningú"
        },
        {
          "text": "Impossible"
        },
        {
          "text": "Tinc ordres molt estrictes de no deixar passar ningú"
        }
      ],
      "options": [
        {
          "text": "Tothom té un preu",
          "targetNodeId": "node_1764409798043",
          "once": false
        },
        {
          "text": "Doncs provaré per una altra banda",
          "targetNodeId": "node_1764409594483",
          "once": false
        },
        {
          "text": "Uff... Ni ho intento",
          "once": false
        }
      ]
    },
    {
      "id": "node_1764409594483",
      "title": "No hi ha més camins",
      "characterId": "char_narrator",
      "textOptions": [
        {
          "text": "L'únic lloc per accedir és per aquí"
        }
      ],
      "options": [
        {
          "text": "Doncs deixa'm passar",
          "targetNodeId": "node_1764409464077",
          "once": false
        },
        {
          "text": "Jo trobaré un altre via",
          "targetNodeId": "node_1764409684251",
          "once": false
        }
      ]
    },
    {
      "id": "node_1764409684251",
      "title": "Ho dubto",
      "characterId": "char_narrator",
      "textOptions": [
        {
          "text": "Ho dubto"
        }
      ],
      "options": [
        {
          "text": "Ja veurem",
          "once": false
        }
      ]
    },
    {
      "id": "node_1764409798043",
      "title": "Tothom té un preu",
      "characterId": "char_narrator",
      "textOptions": [
        {
          "text": "Ni que em portessis una ampolla de rom"
        }
      ],
      "options": [
        {
          "text": "Veig que ets insobornable",
          "once": false,
          "condition": "rom == 0"
        },
        {
          "text": "I si et portés DUES ampolla de rom?",
          "targetNodeId": "node_1764409934139",
          "once": false,
          "condition": "rom == 0"
        },
        {
          "text": "Tin dues ampolles de rom ben bó... Qui les vol?",
          "targetNodeId": "node_1764435679581",
          "once": false,
          "condition": "rom == 2"
        }
      ]
    },
    {
      "id": "node_1764409934139",
      "title": "Per Dues...",
      "characterId": "char_narrator",
      "textOptions": [
        {
          "text": "Per dues ampolles vendria ma mare, que és l'únic familiar que encara no he venut"
        }
      ],
      "options": [
        {
          "text": "Doncs espera, que ara torno",
          "once": false,
          "effect": "rom = 2"
        }
      ]
    },
    {
      "id": "node_1764435679581",
      "title": "Dóna rom",
      "characterId": "char_narrator",
      "textOptions": [
        {
          "text": "Dóna-me-le i passes"
        }
      ],
      "options": [
        {
          "text": "Per tu són. Però a la teva mare te la quedes",
          "once": false,
          "effect": "rom = 0 ; passa = 1"
        }
      ]
    }
  ]
}
    `;

    // 2. Contenidor (adaptat al teu projecte)
    var containerId = 'twineImageInfoDisplay';
    var container = document.getElementById(containerId);

    // 3. Inicialització
    if (container && window.AdventureEngine) {
        container.style.display = 'block'; // Mostrar contenidor
        AdventureEngine.init(jsonDiàleg, containerId);
    } else {
        console.error("Error: Falta AdventureEngine o el contenidor '" + containerId + "'");
    }
</script>
<!-- Recorda: AdventureEngine gestiona la classe .adv-dialogue-active automàticament -->


:: tancat {"position":"1125,325","size":"100,100"}
(align:"=><=")[Tancat]
(align:"=><=")[Euros: (print: $diners)]€
[[laboratori2]]


:: StoryScript [script]
// =================================================================
// ESTRUCTURA DE DADES GLOBAL (SINGLE SOURCE OF TRUTH)
// =================================================================

window.AdventureGlobalVars = window.AdventureGlobalVars || {}; 

// Recuperar estat
try {
    const savedState = sessionStorage.getItem('AdventureGlobalVars');
    if (savedState) {
        window.AdventureGlobalVars = JSON.parse(savedState);
    }
} catch (e) { console.error("Error loading state", e); }

if (typeof State === 'undefined') {
    window.State = { variables: window.AdventureGlobalVars };
} else if (typeof State.variables === 'undefined') {
    State.variables = window.AdventureGlobalVars;
} else {
    Object.assign(window.AdventureGlobalVars, State.variables);
}

window.activeInventoryItem = null;

window.getGameVar = function(name) {
    const key = name.startsWith('$') ? name.substring(1) : name;
    if (typeof State !== 'undefined' && State.variables) return State.variables[key];
    return window.AdventureGlobalVars[key];
};

// SISTEMA D'ACTUALITZACIÓ OPTIMITZAT (DEBOUNCE)
let _globalUpdateTimer = null;

function requestGlobalUpdate() {
    if (_globalUpdateTimer) clearTimeout(_globalUpdateTimer);
    _globalUpdateTimer = setTimeout(function() {
        if (window.jQuery) jQuery(document).trigger('adventure:state-update');
    }, 10); 
}

window.setGameVar = function(name, value) {
    const key = name.startsWith('$') ? name.substring(1) : name;
    window.AdventureGlobalVars[key] = value;
    if (typeof State !== 'undefined' && State.variables) State.variables[key] = value;
    
    try {
        sessionStorage.setItem('AdventureGlobalVars', JSON.stringify(window.AdventureGlobalVars));
    } catch (e) { }
    
    requestGlobalUpdate();
    console.log(`UPDATED VAR: ${key} = ${value}`);
};

window.updateGameVar = function(name, op, val) {
    if (!name) return;
    let currentVal = window.getGameVar(name);
    let newVal = val;
    if (!isNaN(Number(val))) newVal = Number(val);
    else if (val === "true") newVal = true;
    else if (val === "false") newVal = false;

    if (currentVal === undefined) currentVal = (typeof newVal === 'number') ? 0 : "";

    switch (op) {
        case '=': 
        case 'to': window.setGameVar(name, newVal); break;
        case '+=': window.setGameVar(name, currentVal + newVal); break;
        case '-=': window.setGameVar(name, currentVal - newVal); break;
        case '*=': window.setGameVar(name, currentVal * newVal); break;
        case '/=': if (newVal !== 0) window.setGameVar(name, currentVal / newVal); break;
        default: window.setGameVar(name, newVal);
    }
};


// =================================================================
// ADVENTURE ENGINE
// =================================================================

window.AdventureEngine = (function() {
    let state = { nodes: [], characters: [], visited: new Set(), currentNodeId: null, containerId: 'dialogue-container' };

    function getCharacter(id) { return state.characters.find(c => c.id === id) || { name: '?', color: '#ccc' }; }
    
    function interpolateText(text) {
        if (!text) return "";
        return text.replace(/\{(\w+)\}/g, (_, v) => {
            const val = window.getGameVar(v);
            return (val !== undefined && val !== null) ? val : '';
        }).replace(/\$(\w+)/g, (_, v) => {
            const val = window.getGameVar(v);
            return (val !== undefined && val !== null) ? val : '';
        });
    }

    function evaluate(code) { 
        if (!code || !code.trim()) return true; 
        try { 
            const currentVars = (typeof State !== 'undefined' && State.variables) ? State.variables : window.AdventureGlobalVars;
            const keys = Object.keys(currentVars); 
            const values = Object.values(currentVars); 
            const safeCode = code.replace(/(^|[^<>!=])=([^=])/g, '$1==$2');
            const fn = new Function(...keys, `return ${safeCode};`); 
            return fn(...values); 
        } catch (e) { return false; } 
    }
    
    function execute(code) { 
        if (!code || !code.trim()) return; 
        try { 
            const parts = code.split(';');
            parts.forEach(part => {
                if(part.includes('=')) {
                    let [left, right] = part.split('=').map(s => s.trim());
                    let op = '=';
                    if(left.endsWith('+')) { op = '+='; left = left.slice(0,-1).trim(); }
                    if(left.endsWith('-')) { op = '-='; left = left.slice(0,-1).trim(); }
                    
                    let rightVal;
                    try {
                         const fnVal = new Function(...Object.keys(window.AdventureGlobalVars), `return ${right};`);
                         rightVal = fnVal(...Object.values(window.AdventureGlobalVars));
                    } catch(e) { rightVal = right; }

                    let currentVal = window.getGameVar(left) || 0;
                    
                    if (op === '=') window.setGameVar(left, rightVal);
                    if (op === '+=') window.setGameVar(left, currentVal + rightVal);
                    if (op === '-=') window.setGameVar(left, currentVal - rightVal);
                }
            });

        } catch (e) { console.error("Effect error", e); } 
    }

    function renderNode() {
        const container = document.getElementById(state.containerId);
        if (!container) return;

        const node = state.nodes.find(n => n.id === state.currentNodeId);
        if (!node) { 
            container.innerHTML = ""; 
            container.style.display = 'none'; 
            toggleActive(false); 
            return; 
        }

        const char = getCharacter(node.characterId);
        const textOpts = Array.isArray(node.textOptions) ? node.textOptions : [{ text: node.text || "", condition: "" }];
        let validTexts = textOpts.filter(t => evaluate(t.condition));
        if (validTexts.length === 0 && textOpts.length > 0) validTexts = [textOpts[0]]; 
        const chosenTextObj = validTexts.length > 0 ? validTexts[Math.floor(Math.random() * validTexts.length)] : { text: "..." };
        let finalText = interpolateText(chosenTextObj.text);

        let currentAvatarUrl = char.avatarUrl; 
        let nodeExpressionName = node.expression || node.Expression || node.characterExpression || node.CharacterExpression;
        
        const exprOpts = node.expressionOptions || node.ExpressionOptions;
        if (exprOpts && Array.isArray(exprOpts)) {
            const validExpr = exprOpts.find(e => evaluate(e.condition));
            if (validExpr && validExpr.expression && validExpr.expression.trim() !== "") {
                nodeExpressionName = validExpr.expression;
            }
        }

        const expressionName = chosenTextObj.expression || chosenTextObj.Expression || chosenTextObj.characterExpression || chosenTextObj.CharacterExpression || nodeExpressionName;

        if (expressionName && char.expressions && Array.isArray(char.expressions)) {
            const expressionObj = char.expressions.find(e => e.name.trim().toLowerCase() === expressionName.trim().toLowerCase());
            if (expressionObj && expressionObj.url) currentAvatarUrl = expressionObj.url;
        }

        let imageAlign = node.imageAlign || char.imageAlign || "left";
        imageAlign = imageAlign.toLowerCase();

        const portraitHtml = `
            <div class="adv-portrait" style="background-color: ${char.color}">
                ${currentAvatarUrl ? `<img src="${currentAvatarUrl}">` : `<span>${char.name[0]}</span>`}
            </div>`;
        
        const spacerHtml = `<div class="adv-portrait" style="visibility: hidden; border: 3px solid transparent; background: transparent;"></div>`;

        let leftColumn = (imageAlign === 'right') ? spacerHtml : portraitHtml;
        let rightColumn = (imageAlign === 'right') ? portraitHtml : spacerHtml;

        let html = `
        <div class="adv-dialogue-box" style="border-top-color: ${char.color}">
            ${leftColumn}
            <div class="adv-content">
                <h3 class="adv-name" style="color: ${char.color}">${char.name}</h3>
                <p class="adv-text">${finalText}</p>
                <div class="adv-options">`;

        const availableOptions = node.options.filter((opt, idx) => {
            const visitedKey = node.id + '_' + idx;
            if (opt.once && state.visited.has(visitedKey)) return false;
            if (opt.condition && !evaluate(opt.condition)) return false;
            return true;
        });

        if (availableOptions.length === 0 && node.options.length > 0) { 
            html += `<div class="adv-msg">(No hi ha opcions disponibles)</div>`; 
            html += `<button onclick="AdventureEngine.close()">Tancar</button>`;
        }
        else if (node.options.length === 0) { 
             html += `<button onclick="AdventureEngine.close()">Fi</button>`; 
        }
        else { 
            availableOptions.forEach((opt) => { 
                const idx = node.options.indexOf(opt); 
                html += `<button onclick="AdventureEngine.selectOption('${node.id}', ${idx})">${opt.text}</button>`; 
            }); 
        }
        html += `</div></div>${rightColumn}</div>`; 
        container.innerHTML = html;
        container.style.display = 'block';
    }

    function toggleActive(isActive) {
        if(isActive) document.documentElement.classList.add('adv-dialogue-active');
        else document.documentElement.classList.remove('adv-dialogue-active');
    }

    return {
        interpolateText: interpolateText,
        init: function(jsonData, containerId = 'dialogue-container') {
            try {
                const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
                const coreData = data.appState || data; 
                state.nodes = coreData.nodes || []; 
                state.characters = coreData.characters || []; 
                state.visited = new Set(); 
                state.containerId = containerId;
                
                const defaultVars = coreData.globalVariables || {};
                for (const key in defaultVars) {
                    if (window.getGameVar(key) === undefined) {
                        window.setGameVar(key, defaultVars[key]);
                    }
                }
                
                requestGlobalUpdate();

                let container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    document.body.appendChild(container);
                }
                container.style.display = 'block';
                if (window.jQuery) jQuery(container).show();
                if (state.nodes.length === 0) return;
                state.currentNodeId = state.nodes[0].id;
                toggleActive(true); 
                setTimeout(renderNode, 10);
            } catch (e) { console.error("AdventureEngine Init Error:", e); }
        },
        selectOption: function(nodeId, optionIndex) {
            const node = state.nodes.find(n => n.id === nodeId); const opt = node.options[optionIndex];
            if (opt.once) state.visited.add(nodeId + '_' + optionIndex);
            if (opt.effect) execute(opt.effect);
            
            let nextId = opt.targetNodeId;
            if (opt.altTargetNodeId && opt.targetCondition && evaluate(opt.targetCondition)) nextId = opt.altTargetNodeId;
            
            if (nextId) { 
                state.currentNodeId = nextId; 
                renderNode(); 
            } else { 
                this.close();
            }
        },
        close: function() {
            const container = document.getElementById(state.containerId); 
            if (container) {
                container.innerHTML = ""; 
                container.style.display = 'none';
                if (window.jQuery) jQuery(container).hide();
            }
            toggleActive(false); 
        }
    };
})();

// =================================================================
// GESTIÓ D'ESDEVENIMENTS (JQUERY)
// =================================================================

jQuery(document).ready(function () {

    function refreshScene() {
        if (jQuery('#inventory-container').length === 0) jQuery('body').append('<div id="inventory-container"></div>');
        if (jQuery('#cursor-label').length === 0) jQuery('body').append('<div id="cursor-label"></div>');
        requestGlobalUpdate();
    }
    
    refreshScene();
    
    // MODIFICACIÓ: Observer intel·ligent que ignora canvis d'UI (tooltips, inventari, cursor) I AUDIO
    const observer = new MutationObserver(function(mutations) { 
        let shouldRefresh = false;
        
        mutations.forEach(function(mutation) {
            // 1. Ignorar nodes d'Audio afegits pel sistema de so (Chapel o similar)
            if (mutation.addedNodes.length > 0) {
                let isAudio = false;
                for(let i=0; i<mutation.addedNodes.length; i++) {
                     const nodeName = mutation.addedNodes[i].nodeName.toUpperCase();
                     if (nodeName === 'AUDIO' || nodeName === 'SOURCE' || nodeName === 'W-AUDIO') {
                         isAudio = true;
                     }
                }
                if (isAudio) return; // Saltem aquesta mutació perquè és so
            }

            // 2. Comprovem si el canvi ve d'elements de la UI que no requereixen un "refresh" total
            // Si el target NO és (ni està dins de) l'inventari, el tooltip o el cursor, llavors sí refresquem.
            const target = jQuery(mutation.target);
            if (target.closest('#inventory-container, #twineImageInfoDisplay, #cursor-label, #dialogue-container').length === 0) {
                shouldRefresh = true;
            }
        });

        if (shouldRefresh) {
            refreshScene();
        }
    });

    const targetNode = document.querySelector('tw-story') || document.body;
    if (targetNode) observer.observe(targetNode, { childList: true, subtree: true, attributes: true });

    if (typeof State !== 'undefined' && State.variables) {
        if (State.variables.hotspotClicks === undefined) State.variables.hotspotClicks = {};
    }

    function evaluateCondition(conditionVarName, conditionVal) {
        if (!conditionVarName || conditionVal === undefined || conditionVal === null) return true; 

        const varName = conditionVarName.startsWith('$') ? conditionVarName.substring(1) : conditionVarName;
        const currentValue = window.getGameVar(varName); 
        
        let operatorUsed = '==';
        let valuePart = String(conditionVal).trim();
        const operators = ['===', '==', '!==', '!=', '>=', '<=', '>', '<'];
        for (const op of operators) {
            if (valuePart.startsWith(op)) {
                operatorUsed = op;
                valuePart = valuePart.substring(op.length).trim();
                break;
            }
        }
        let parsedVal = valuePart;
        if (valuePart === 'true') parsedVal = true;
        else if (valuePart === 'false') parsedVal = false;
        else if (!isNaN(Number(valuePart)) && valuePart !== '') parsedVal = Number(valuePart);
        
        try { return eval(`${JSON.stringify(currentValue)} ${operatorUsed} ${JSON.stringify(parsedVal)}`); } 
        catch (e) { return false; }
    }

    function activateCursorLabel(text, itemData, initialEvent) {
        const label = jQuery('#cursor-label');
        label.text(text).show();
        window.activeInventoryItem = itemData;

        const moveHandler = function(e) {
            label.css({ top: (e.clientY + 15) + 'px', left: (e.clientX + 15) + 'px' });
        };
        
        if (initialEvent) {
             label.css({ top: (initialEvent.clientY + 15) + 'px', left: (initialEvent.clientX + 15) + 'px' });
        }

        jQuery(document).off('mousemove.cursorLabel').on('mousemove.cursorLabel', moveHandler);
    }

    function clearCursorLabel() {
        jQuery('#cursor-label').hide();
        jQuery(document).off('mousemove.cursorLabel');
        window.activeInventoryItem = null;
    }

    jQuery(document).on('click', function(e) {
        if (!jQuery(e.target).closest('.hotspot-item, .inventory-item').length) {
            clearCursorLabel();
        }
    });

    function addToInventory(el) {
        let interactions = el.data('inventory-interactions');
        if (typeof interactions === 'string') {
            try { interactions = JSON.parse(interactions); } catch(e) { interactions = []; }
        }

        const item = {
            id: el.attr('alt'), 
            name: el.attr('alt'),
            image: el.attr('data-overlay-filename'),
            infoHover: el.attr('data-info-setter-inventori') || el.attr('data-info-inventori') || el.attr('text_fail_enter') || el.attr('data_info') || el.attr('title'),
            infoClick: el.attr('data-info-setter-2-inventori') || el.attr('data-info-2-inventori'),
            soundHover: el.attr('data-sound-setter-inventori') || el.attr('data-sound-inventori'),
            soundClick: el.attr('data-sound-click-setter-inventori') || el.attr('data-sound-click-inventori'),
            title: el.attr('data-title-text-setter-inventori') || el.attr('data-title-text-inventori'),
            interactions: interactions,
            var2: {
                name: el.data('variable-2-var') || el.attr('data-variable-2'),
                val: el.data('variable-2-val') || el.attr('data-valor-2'),
                op: el.data('variable-2-op')
            }
        };

        let currentInventory = window.getGameVar('inventory') || [];
        const exists = currentInventory.some(i => i.id === item.id);
        if (!exists) {
            currentInventory.push(item);
            window.setGameVar('inventory', currentInventory);
        }

        if (el.data('overlay-remove-from-scene') === true || el.data('overlay-remove-from-scene') === "true") {
            const id = el.attr('alt');
            let removed = window.getGameVar('removedItems') || {};
            removed[id] = true;
            window.setGameVar('removedItems', removed);
        }
    }

    function removeFromInventory(itemId) {
        let currentInventory = window.getGameVar('inventory') || [];
        const newInventory = currentInventory.filter(i => i.id !== itemId);
        window.setGameVar('inventory', newInventory);
    }

    function updateInventoryUI() {
        const container = jQuery('#inventory-container');
        const inventory = window.getGameVar('inventory') || [];
        
        // --- MODIFICAT: Separar la lògica de posició de la de renderitzat ---
        
        // 1. Calcular i aplicar posició (Sempre es fa per si canvia la mida de finestra)
        const wrapper = document.querySelector('.twine-image-wrapper');
        const mainImg = wrapper ? wrapper.querySelector('img[usemap]') : null;
        if (mainImg) {
            const imgRect = mainImg.getBoundingClientRect();
            container.css({
                'display': 'flex', 'flex-direction': 'column',
                'top': imgRect.top + 'px', 'left': (imgRect.right + 5) + 'px'
            });
        } else {
            container.css({ 'top': '10px', 'right': '10px', 'display': 'flex' });
        }
        
        if (inventory.length === 0) {
            container.hide();
            container.empty();
            window._lastInventoryState = "[]"; // Resetejar estat
            return;
        }
        container.show();

        // 2. Comprovació de "Caché": Si les dades són iguals que l'últim cop, NO recreem el DOM
        // Això evita que els listeners es perdin si un so o un altre event dispara un refresh
        const currentStateStr = JSON.stringify(inventory);
        if (window._lastInventoryState === currentStateStr && container.children().length > 0) {
            // No fem res més, els elements ja hi són i estan bé
            return;
        }

        // Si arribem aquí, vol dir que l'inventari ha canviat realment o és el primer cop
        window._lastInventoryState = currentStateStr;
        container.empty(); 

        inventory.forEach(item => {
            const itemDiv = jQuery('<div class="inventory-item"></div>');
            const iconWrapper = jQuery('<div class="inventory-icon-wrapper"></div>');
            if (item.image) iconWrapper.append(jQuery('<img>').addClass('inventory-icon-img').attr('src', item.image).attr('alt', item.name));
            else iconWrapper.text(item.name[0]); 
            itemDiv.append(iconWrapper);
            itemDiv.append(jQuery('<span class="inventory-name"></span>').text(item.name));

            itemDiv.on('mouseenter', function() {
                if (item.soundHover) playHotspotSound(item.soundHover);
                if (item.infoHover) toggleImageInfo(interpolateHotspotText(item.infoHover));
            });
            itemDiv.on('mouseleave', function() { toggleImageInfo(''); });
            itemDiv.on('click', function(e) {
                e.stopPropagation(); 
                if (item.soundClick) playHotspotSound(item.soundClick);
                if (item.infoClick) toggleImageInfo(interpolateHotspotText(item.infoClick));
                if (item.title) activateCursorLabel(interpolateHotspotText(item.title), item, e);
            });
            container.append(itemDiv);
        });
    }

    jQuery(document).on('adventure:state-update', updateInventoryUI);
    
    let resizeTimer;
    jQuery(window).on('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            updateInventoryUI();
            updateHotspotVisibility();
        }, 250);
    });

    function handleInventoryInteraction(hotspotEl) {
        if (!window.activeInventoryItem) return false;
        const item = window.activeInventoryItem;
        // NORMALITZACIÓ: Fem servir minúscules i trim per evitar errors de majúscules/espais
        const targetName = (hotspotEl.attr('alt') || '').trim(); 
        const targetNameLower = targetName.toLowerCase();
        
        // Helper per executar la interacció i evitar codi duplicat
        const executeInteraction = (interaction) => {
             if (interaction.text) toggleImageInfo(interpolateHotspotText(interaction.text));
             if (interaction.var1) window.updateGameVar(interaction.var1, interaction.op1, interaction.val1);
             if (interaction.var2) window.updateGameVar(interaction.var2, interaction.op2, interaction.val2);
                
             if (interaction.removeItem === true) {
                  removeFromInventory(item.id);
                  clearCursorLabel(); 
                  return true;
             }
             return true; 
        };

        // 1. Interaccions definides a l'OBJECTE (Item) - Lògica original
        if (item.interactions && Array.isArray(item.interactions)) {
            // Busquem coincidència insensible a majúscules/minúscules
            const interaction = item.interactions.find(i => 
                (i.targetHotspot || '').trim().toLowerCase() === targetNameLower
            );
            if (interaction) return executeInteraction(interaction);
        }
        
        // 2. Interaccions definides al HOTSPOT (Destí) - NOVA LÒGICA
        // Això permet definir l'acció en el hotspot actual, referenciant l'item necessari
        let hotspotInteractions = hotspotEl.data('inventory-interactions');
        if (typeof hotspotInteractions === 'string') {
            try { hotspotInteractions = JSON.parse(hotspotInteractions); } catch(e) { hotspotInteractions = []; }
        }

        if (hotspotInteractions && Array.isArray(hotspotInteractions)) {
            // Busquem una interacció que requereixi l'item actual (per requiredItem o item)
            // També normalitzem IDs per seguretat
            const interaction = hotspotInteractions.find(i => {
                const reqItem = (i.requiredItem || i.item || '').trim().toLowerCase();
                const itemId = (item.id || '').trim().toLowerCase();
                return reqItem === itemId;
            });
            if (interaction) return executeInteraction(interaction);
        }

        toggleImageInfo("Això no es pot fer");
        return true; 
    }

    function updateHotspotVisibility() {
        jQuery('.twine-image-wrapper img:not([usemap]):not(.hotspot-visual)').hide();
        const wrapper = document.querySelector('.twine-image-wrapper');
        const mainImg = wrapper ? wrapper.querySelector('img[usemap]') : null;
        if (!wrapper || !mainImg) return;

        // COMROVACIÓ EXTRA PER CÀRREGA D'IMATGE
        if (!mainImg.complete || mainImg.naturalWidth === 0 || mainImg.width === 0) {
            setTimeout(updateHotspotVisibility, 50);
            return;
        }

        const wrapperRect = wrapper.getBoundingClientRect();
        const imgRect = mainImg.getBoundingClientRect();
        const offsetX = imgRect.left - wrapperRect.left;
        const offsetY = imgRect.top - wrapperRect.top;

        let scaleX = 1, scaleY = 1;
        if (mainImg.naturalWidth > 0) {
            scaleX = imgRect.width / mainImg.naturalWidth;
            scaleY = imgRect.height / mainImg.naturalHeight;
        }

        jQuery('.hotspot-item').each(function() {
            const el = jQuery(this);
            const alt = el.attr('alt') || 'hotspot-' + Math.random().toString(36).substr(2, 9);
            const removed = window.getGameVar('removedItems') || {};
            if (removed[alt]) {
                el.hide();
                jQuery('#visual-' + alt.replace(/\s+/g, '-')).hide(); 
                return; 
            }
            
            const varName = el.data('overlay-condition-var');
            let val = el.data('overlay-condition-val');
            const op = el.data('overlay-condition-op');
            if (op && val !== undefined) val = op + String(val);
            
            const overlayFile = el.data('overlay-filename');
            const imgId = 'visual-' + alt.replace(/\s+/g, '-');

            let shouldShow = true;
            if (varName !== undefined) shouldShow = evaluateCondition(varName, val);

            if (shouldShow) {
                el.show();
                if (overlayFile) {
                    let img = document.getElementById(imgId);
                    if (!img) {
                        img = document.createElement('img');
                        img.id = imgId;
                        img.src = overlayFile;
                        img.className = 'hotspot-visual';
                        jQuery('.twine-image-wrapper').append(img);
                    }
                    const coords = el.attr('coords').split(',').map(Number);
                    if (coords.length === 4) {
                        const [x1, y1, x2, y2] = coords;
                        img.style.left = (x1 * scaleX + offsetX) + 'px';
                        img.style.top = (y1 * scaleY + offsetY) + 'px';
                        img.style.width = ((x2 - x1) * scaleX) + 'px';
                        img.style.height = ((y2 - y1) * scaleY) + 'px';
                    }
                    // MODIFICAT: show() directe
                    jQuery(img).show(); 
                }
            } else {
                el.hide();
                const img = document.getElementById(imgId);
                if (img) jQuery(img).hide();
            }
        });
    }

    jQuery(document).on('adventure:state-update', updateHotspotVisibility);
    
    function interpolateHotspotText(text) {
        if (!text) return "";
        return text.replace(/\$(\w+)/g, function(_, varName) {
            const val = window.getGameVar(varName);
            return (val !== undefined && val !== null) ? val : '';
        });
    }

    function playHotspotSound(soundId) {
        if (!soundId) return;
        const idStr = String(soundId).trim();
        if (!idStr) return;
        if (typeof Chapel !== 'undefined' && Chapel.Audio && Chapel.Audio.track) {
            try { const t = Chapel.Audio.track(idStr); if(t) { t.stop(); t.playWhenPossible(); } } catch(e){}
        }
    }

    function stopHotspotSound(soundId) {
        if (!soundId) return;
        const idStr = String(soundId).trim();
        if (typeof Chapel !== 'undefined' && Chapel.Audio && Chapel.Audio.track) {
            try { const t = Chapel.Audio.track(idStr); if(t) t.stop(); } catch(e){}
        }
    }

    function toggleImageInfo(text) {
        const finalText = interpolateHotspotText(text);
        if (typeof State !== 'undefined' && State.variables) State.variables.tempInfoDisplay = finalText;
        const container = document.getElementById('twineImageInfoDisplay');
        if (container) {
            if (!finalText) { jQuery(container).hide(); }
            else {
                container.innerHTML = finalText;
                jQuery(container).show();
            }
        }
    }

    function executeHotspotSetters(hotspotElement) {
        const el = jQuery(hotspotElement);
        let combinedSetterStatements = el.attr('data-setter') || '';

        if (!combinedSetterStatements) {
            const var1 = el.attr('data-variable') || el.attr('data_variable');
            const val1 = el.attr('data-valor') || el.attr('data_valor');
            if (var1 && val1) combinedSetterStatements = `${var1} ${val1}`;
        }
        
        const v2_name = el.attr('data-variable-2-var') || el.attr('data-variable-2');
        const v2_val = el.attr('data-variable-2-val') || el.attr('data-valor-2');
        if (v2_name && v2_val) {
            const op = el.attr('data-variable-2-op') || 'to';
            combinedSetterStatements += `; ${v2_name} ${op} ${v2_val}`;
        }

        if (!combinedSetterStatements) return;

        const statements = combinedSetterStatements.split(';');
        statements.forEach(stmt => {
            const trimmedStmt = stmt.trim();
            if (!trimmedStmt) return;
            const match = trimmedStmt.match(/^\s*(\$?\w+)\s*(=|\+=|-=|\*=|\/=|to)\s*(.*)\s*$/);
            if (!match) return;

            const varName = match[1].startsWith('$') ? match[1].substring(1) : match[1];
            const operator = match[2];
            let valueStr = match[3];

            let value;
            if (!isNaN(Number(valueStr))) value = Number(valueStr);
            else if (valueStr === 'true') value = true;
            else if (valueStr === 'false') value = false;
            else if (valueStr.startsWith('$')) {
                const targetVarName = valueStr.substring(1);
                value = window.getGameVar(targetVarName);
            } else value = valueStr.replace(/^['"]|['"]$/g, '');

            let currentVal = window.getGameVar(varName);
            if (currentVal === undefined) currentVal = (typeof value === 'number') ? 0 : "";

            switch (operator) {
                case '=': 
                case 'to': window.setGameVar(varName, value); break;
                case '+=': window.setGameVar(varName, currentVal + value); break;
                case '-=': window.setGameVar(varName, currentVal - value); break;
                case '*=': window.setGameVar(varName, currentVal * value); break;
                case '/=': if (value !== 0) window.setGameVar(varName, currentVal / value); break;
            }
        });
    }

    jQuery(document).on('mouseenter', '.hotspot-item', function () { 
        if (!jQuery(this).is(':visible')) return; 
        const el = jQuery(this);

        if (window.activeInventoryItem) {
            const itemName = window.activeInventoryItem.title || window.activeInventoryItem.name;
            const hotspotName = el.attr('alt'); 
            const text = "Usar " + interpolateHotspotText(itemName) + " amb " + interpolateHotspotText(hotspotName);
            toggleImageInfo(text);
            return; 
        }

        const limit = parseInt(el.data('visit-limit'));
        const id = el.attr('alt');
        
        if (!isNaN(limit) && window.getGameVar('hotspotClicks') && window.getGameVar('hotspotClicks')[id] >= limit) {
            toggleImageInfo(el.attr('data-visit-limit-enter'));
            playHotspotSound(el.data('sound-fail'));
            return;
        }

        let val = el.data('condition-val');
        const op = el.data('condition-op');
        if (op && val !== undefined) val = op + String(val);

        if (evaluateCondition(el.data('condition-var'), val)) {
            toggleImageInfo(el.attr('data_info'));
            playHotspotSound(el.data('sound'));
        } else {
            toggleImageInfo(el.attr('text_fail_enter'));
            playHotspotSound(el.data('sound-fail'));
        }
    });

    jQuery(document).on('mouseleave', '.hotspot-item', function () { 
        toggleImageInfo('');
        stopHotspotSound(jQuery(this).data('sound'));
        stopHotspotSound(jQuery(this).data('sound-fail'));
    });

    jQuery(document).on('click', 'area.hotspot-item[data-action="dialog"]', function (e) {
        e.preventDefault(); 
        if (!jQuery(this).is(':visible')) return; 
        const el = jQuery(this);

        if (handleInventoryInteraction(el)) return;

        const id = el.attr('alt');
        const limit = parseInt(el.data('visit-limit'));
        let clicks = window.getGameVar('hotspotClicks') || {};

        if (!isNaN(limit) && clicks[id] >= limit) {
            toggleImageInfo(el.attr('data-visit-limit-clic'));
            playHotspotSound(el.data('sound-click-fail'));
            return;
        }

        let val = el.data('condition-val');
        const op = el.data('condition-op');
        if (op && val !== undefined) val = op + String(val);

        if (!evaluateCondition(el.data('condition-var'), val)) {
            toggleImageInfo(el.attr('text_fail_clic'));
            playHotspotSound(el.data('sound-click-fail'));
            return;
        }

        if (el.data('overlay-inventoriable') === true || el.data('overlay-inventoriable') === "true") {
            addToInventory(el);
        }

        executeHotspotSetters(this);
        if (!isNaN(limit)) {
            clicks[id] = (clicks[id] || 0) + 1;
            window.setGameVar('hotspotClicks', clicks);
        }

        playHotspotSound(el.data('sound-click'));
        
        const info2 = el.attr('data_info_2');
        if (info2) toggleImageInfo(info2);
        else toggleImageInfo(el.attr('data_info'));

        if (el.data('action') === 'dialog') {
            let targetId = el.data('target') || el.data('dialog-id') || el.data('character');
            if (targetId) {
                let scriptEl = document.getElementById(targetId) || document.getElementById('dialogue-data-' + targetId);
                if (scriptEl && scriptEl.innerHTML) {
                    if (window.AdventureEngine) window.AdventureEngine.init(scriptEl.innerHTML);
                }
            }
        }
    });

    jQuery(document).on('click', 'area.hotspot-item[data-passage]', function (e) {
        e.preventDefault();
        if (!jQuery(this).is(':visible')) return; 
        const el = jQuery(this);

        if (handleInventoryInteraction(el)) return;
        
        const passage = el.data('passage');
        let val = el.data('condition-val');
        const op = el.data('condition-op');
        if (op && val !== undefined) val = op + String(val);

        if (evaluateCondition(el.data('condition-var'), val)) {
            if (el.data('overlay-inventoriable') === true || el.data('overlay-inventoriable') === "true") {
                addToInventory(el);
            }

            executeHotspotSetters(this);
            playHotspotSound(el.data('sound-click'));
            
            const info2 = el.attr('data_info_2');
            if (info2) toggleImageInfo(info2);
            else toggleImageInfo(el.attr('data_info'));
            
            const link = jQuery("tw-link").filter((i,e) => jQuery(e).text().trim().toLowerCase() === passage.trim().toLowerCase());
            if (link.length) link.click();
        } else {
            toggleImageInfo(el.attr('text_fail_clic'));
            playHotspotSound(el.data('sound-click-fail'));
        }
    });
    
    jQuery(document).on('click', 'area.hotspot-item[data-setter]:not([data-passage]):not([data-action="dialog"])', function (e) {
        e.preventDefault();
        if (!jQuery(this).is(':visible')) return; 
        const el = jQuery(this);

        if (handleInventoryInteraction(el)) return;

        const id = el.attr('alt');
        const limit = parseInt(el.data('visit-limit'));

        let clicks = window.getGameVar('hotspotClicks') || {};
        if (!window.getGameVar('hotspotClicks')) window.setGameVar('hotspotClicks', clicks);

        if (!isNaN(limit) && clicks[id] >= limit) {
             toggleImageInfo(el.attr('data-visit-limit-clic'));
             playHotspotSound(el.data('sound-click-fail'));
             return;
        }

        let val = el.data('condition-val');
        const op = el.data('condition-op');
        if (op && val !== undefined) val = op + String(val);

        if (evaluateCondition(el.data('condition-var'), val)) {
            if (el.data('overlay-inventoriable') === true || el.data('overlay-inventoriable') === "true") {
                addToInventory(el);
            }

            executeHotspotSetters(this);
            if (!isNaN(limit)) {
                clicks[id] = (clicks[id] || 0) + 1;
                window.setGameVar('hotspotClicks', clicks);
            }
            
            playHotspotSound(el.data('sound-click'));
            
            const info2 = el.attr('data_info_2');
            toggleImageInfo(info2 ? info2 : el.attr('data_info'));
        } else {
            toggleImageInfo(el.attr('text_fail_clic'));
            playHotspotSound(el.data('sound-click-fail'));
        }
    });

    // Initialization
    requestGlobalUpdate();
    // Extra updates to catch lazy loading images
    setTimeout(requestGlobalUpdate, 100);
    setTimeout(requestGlobalUpdate, 500);
    setTimeout(requestGlobalUpdate, 1000);
});






/**
 * Harlowe Audio Library (HAL), by Chapel, v2.3.0
 * for Harlowe 2.1.0 and higher
 * Released under the Unlicense, and dedicated to the public domain.
**/
;!function(e){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera),function(){"use strict";window.Fast={filter:function(e,t){for(var o=e.length,n=[],a=0;a<o;a++)t(e[a],a,e)&&n.push(e[a]);return n},forEach:function(e,t){for(var o=e.length,n=0;n<o;n++)t(e[n],n,e)},map:function(e,t){for(var o=e.length,n=new Array(o),a=0;a<o;a++)n[a]=t(e[a],a,e);return n},find:function(e,t){for(var o=e.length,n=0;n<o;n++)if(t(e[n],n,e))return e[n]},findIndex:function(e,t){for(var o=e.length,n=0;n<o;n++)if(t(e[n],n,e))return n;return-1},some:function(e,t){for(var o=e.length,n=0;n<o;n++)if(t(e[n],n,e))return!0;return!1}}}(),window.Chapel=window.Chapel||{},window.Chapel.options={preload:!0,loadDelay:0,muteOnBlur:!0,startingVol:.5,persistPrefs:!0,globalA:!0,showControls:!0,sidebarStartClosed:!0,volumeDisplay:!1,trackLoadLimit:500,totalLoadLimit:8e3,debug:!1},window.Chapel.debug=function(){Chapel.options.debug&&console.log.apply(null,arguments)},function(){"use strict";var n=$("tw-storydata"),o=/(.+?):(.+)/,t=/[\r\n]+/,a=/^["']/,r=/["']$/;function e(e){return Fast.map(Fast.filter(e.split(t),function(e){return e&&e.trim()&&e.includes(":")}),function(e){return e.trim()})}function i(e){return e.trim().replace(a,"").replace(r,"").trim()}function s(e){var t=e.match(o);return t instanceof Array?{key:i(t[1]),value:i(t[2])}:e}var u,l,c,p=n.find('tw-passagedata[name="hal.tracks"]'),d=null,p=(p.length&&(p=e(p.text()),u=[],l=[],Fast.forEach(p,function(e){var e=s(e);"string"==typeof e&&l.push(e),u.push([e.key,(e=e.value,Fast.map(e.split(","),i))])}),l.length&&console.error("Some track definitions could not be parsed:\n"+l.join("\n")+"\nPlease check these definitions and try again."),d=new Map(u)),n.find('tw-passagedata[name="hal.config"]')),m=null;function f(e){var t=n.attr("format-version");if(e)return t;var e=t.split("."),t=e[0],o=e[1],e=e[2],t=Number(t),o=Number(o);return[t=(t=Number.isNaN(t)?3:t)<1?3:t,o=Number.isNaN(o)?3:o,e=Number.isNaN(e)?0:e]}function h(){var e=f();return!(3<=e[0]&&3<=e[1])}function g(t){return function(){var e=[].slice.call(arguments).slice(1),e=t.apply(null,e);return"string"==typeof e||"boolean"==typeof e||"number"==typeof e?e:""}}p.length&&(p=e(p.text()),c={},Fast.forEach(Fast.map(p,function(e){return s(e)}),function(e){c[e.key]=e.value}),m=c),m&&Fast.forEach(Object.keys(m),function(e){var t=e,o=c[e],e=typeof Chapel.options[e];"boolean"==e?"true"===o?Chapel.options[t]=!0:"false"===o&&(Chapel.options[t]=!1):"number"==e?(o=Number(o),Number.isNaN(o)||(Chapel.options[t]=o)):"string"==e&&o&&(Chapel.options[t]=o)});var y=require("macros");if(window.Chapel=window.Chapel||{},window.Chapel.Macros={add:function(o){o&&"object"==typeof o&&Fast.forEach(Object.keys(o),function(e){var t;t=o[e=e],h()?y.add(e,g(t),y.TypeSignature.zeroOrMore(y.TypeSignature.Any)):y.add(e,"Any",g(t),y.TypeSignature.zeroOrMore(y.TypeSignature.Any))})}},window.Chapel.Get=Object.freeze({version:f(),isHarlowe3OrLater:3<=f()[0],storyTitle:n.attr("name"),IFID:n.attr("ifid"),useOldMacroAPI:h(),fromPassage:d}),Chapel.debug("Harlowe Version -> ",Chapel.Get.version.join(".")),Chapel.debug("Harlowe Major Version -> ",Chapel.Get.version[0]),Chapel.debug("Story Title -> ",Chapel.Get.storyTitle),Chapel.debug("Story IFID -> ",Chapel.Get.IFID),Chapel.Get.version[0]<2)throw new Error("The Harlowe Audio Library is only designed to work with Harlowe 2 and 3; you appear to be using Harlowe 1 or an otherwise invalid story format.","get.js -> initialization",176);Chapel.options.storagekey="%%hal-"+Chapel.Get.IFID+"-{"+Chapel.Get.storyTitle+"}",Chapel.debug("Storage Key -> ",Chapel.options.storagekey)}(),function(){"use strict";var t=Chapel.options,e=function(e,t){if(window.localStorage)try{e=""+e,"string"!=typeof t&&(t=JSON.stringify(t)),window.localStorage.setItem(e,t)}catch(e){console.error(e)}},o=function(e){if(window.localStorage)try{return e=""+e,window.localStorage.getItem(e)}catch(e){console.error(e)}},n=function(e){if(window.localStorage)try{e=""+e,window.localStorage.removeItem(e)}catch(e){console.error(e)}},a={loaded:[],classes:{},master:{volume:t.startingVol,mute:!1},groups:{playing:[],looping:[],custom:{}},mute:function(e){a.master.mute=!!e,$(document).trigger({type:":master-mute",mute:!!e})},isMuted:function(){return!!a.master.mute},volume:function(e){e=Number(e),Number.isNaN(e)||(1<e?e=1:e<0&&(e=0),a.master.volume=e),$(document).trigger({type:":master-volume",volume:e})},getVolume:function(){return a.master.volume},stopAll:function(){a.classes.Track&&Fast.forEach(a.classes.Track.list,function(e){e.stop()})},audioPlaying:function(){return!!a.groups.playing.length},savePrefs:function(){e(t.storagekey,a.master)},loadPrefs:function(){var e=o(t.storagekey);e&&"object"==typeof e&&e.hasOwnProperty("volume")&&"number"==typeof e.volume&&e.hasOwnProperty("mute")&&"boolean"==typeof e.volume&&(delete a.master,a.master=e)},clearPrefs:function(){n(t.storagekey)}},r={track:[":available",":loaded",":play",":stop",":mute",":volume"],master:[":master-mute",":master-volume"]};var i=r.track.concat(r.master);function s(e,t){if(!e||"string"!=typeof e||!e.trim())return null;e=Fast.filter(Fast.map(e.split(" "),function(e){return(e=":"!==(e=e.split(".")[0])[0]?":"+e:e)+".userland"}),function(e){return(t?i:r.track).includes(e)}).join(" ");return e&&e.trim()?e:null}a.data={parseEvent:s,bail:function(e){throw new Error(e,"audio.js -> bail()",140)}},a.on=function(e,t){t&&"function"==typeof t?(e=s(e,!0))&&$(document).on(e,t):console.error("Chapel.Audio.on() -> invalid callback")},a.one=function(e,t){t&&"function"==typeof t?(e=s(e,!0))&&$(document).one(e,t):console.error("Chapel.Audio.one() -> invalid callback")},a.off=function(e){(e=s(e,!0))&&$(document).off(e)},t.persistPrefs&&($(document).on(":master-mute",a.savePrefs),$(document).on(":master-volume",a.savePrefs)),$(document).on(":play",function(e){e.track.addToGroup("playing")}),$(document).on(":stop",function(e){e.track.removeFromGroup("playing")}),t.muteOnBlur&&$(window).on("blur",function(){a.isMuted()||(a.mute(!0),$(window).one("focus",function(){a.mute(!1)}))}),a.parseEvent=s,window.Chapel=window.Chapel||{},window.Chapel.Audio=a}(),function(){"use strict";var a=Chapel.Audio,o=a.data.pareEvent,r=a.data.bail,i=Chapel.options,t=$(document.createElement("div")).attr("id","audio-container").css("display","none").appendTo(document.body),s={aac:"audio/aac",caf:"audio/x-caf","x-caf":"audio/x-caf",mp3:'audio/mpeg; codecs="mp3"',mpeg:'audio/mpeg; codecs="mp3"',m4a:"audio/mp4",mp4:"audio/mp4","x-m4a":"audio/mp4","x-mp4":"audio/mp4",oga:"audio/ogg",ogg:"audio/ogg",opus:'audio/ogg; codecs="opus"',wav:"audio/wav",wave:"audio/wav",weba:"audio/webm",webm:"audio/webm"};function u(e,t,o){this instanceof u||r("Track: called without `new` operator"),e||r("Track: no id specified"),"string"!=typeof e&&r("Track: track id is not a string"),t&&(!Array.isArray(t)||t.length)||r("Track: no sources specified"),o?t=[].slice.call(arguments).slice(1):"string"==typeof t&&(t=[t]);var n=$(document.createElement("audio"));Fast.forEach(t,function(e){$(document.createElement("source")).attr({src:e,type:(e=(e=(e=(e=(e=e).split("."))[e.length-1]).includes("?")?e.split("?")[0]:e).toLowerCase().trim(),Object.keys(s).includes(e)||r('Track: unsupported file type "'+e+'"'),s[e])}).appendTo(n)}),n.attr({"data-track":"id","data-volume":1,"data-mute":!1}).one("canplaythrough.hal",function(){a.loaded.push(e)}),i.preload&&n.attr("preload","auto"),n[0].volume=+a.master.volume,this.id=e,this.$el=n,this.unwrap=n[0],this.sources=t}Object.assign(u,{list:[],is:function(e){return e instanceof u},has:function(t){return Fast.some(u.list,function(e){return e.id===t})},emit:function(e,t){$(document).trigger({type:e,track:t}),t.emit(e)},add:function(e,t,o){var n=new u(e,t=o?[].slice.call(arguments).slice(1):t);return u.list.push(n),n.$el.on("canplay",function(){u.emit(":available",n)}),n.$el.on("canplaythrough",function(){u.emit(":loaded",n)}),n.attach(),n},renew:function(){Fast.forEach(u.list,function(e){e.mute(e.isMuted()),e.volume(e.getVolume())})},getIdx:function(t){return Fast.findIndex(u.list,function(e){return e.id===t})},get:function(t){var e=Fast.find(u.list,function(e){return e.id===t});if(e)return e;throw new ReferenceError('There is no track with the id "'+t+'". Please check your spelling and capitalization.',"track.js -> Track.get()",155)},removeFromDOM:function(e){(e="string"==typeof e?u.get(e):e)&&u.is(e)?e.unattach():t.remove()},_runOnMultiple:function(e,t,o){e instanceof Array&&u.prototype.hasOwnProperty(t)&&Fast.forEach(e,function(e){(e=u.is(e)?e:u.get(e)||null)&&e[t].apply(e,o&&o instanceof Array?o:[])})}}),Object.assign(u.prototype,{constructor:u,emit:function(e){this.$el.trigger({type:e,track:this})},clone:function(){return new u(this.id,this.sources)},isAttached:function(){return $.contains(t[0],this.unwrap)},attach:function(){return this.isAttached()||this.$el.appendTo(t),this},unattach:function(){return this.isAttached()&&this.$el.remove(),this},isPlaying:function(){return!this.unwrap.paused},play:function(){var e=this;return this.unwrap.play(),u.emit(":play",this),this.$el.on("ended",function(){e.unwrap.loop||(e.unwrap.currentTime=0,u.emit(":stop",e))}),this},playWhenPossible:function(){var t=this;return this.unwrap.play().then(function(){u.emit(":play",t),t.$el.on("ended",function(){t.unwrap.loop||(t.unwrap.currentTime=0,u.emit(":stop",t))})},function(e){$(document).one("click mousedown keydown touchstart",function(){t.play()})}).catch(function(e){console.error(e)}),this},forcePlay:function(){var e=this,t=$(document.createElement("a")).css("display","none").appendTo(document.body).on("click",function(){e.play()});setTimeout(function(){t.trigger("click")},safeAudioStart)},pause:function(){return this.unwrap.pause(),u.emit(":pause",this),this},stop:function(){return this.unwrap.pause(),this.unwrap.currentTime=0,u.emit(":stop",this),this},mute:function(e){return this.$el.attr("data-mute",e=!!e),a.master.mute?this.unwrap.muted=!0:this.unwrap.muted=e,u.emit(":mute",this),this},isMuted:function(){var e=this.$el.attr("data-mute");return"boolean"==typeof e?e:"false"!==e},toggleMute:function(){return this.mute(!this.isMuted()),this},volume:function(e){return e=Number(e),Number.isNaN(e)||(1<e?e=1:e<0&&(e=0),this.$el.attr("data-volume",e),this.unwrap.volume=e*a.master.volume),u.emit(":volume",this),this},getVolume:function(){return Number(this.$el.attr("data-volume"))},addToGroup:function(e,t){var o=this,t=(t?a.groups.custom:a.groups)[e];return Fast.some(t,function(e){return o.id===e.id})||t.push(this),this},removeFromGroup:function(e,t){var o=this,t=(t?a.groups.custom:a.groups)[e],e=Fast.findIndex(t,function(e){return e.id&&e.id===o.id});return t.splice(e,1),this},loop:function(e){return this.unwrap.loop=!!e,this.unwrap.loop?this.addToGroup("looping"):this.removeFromGroup("looping"),this},isLooping:function(){return!!this.unwrap.loop},toggleLoop:function(){return this.loop(!this.isLooping()),this},seek:function(e){return e<0?e=this.unwrap.duration-e:e>this.unwrap.duration&&(e=this.unwrap.duration),this.unwrap.currentTime=e,this},fadeIn:function(e){var t=this,o=(e=e||1,this.getVolume());return this.volume(0),this.play(),this.$el.animate({volume:o*a.master.volume},1e3*e,function(){t.volume(o),u.emit(":volume",t),u.emit(":fade",t)}),this},fadeOut:function(e){e=e||1;var t=this,o=this.getVolume();return this.$el.animate({volume:0},1e3*e,function(){t.stop(),t.volume(o),u.emit(":volume",t),u.emit(":fade",t)}),this},fadeTo:function(e,t){var o=this;if(e=e||1,t=Number(t),!Number.isNaN(t))return 1<t?t=1:t<0&&(t=0),this.$el.animate({volume:t*a.master.volume},1e3*e,function(){o.volume(t),u.emit(":volume",o),u.emit(":fade",o)}),this;alert("ivalid volume level")},delay:function(e,t){var o=this;"function"==typeof t&&(e=Number(e),(Number.isNaN(e)||e<0)&&(e=0),setTimeout(function(){t.call(o,o,e)},e))},on:function(e,t){if(!t||"function"!=typeof t)return console.error("<track>.on() -> invalid callback"),this;(e=o(e))&&this.$el.on(e,t)},one:function(e,t){if(!t||"function"!=typeof t)return console.error("<track>.one() -> invalid callback"),this;(e=o(e))&&this.$el.one(e,t)},off:function(e){(e=o(e))&&this.$el.off(e)}}),a.classes.Track=u,a.newTrack=function(){try{return u.add.apply(null,arguments)}catch(e){console.error(e.message),alert("Error in A.newTrack() -> see the console for more information.")}},a.track=function(e){try{return u.get(e)}catch(e){console.error(e.message),alert("Error in A.track() -> see the console for more information.")}},$(document).on(":master-mute",u.renew),$(document).on(":master-volume",u.renew)}(),function(){"use strict";var n=Chapel.Audio,a=n.classes.Track,o=(n.data._extend,/(play)?list:(.+)/i);n.createGroup=function(e,t,o){o=o?[].slice.call(arguments).slice(1):t;t=e,(e=o)&&Array.isArray(e)||(e=[]),n.groups.custom[t]=Fast.map(e,function(e){return a.get(e)})},n.group=function(e){if(!(this instanceof n.group))return new n.group(e);if(Object.keys(n.groups.custom).includes(e))this.members=n.groups.custom[e];else{if(!(n.groups[e]&&n.groups[e]instanceof Array))throw new ReferenceError('There is no group with the id "'+id+'". Please check your spelling and capitalization.',"group.js -> A.group()",29);this.members=n.groups[e]}var t;o.test(e)&&(t=e.match(o)[2])&&t.trim()&&(this.members=n.playlist(t).tracks),Array.isArray(this.members)||(this.members=[],console.error('Could not find members for track group "'+e+'"!'))},Object.assign(n.group,{is:function(e){return this instanceof n.group},_runOnAll:function(e,t,o,n){null!=n?o=[].slice.call(arguments).slice(2):o instanceof Array||(o=[o]);n=[e.members,t,o];a._runOnMultiple.apply(null,n)}}),Object.assign(n.group.prototype,{constructor:n.group,_run:function(){n.group._runOnAll.apply(null,[this].concat([].slice.call(arguments)))},play:function(){return this._run("play"),this},pause:function(){return this._run("pause"),this},stop:function(){return this._run("stop"),this},mute:function(e){return this._run("mute",e),this},volume:function(e){return this._run("volume",e),this},loop:function(e){return this._run("loop",e),this}})}(),function(){"use strict";var e=Chapel.Audio,a=e.classes.Track;e.data._extend;function n(e,t){if(!(this instanceof n))return new n(e,t);this.id=e,this.tracks=t.map(function(e){return a.get(e)}),this.looping=!1,this.current="",this.playing=!1}Object.assign(n,{list:{},is:function(e){return e instanceof n},add:function(e,t,o){return o&&(t=[].slice.call(arguments).slice(1)),n.list[e]=new n(e,t),n.list[e]},_runOnAll:function(e,t,o,n){null!=n?o=[].slice.call(arguments).slice(2):o instanceof Array||(o=[o]);n=[e.tracks,t,o];a._runOnMultiple.apply(null,n)}}),Object.assign(n.prototype,{constructor:n,clone:function(){return new n(this.id,this.tracks.map(function(e){return e.id}))},_run:function(){n._runOnAll.apply(null,[this].concat([].slice.call(arguments)))},volume:function(e){return this._run("volume",e),this},mute:function(e){return this._run("mute",e),this},shuffle:function(){for(var e,t,o=this.tracks,n=o.length-1;0<n;n--)e=Math.floor(Math.random()*(n+1)),t=o[n],o[n]=o[e],o[e]=t;return this.tracks=o,this},random:function(){return this.tracks[Math.floor(Math.random()*this.tracks.length)]},isPlaying:function(){return this.playing},nowPlaying:function(){return a.get(this.current)},play:function(e){var t=this;if((e=e||(t.current?Fast.findIndex(t.tracks,function(e){return e.id===t.current}):0))>=t.tracks.length&&t.looping)e=0;else if(e>=t.tracks.length)return t.current="",void(t.playing=!1);var o=t.tracks[e],n=o.isLooping();return o.loop(!1),o.play(),t.playing=!0,setTimeout(function(){o.isPlaying()||(t.playing=!1)},20),t.current=o.id,o.$el.one("ended.playlist",function(){e++,o.loop(n),t.play(e)}),t},loop:function(e){return this.looping=!!e,this},isLooping:function(){return this.looping},stop:function(){var e;return this.current&&this.isPlaying()?(e=this.nowPlaying())&&(e.stop(),e.$el.off(".playlist")):this._run("stop"),this.current="",this.playing=!1,this},pause:function(){var e;return this.current&&this.isPlaying()&&((e=this.nowPlaying())&&e.pause()),this.playing=!1,this}}),e.classes.Playlist=n,e.createPlaylist=function(){try{n.add.apply(null,arguments)}catch(e){console.error(e.message),alert("Error in A.createPlaylist() -> see the console for more information.")}},e.playlist=function(e){try{var t=n.list[e]||null;if(t)return t;throw new ReferenceError('There is no playlist with the id "'+e+'". Please check your spelling and capitalization.',"list.js -> A.playlist()",171)}catch(e){console.error(e.message),alert("Error in A.createPlaylist() -> see the console for more information.")}}}(),function(){"use strict";var t=Chapel.Audio,o=t.classes.Track,n=t.classes.Playlist;function a(t,o){if("object"!=typeof o)throw new TypeError("Invalid extension.","extensions.js -> _extend()",8);Fast.forEach(Object.keys(o),function(e){if(void 0!==t[e])throw new Error('Invalid extension: cannot clobber existing property "'+e+'".',"extensions.js -> _extend()",8);t[e]=o[e]})}t.extend=function(e){a(Audio,e)},o.extend=function(e){a(o,e)},o.extendPrototype=function(e){a(o.prototype,e)},t.extendTrack=o.extend,t.extendTrackProto=o.extendPrototype,t.group.extend=function(e){a(t.group,e)},t.group.extendPrototype=function(e){a(t.group.prototype,e)},t.extendGroup=t.group.extend,t.extendGroupProto=t.group.extendPrototype,n.extend=function(e){a(n,e)},n.extendPrototype=function(e){a(n.prototype,e)},t.extendPlaylist=n.extend,t.extendPlaylistProto=n.extendPrototype}(),function(){"use strict";var e,t,o,n,a,r,i,s=Chapel.options;s.showControls&&(e=$(document.createElement("div")).attr("id","story-menu").css("display","none"),t=$(document.createElement("span")).attr("id","vol-title").append("Volume"),s.volumeDisplay||t.css("display","none"),o=$(document.createElement("input")).attr({id:"audio-volume",type:"range",min:1,max:99,step:1,title:"Volume"}).addClass("hal"),(a=Math.trunc(100*window.Chapel.Audio.master.volume))<0?a=0:100<a&&(a=100),o.attr("value",a),n=function(e){void 0===e&&(e=o.val()),t.empty().append("Volume "+e)},o.on("input",function(){window.Chapel.Audio.volume($(this).val()/100),n($(this).val())}),a=$(document.createElement("tw-link")).attr({id:"audio-mute",title:"Mute"}).append("Mute <span></span>").on("click",function(e){e.preventDefault(),$(this).toggleClass("muted"),Chapel.Audio.mute(!Chapel.Audio.isMuted())}),Chapel.Audio.isMuted()&&a.addClass("muted"),r=$(document.createElement("tw-link")).attr("id","audio-panel-toggle").on("click",function(e){e.preventDefault(),i.toggleClass("closed")}),i=$(document.createElement("div")).attr("id","audio-controls").append(e,t,o,a,r).appendTo(document.body),s.sidebarStartClosed&&i.addClass("closed"),window.Chapel=window.Chapel||{},window.Chapel.Audio=window.Chapel.Audio||{},window.Chapel.Audio.controls={$panel:i,$volume:o,$mute:a,$user:e,close:function(){i.addClass("closed")},open:function(){i.removeClass("closed")},toggle:function(){i.toggleClass("closed")},hide:function(){i.css("display","none")},show:function(){i.css("display","block")},updateVolume:n})}(),function(){"use strict";var s=Chapel.options,t=State,e=$(document.createElement("div")).attr("id","audio-overlay").css("display","none").appendTo(document.body);function o(){e.css("display","block").append('<div class="lds-ring"><div></div><div></div><div></div><div></div></div>')}function u(){e.fadeOut(function(){e.empty()})}window.Chapel=window.Chapel||{},window.Chapel.Audio=window.Chapel.Audio||{},window.Chapel.Audio.loadScreen={show:o,dismiss:u,kill:function(){$("#audio-overlay").remove()}},window.Chapel.Audio.$overlay=e,window.Chapel.Audio.preload=function(){var a,e,r,i;Chapel.debug("This is a mobile browser -> ",$.browser.mobile),t.pastLength||t.futureLength||$.browser.mobile||($(document).ready(function(){o()}),a=100+s.loadDelay,e=Chapel.Audio.classes.Track.list,r=Chapel.Audio.loaded,e.length?(i=Fast.map(e,function(e){return e.id}),0<s.totalLoadLimit&&setTimeout(function(){u()},s.totalLoadLimit),function e(){var t,o,n;i.length?(t=i.shift(),r.includes(t)?e():(o=Chapel.Audio.classes.Track.get(t)).unwrap.readyState<2?(n=!1,o.$el.one("canplaythrough.hal",function(){e(),n=!0}),setTimeout(function(){n||(o.$el.off("canplaythrough.hal"),e())},s.trackLoadLimit)):(r.includes(t)||r.push(t),e())):setTimeout(u,a)}()):setTimeout(u,a))}}(),function(){"use strict";var e,t,o=Chapel.options.storagekey+"_hal_restart_",n=(Chapel.debug("HAL Session Key -> ",o),window.sessionStorage?(Chapel.debug("Session Storage Available"),e=function(e,t){window.sessionStorage.setItem(o+e,t)},t=function(e){return window.sessionStorage.getItem(o+e)}):(Chapel.debug("Session Storage Unavailable"),e=function(){},t=function(){},console.warn("Session storage is unavailable...")),{save:e,load:t});window.Chapel.Audio.state={_store:n,saveTracks:function(){var e;try{e=Fast.map(Chapel.Audio.classes.Track.list,function(e){return{id:e.id,sources:e.sources}}),Chapel.debug("Session Saved (Tracks) -> ",e),e=JSON.stringify(e),n.save("tracks",e)}catch(e){console.error(e.message)}},loadTracks:function(){var e;try{e=(e=n.load("tracks"))&&JSON.parse(e),Array.isArray(e)&&e.length&&(Chapel.debug("Session Loaded (Tracks) -> ",e),Fast.forEach(e,function(e){e.id&&e.sources&&!Chapel.Audio.classes.Track.has(e.id)?Chapel.Audio.newTrack.apply(null,[e.id].concat(e.sources)):Chapel.debug("Track reloading skipped.")}))}catch(e){console.error(e.message)}},savePlaylists:function(){try{var o=Chapel.Audio.classes.Playlist.list,e=Fast.map(Object.keys(o),function(e){var t={};return t.tracks=Fast.map(o[e].tracks,function(e){return e.id}),t.id=o[e].id,t});Chapel.debug("Session Saved (Playlists) -> ",e),e=JSON.stringify(e),n.save("playlists",e)}catch(e){console.error(e.message)}},loadPlaylists:function(){var e;try{(e=(e=n.load("playlists"))&&JSON.parse(e))&&Array.isArray(e)&&e.length&&(Chapel.debug("Session Loaded (Playlists) -> ",e),Fast.forEach(e,function(e){e.id&&e.tracks&&Chapel.Audio.createPlaylist(e.id,e.tracks)}))}catch(e){console.error(e.message)}},saveGroups:function(){var t;try{t={},Fast.forEach(Object.keys(Chapel.Audio.groups.custom),function(e){t[e]=Fast.map(Chapel.Audio.groups.custom[e],function(e){return"string"==typeof e?e:e.id})}),Chapel.debug("Session Saved (Groups) -> ",t),t=JSON.stringify(t),n.save("groups",t)}catch(e){console.error(e.message)}},loadGroups:function(){var t;try{(t=(t=n.load("groups"))&&JSON.parse(t))&&"object"==typeof t&&(Chapel.debug("Session Loaded (Groups) -> ",t),Fast.forEach(Object.keys(t),function(e){Fast.map(t[e],function(e){return Chapel.Audio.classes.Track.get(e)})}),Chapel.Audio.groups.custom=t)}catch(e){console.error(e.message)}}}}(),function(){"use strict";var e=Chapel.options;e.globalA&&void 0===window.A&&(Chapel.debug("Created global A interface."),window.A=window.Chapel.Audio),Chapel.Get.fromPassage&&(Chapel.debug("Loading tracks from track def special passage -> ",Chapel.Get.fromPassage),Chapel.Get.fromPassage.forEach(function(e,t){Chapel.Audio.newTrack.apply(null,[t].concat(e))})),$(document).on("unload",function(){Chapel.debug("User Prefs Saved"),window.Chapel.Audio.savePrefs()}),Chapel.Audio.classes.Track.renew(),Chapel.Audio.controls&&Chapel.Audio.controls.updateVolume(),Chapel.Get.isHarlowe3OrLater&&($(window).on("unload",function(){Chapel.debug("HAL State Saved"),Chapel.Audio.state.saveTracks(),Chapel.Audio.state.savePlaylists(),Chapel.Audio.state.saveGroups()}),Chapel.debug("HAL State Loaded"),Chapel.Audio.state.loadTracks(),Chapel.Audio.state.loadPlaylists(),Chapel.Audio.state.loadGroups()),e.persistPrefs&&(Chapel.debug("User Prefs Loaded"),Chapel.Audio.loadPrefs())}(),function(){"use strict";var i,s,e,u,t;Chapel.options.showControls&&(i=Engine,s=Chapel.Audio.controls.$user,e=function(){return"none"!==s.css("display")},u=function(){return e()||s.css("display","block"),s},t=function(){return e()&&s.css("display","none"),s},Chapel.Audio.menu={hide:t,show:u,isShown:e,links:{add:function(e,t,o){var n,a;if(!e||"string"!=typeof e)return r="undefined",alert(r),void console.error(r);o||"function"!=typeof t?(t&&"string"==typeof t&&(n=t),o&&"function"==typeof o&&(a=o)):(a=t,n=null);var r=$(document.createElement("tw-link")).append(e).attr({tabindex:"0",name:e.toLowerCase().trim()}).on("click",function(){n&&i.goToPassage(n),a&&a()}).addClass("story-menu").appendTo(s);return u(),r},clear:function(){return s.empty(),t()},hide:function(e){e=e.toLowerCase().trim(),$('tw-link.story-menu[name="'+e+'"]').addClass("hide")},show:function(e){e=e.toLowerCase().trim(),$('tw-link.story-menu[name="'+e+'"]').removeClass("hide")},toggle:function(e){e=e.toLowerCase().trim(),$('tw-link.story-menu[name="'+e+'"]').toggleClass("hide")},remove:function(e){e=e.toLowerCase().trim(),$('tw-link.story-menu[name="'+e+'"]').remove()}}})}(),function(){"use strict";var n=Chapel.Audio;function o(e){return e&&"function"==typeof e}function a(e,t){if(!e||"string"!=typeof e)return null;switch(e=e.toLowerCase().trim()){case"isplaying":e="isPlaying";break;case"playwhenpossible":e="playWhenPossible";break;case"ismuted":e="isAMuted";break;case"togglemute":e="toggleMute";break;case"getvolume":e="getVolume";break;case"islooping":e="isLooping";break;case"toggleloop":e="toggleLoop";break;case"fadein":e="fadeIn";break;case"fadeout":e="fadeOut";break;case"fadeto":e="fadeTo";break;case"stopall":e="stopAll"}if("isPlaying"===e&&"master"===t&&(e="audioPlaying"),"group"===t){if(o(n.group.prototype[e]))return e}else if("master"===t){if(o(n[e]))return e}else if(o(n.classes[t].prototype[e]))return e;throw new ReferenceError('Cannot run the command: "'+e+'" on the API "'+t+'". The command may be invalid, or this may be a bug in HAL.',"macros.js -> getCommand()",10)}window.Chapel.Macros.add({newtrack:function(){var e=[].slice.call(arguments);try{return n.newTrack.apply(null,e)}catch(e){alert("Error in the (newtrack:) macro: "+e.message)}},newplaylist:function(e,t){t=[].slice.call(arguments).slice(1);try{return n.createPlaylist(e,t)}catch(e){alert("Error in the (newplaylist:) macro: "+e.message)}},newgroup:function(e,t){t=[].slice.call(arguments).slice(1);try{return n.createGroup(e,t)}catch(e){alert("Error in the (newgroup:) macro: "+e.message)}},masteraudio:function(e){try{return e=a(e,"master"),n[e].apply(null,[].slice.call(arguments).slice(1))}catch(e){alert("Error in the (masteraudio:) macro: "+e.message)}},track:function(e,t){try{var o=n.track(e);return o[t=a(t,"Track")].apply(o,[].slice.call(arguments).slice(2))}catch(e){alert("Error in the (track:) macro: "+e.message)}},playlist:function(e,t){try{var o=n.playlist(e);return o[t=a(t,"Playlist")].apply(o,[].slice.call(arguments).slice(2))}catch(e){alert("Error in the (playlist:) macro: "+e.message)}},group:function(e,t){try{var o=n.group(e);return o[t=a(t,"group")].apply(o,[].slice.call(arguments).slice(2))}catch(e){alert("Error in the (group:) macro: "+e.message)}}})}();
/** End of HAL code */

:: StoryStylesheet [stylesheet]
   /* =========================================
       ESTILS GENERALS I TWINE
       ========================================= */
    html, body {
        background-color: black; 
        overflow-x: hidden; 
        position: relative;
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: sans-serif;
    }

    tw-sidebar { display: none; }

    tw-story {
        max-width: 100%;
        margin-top: 0 !important;
        margin-left: 0 !important;
        padding: 0 !important;
        box-sizing: border-box;
    }

    .tw-passage {
        min-height: 100vh !important;
        width: 100%;
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    /* Contenidor de la imatge i mapa */
    .twine-image-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        line-height: 0;
        text-align: center;
        width: 100%;
        height: 100%;
        flex-grow: 1;
        position: relative; 
    }

    /* Imatge de fons (mapa) */
    .twine-image-wrapper img[usemap] {
        display: block;
        width: auto;
        max-width: 100%;
        height: auto;
        max-height: 100vh; 
        margin: 0 auto;
        /* FIX: Establir capa base per evitar que tapi les superposicions */
        position: relative; 
        z-index: 1;
    }

    /* =========================================
       ELEMENTS VISUALS DINÀMICS (OVERLAYS)
       ========================================= */
    
    /* FIX: Ocultar overlays estàtics generats per Twine (per classe o atributs) */
    .twine-overlay, 
    .twine-image-wrapper img[data-hotspot-id],
    .twine-image-wrapper img:not([usemap]):not(.hotspot-visual):not(.inventory-icon-img) {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }

    /* FIX: Forçar que les imatges de l'inventari es vegin sempre, fins i tot si estan dins del wrapper */
    .twine-image-wrapper #inventory-container img,
    #inventory-container img {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
    }

    /* Classe per a les imatges dinàmiques (JS) - SENSE TRANSICIONS */
    .hotspot-visual {
        position: absolute;
        z-index: 5;
        pointer-events: none;
        object-fit: fill;
        margin: 0 !important; 
        padding: 0 !important;
        display: none; /* Ocult per defecte, JS fa .show() */
    }

    /* =========================================
       INVENTARI
       ========================================= */
    #inventory-container {
        position: fixed;
        top: 10px;
        right: 10px;
        left: auto;      
        transform: none; 
        
        background-color: rgba(30, 41, 59, 0.9);
        border: 2px solid #475569;
        border-radius: 8px;
        padding: 10px;
        
        display: flex;
        flex-direction: column; 
        gap: 10px;
        
        z-index: 11000; 
        min-width: 70px; 
        height: auto;    
        align-items: center;
        justify-content: flex-start;
        
        display: none; 
    }

    .inventory-item {
        width: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: help;
    }

    .inventory-icon-wrapper {
        width: 50px;
        height: 50px;
        border: 1px solid #94a3b8;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .inventory-icon-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .inventory-name {
        font-size: 10px;
        color: white;
        text-align: center;
        margin-top: 4px;
        line-height: 1.2;
        text-shadow: 1px 1px 2px black;
        word-wrap: break-word;
        width: 100%;
    }
    
    /* =========================================
       CURSOR LABEL (MODIFICAT)
       ========================================= */
    #cursor-label {
        position: fixed;
        display: none; /* Ocult per defecte */
        
        /* Estil igual que twineImageInfoDisplay */
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px 20px;
        border-radius: 18px;
        font-size: 1.1em;
        
        /* Treiem vores antigues per coincidir */
        border: none;
        
        pointer-events: none; 
        z-index: 999999; /* Molt alt per estar sobretot */
        white-space: nowrap;
        text-align: center;
    }

    /* =========================================
       MOTOR DE DIÀLEG
       ========================================= */
    
    #dialogue-container { 
        position: fixed; 
        bottom: 20px; 
        left: 50%; 
        transform: translateX(-50%); 
        width: 90%; 
        max-width: 800px; 
        margin: 0 auto; 
        font-family: sans-serif; 
        color: #fff; 
        pointer-events: auto !important; 
        z-index: 10000; 
    }

    .adv-dialogue-box { 
        background-color: #1e293b; 
        border: 2px solid #475569; 
        border-top-width: 6px; 
        border-radius: 12px; 
        padding: 20px; 
        display: flex; 
        gap: 20px; 
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); 
    }

    .adv-portrait { 
        width: 150px; 
        height: 150px; 
        flex-shrink: 0; 
        border-radius: 8px; 
        border: 3px solid rgba(255,255,255,0.2); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        overflow: hidden; 
        font-size: 64px; 
        font-weight: bold; 
        color: white; 
        text-shadow: 1px 1px 3px rgba(0,0,0,0.5); 
        background-color: #334155; 
    }

    .adv-portrait img { width: 100%; height: 100%; object-fit: cover; }
    
    .adv-content { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        min-height: 220px; 
    }

    .adv-name { margin: 0 0 10px 0; font-size: 1.1em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
    .adv-text { margin: 0 0 0px 0; font-size: 1.1em; line-height: 1.5; color: #e2e8f0; }
    
    .adv-options { 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        margin-top: 20px; 
    }
    
    .adv-options button { 
        background-color: #334155; 
        border: 1px solid #475569; 
        color: #f1f5f9; 
        padding: 12px 16px; 
        text-align: left; 
        border-radius: 6px; 
        cursor: pointer; 
        transition: all 0.2s; 
        font-size: 0.95em; 
        font-weight: 600;
    }

    .adv-options button:hover { background-color: #475569; border-color: #94a3b8; transform: translateX(5px); }
    .adv-msg { font-style: italic; color: #94a3b8; text-align: center; margin-top: 10px; }

    html.adv-dialogue-active .twine-image-wrapper img,
    html.adv-dialogue-active map,
    html.adv-dialogue-active area,
    html.adv-dialogue-active .hotspot-item {
        pointer-events: none !important;
        cursor: default !important;
    }

    /* =========================================
       DISPLAY D'INFORMACIÓ
       ========================================= */
    #twineImageInfoDisplay {
        display: none;
        position: absolute;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px 20px;
        border-radius: 18px;
        z-index: 1000;
        white-space: nowrap;
        max-width: 80%;
        box-sizing: border-box;
        text-align: center;
        font-size: 1.1em;
    }

    /* =========================================
       HOTSPOTS
       ========================================= */
    .hotspot-item { cursor: pointer !important; }
    .hotspot-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
    }

/**
 * Harlowe Audio Library (HAL), by Chapel, v2.3.0
 * for Harlowe 2.1.0 and higher
 * Released under the Unlicense, and dedicated to the public domain.
**/
#audio-overlay{position:fixed;top:0;right:0;left:0;bottom:0;z-index:100000;background:#111}.lds-ring{display:block;position:relative;top:20%;margin:auto;width:20em;height:20em}.lds-ring div{box-sizing:border-box;display:block;position:absolute;width:18em;height:18em;margin:6px;border:6px solid #fff;border-radius:50%;-webkit-animation:lds-ring 1.2s cubic-bezier(.5,0,.5,1) infinite;animation:lds-ring 1.2s cubic-bezier(.5,0,.5,1) infinite;border-color:#fff transparent transparent transparent}.lds-ring div:nth-child(1){-webkit-animation-delay:-.45s;animation-delay:-.45s}.lds-ring div:nth-child(2){-webkit-animation-delay:-.3s;animation-delay:-.3s}.lds-ring div:nth-child(3){-webkit-animation-delay:-.15s;animation-delay:-.15s}@-webkit-keyframes lds-ring{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes lds-ring{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}input#audio-volume{width:100%;margin:2em 0}span#vol-title{position:relative;bottom:-1em;font-size:1rem;float:left}tw-link#audio-mute{display:inline-block;padding:.3em;width:90%;text-decoration:none;color:#111;background:#eee;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;border:1px solid #000}tw-link#audio-mute:hover{opacity:.8}tw-link#audio-mute:active{opacity:.6}tw-link#audio-mute span{display:inline-block;width:1em;position:relative;height:1em;top:.2em;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAQAAABLCVATAAABF0lEQVR4Ae2VJVREYRSEB3ftuFUaLhF6I22iF7TgLr1XvAc849CwiBac9Xtm3e97cefp/Pec7+mdH0mZrGtMoBomyAEHfjGHXKg07gNxeUS3BuMAqGZswE7YcOIYgqgG7BFlSQgTAgKysC2jNjQmghFQCOpMxq+QmQgmFATU4kcq/YlgfKB1lALUqFSukRIbEwpy4BTZPM/Bu9TaQ362KAsl56sAtSR+Sgv6RCFdr/gjBYiuj65c3J0eNEmXz95TgybocvmoJj3avf5l59L1iD/WglZCP7/uh8zgeQ6epdahaZENFIPCCFvEYNPW4JdNazBGzhkj6caCbSc02DRRu0+8RR/+rb7wx6D505HxCVKvG0zpp+yknHe8MBDkT/s8AAAAAElFTkSuQmCC);background-size:contain}tw-link#audio-mute.muted span{right:4px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAASElEQVR4Ae3WsQ0AMAjAsJ7ez9MTGEmlRGL3BJzPq6prw2DDYMNgw2DDYMOwh1kAMUygQIEC2RejANVxnVE9aDOqJ39GVZWqB5Z3r1ndBX5oAAAAAElFTkSuQmCC)}div#audio-volume{float:left}div#audio-controls{font:100% Georgia,serif;font-size:1.5em;position:fixed;width:8em;height:100%;padding:1em 2em;z-index:10000;top:0;left:0;bottom:0;background:#333;color:#eee;transition:left .3s;text-align:center}div#audio-controls.closed{left:-10.5em}div#audio-controls tw-link#audio-panel-toggle{display:inline-block;width:1.5em;position:absolute;height:1.5em;top:0;right:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;text-decoration:none;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAQAAABLCVATAAAAYklEQVR4Ae3MsQFAMAAEQMDEagCgN4EuVTrbPcACeUBugDNeSdMQomI0PmYdTEYD9DA5jcVoBKuxGY1kNQ6jGRSaGaIj8gw1aI/KYVUSNqsSzMpiVT2zMjlVN0fqVW5o2luMGHqkQmD9cPYAAAAASUVORK5CYII=);background-size:contain}div#audio-controls.closed tw-link#audio-panel-toggle{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAQAAABLCVATAAAAZElEQVR4Ae3TpwGAMBQAUfrEeHB0cDhcXBSO7ehlgBw9N8BL/YZO95r6uA/UEbOv+ylfHRJ9z1BWLynKJqmWohyS6ijKOygKCpmjZYqXTTA2xUiCsShGAMw8/Q3ArFgFMHek0w3WCaR74eO2YQAAAABJRU5ErkJggg==)}@media screen and (max-width:800px){div#audio-controls.closed{left:-12em}div#audio-controls.closed tw-link#audio-panel-toggle{right:-1.5em}}div#story-menu{margin:1em 0}tw-link.story-menu{width:100%;display:block;font-weight:400;background:#ccc;font-size:.9em;padding:.1em 0;color:#111;border:1px solid #333}tw-link.story-menu.hide{display:none}tw-link.story-menu:hover{opacity:.8}tw-link.story-menu:active{opacity:.6}input[type=range].hal{-webkit-appearance:none;width:100%;margin:2.25px 0}input[type=range].hal:focus{outline:0}input[type=range].hal::-webkit-slider-runnable-track{width:100%;height:15.5px;cursor:pointer;box-shadow:.4px .4px 1px #000,0 0 .4px #0d0d0d;background:#111;border-radius:0;border:0 solid #010101}input[type=range].hal::-webkit-slider-thumb{box-shadow:0 0 2.2px rgba(17,17,17,.1),0 0 0 rgba(30,30,30,.1);border:0 solid #fff;height:20px;width:11px;border-radius:0;background:rgba(255,255,255,.93);cursor:pointer;-webkit-appearance:none;margin-top:-2.25px}input[type=range].hal:focus::-webkit-slider-runnable-track{background:#444}input[type=range].hal::-moz-range-track{width:100%;height:15.5px;cursor:pointer;box-shadow:.4px .4px 1px #000,0 0 .4px #0d0d0d;background:#111;border-radius:0;border:0 solid #010101}input[type=range].hal::-moz-range-thumb{box-shadow:0 0 2.2px rgba(17,17,17,.1),0 0 0 rgba(30,30,30,.1);border:0 solid #fff;height:20px;width:11px;border-radius:0;background:rgba(255,255,255,.93);cursor:pointer}input[type=range].hal::-ms-track{width:100%;height:15.5px;cursor:pointer;background:0 0;border-color:transparent;color:transparent}input[type=range].hal::-ms-fill-lower{background:#000;border:0 solid #010101;border-radius:0;box-shadow:.4px .4px 1px #000,0 0 .4px #0d0d0d}input[type=range].hal::-ms-fill-upper{background:#111;border:0 solid #010101;border-radius:0;box-shadow:.4px .4px 1px #000,0 0 .4px #0d0d0d}input[type=range].hal::-ms-thumb{box-shadow:0 0 2.2px rgba(17,17,17,.1),0 0 0 rgba(30,30,30,.1);border:0 solid #fff;height:20px;width:11px;border-radius:0;background:rgba(255,255,255,.93);cursor:pointer;height:15.5px}input[type=range].hal:focus::-ms-fill-lower{background:#111}input[type=range].hal:focus::-ms-fill-upper{background:#444}
/** End of HAL code */