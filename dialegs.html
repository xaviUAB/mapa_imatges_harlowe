<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Diàlegs Interactius Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            user-select: none;
        }
        /* --- Canvas & Grid --- */
        #canvas-area {
            background-image: 
                linear-gradient(rgba(229, 231, 235, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(229, 231, 235, 0.5) 1px, transparent 1px);
            background-size: 40px 40px;
            transform-origin: 0 0;
        }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        
        /* --- Nodes Styles --- */
        .node-card {
            transition: box-shadow 0.2s, border-color 0.2s; 
            position: absolute;
            z-index: 10;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .node-type-normal { border: 2px solid #e2e8f0; }
        .node-type-start { border: 2px solid #22c55e; box-shadow: 0 0 10px rgba(34, 197, 94, 0.2); }
        .node-type-end { border: 2px solid #ef4444; }
        .node-type-logic { border: 2px solid #a855f7; }
        .node-type-decision { border: 2px solid #f97316; }

        .node-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 20;
        }
        
        .header-normal { background-color: #64748b; }
        .header-start { background-color: #16a34a; }
        .header-end { background-color: #dc2626; }
        .header-logic { background-color: #9333ea; }
        .header-decision { background-color: #ea580c; }

        .node-search-highlight { ring: 4px solid #facc15; transform: scale(1.05); z-index: 30; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; z-index: 50; }
        .resize-handle::after { content: ''; position: absolute; right: 2px; bottom: 2px; width: 0; height: 0; border-bottom: 8px solid #94a3b8; border-left: 8px solid transparent; }

        /* --- Connexions --- */
        .connection-line { stroke: #64748b; stroke-width: 3; fill: none; pointer-events: none; stroke-linecap: round; transition: stroke 0.2s; }
        .connection-line.dashed { stroke-dasharray: 8, 4; }
        .connection-line.alt { stroke: #a855f7; stroke-dasharray: 4, 4; } 
        .connection-line:hover { stroke: #3b82f6; z-index: 5; pointer-events: stroke; }
        
        /* Punts de control */
        .connection-handle {
            fill: #3b82f6;
            stroke: white;
            stroke-width: 2;
            cursor: grab;
            pointer-events: all;
            transition: r 0.2s, fill 0.2s;
            z-index: 100;
        }
        .connection-handle:hover { r: 10; fill: #2563eb; cursor: grabbing; }
        .handle-connector { stroke: #cbd5e1; stroke-width: 1.5; stroke-dasharray: 4; pointer-events: none; }

        .port-out { width: 14px; height: 14px; background-color: #cbd5e1; border: 2px solid #475569; border-radius: 50%; position: absolute; right: -8px; top: 50%; transform: translateY(-50%); cursor: crosshair; transition: all 0.2s; z-index: 30; }
        .port-out:hover { transform: translateY(-50%) scale(1.4); background-color: #3b82f6; border-color: white; }

        /* --- Minimapa --- */
        #minimap-container { display: none; }

        /* --- Utilities --- */
        .retro-text { font-family: 'Courier New', Courier, monospace; text-shadow: 2px 2px 0px #000; }
        .thin-scrollbar::-webkit-scrollbar { width: 6px; }
        .thin-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .thin-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .thin-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .logic-row { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .logic-row.open { max-height: 400px; overflow: visible; }
        .code-input { font-family: 'Consolas', 'Monaco', monospace; font-size: 0.75rem; color: #ea580c; }
        .dropdown-menu { display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #cbd5e1; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 220px; z-index: 100; }
        .dropdown-menu.show { display: block; }
        .visual-builder-group { display: flex; gap: 4px; align-items: center; background: #f1f5f9; padding: 4px; border-radius: 4px; margin-bottom: 4px; }
        .vb-select { font-size: 11px; padding: 2px; border-radius: 3px; border: 1px solid #d1d5db; background: white; max-width: 100px; }
        .vb-input { font-size: 11px; padding: 2px; border-radius: 3px; border: 1px solid #d1d5db; width: 60px; }
        .vb-label { font-size: 10px; font-weight: bold; color: #64748b; text-transform: uppercase; }
        .exp-thumb { width: 20px; height: 20px; object-fit: cover; border-radius: 50%; border: 1px solid #ccc; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <!-- CAPÇALERA -->
    <header class="bg-slate-800 text-white h-14 px-4 flex justify-between items-center shadow-lg z-50">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-diagram-project text-xl text-blue-400"></i>
            <h1 class="text-lg font-bold tracking-wide">Editor de Diàlegs Pro <span class="text-xs font-normal opacity-50 ml-2">v6.6</span></h1>
        </div>
        
        <div class="flex gap-2 bg-slate-700 p-1 rounded-lg">
            <button onclick="historySystem.undo()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-600 text-slate-300 hover:text-white transition" title="Desfer (Ctrl+Z)"><i class="fa-solid fa-rotate-left"></i></button>
            <button onclick="historySystem.redo()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-600 text-slate-300 hover:text-white transition" title="Refer (Ctrl+Y)"><i class="fa-solid fa-rotate-right"></i></button>
            <div class="w-px bg-slate-500 mx-1 h-6 self-center"></div>
            <div class="flex items-center bg-slate-800 rounded px-2">
                <i class="fa-solid fa-magnifying-glass text-slate-400 text-xs mr-2"></i>
                <input type="text" id="node-search" placeholder="Cercar..." class="bg-transparent border-none text-xs text-white focus:outline-none w-32" oninput="editor.handleSearch(this.value)">
            </div>
        </div>

        <div class="flex gap-2 relative">
            <label class="bg-slate-600 hover:bg-slate-500 px-3 py-1.5 rounded text-sm font-bold transition cursor-pointer flex items-center gap-2">
                <i class="fa-solid fa-upload"></i> Carregar
                <input type="file" class="hidden" accept=".json" onchange="ioSystem.loadFile(this)">
            </label>
            <button onclick="editor.addNode()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-sm font-bold transition shadow flex items-center gap-2"><i class="fa-solid fa-plus"></i> Node</button>
            <div class="h-6 w-px bg-slate-600 mx-1 self-center"></div>
            <button onclick="editor.togglePreview()" class="bg-green-600 hover:bg-green-500 px-3 py-1.5 rounded text-sm font-bold transition shadow flex items-center gap-2"><i class="fa-solid fa-play"></i> Provar</button>
            <button onclick="ioSystem.exportJSON()" class="bg-slate-600 hover:bg-slate-500 px-3 py-1.5 rounded text-sm font-bold transition shadow flex items-center gap-2"><i class="fa-solid fa-download"></i> JSON</button>
            
            <div class="relative">
                <button onclick="ui.toggleConfigMenu()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-sm font-bold transition flex items-center gap-2" title="Configuració Visual"><i class="fa-solid fa-sliders"></i></button>
                <div id="config-menu" class="dropdown-menu text-slate-800 p-2 right-0">
                    <div class="text-xs font-bold text-gray-400 uppercase mb-2 px-2">Estil de Línia</div>
                    <button onclick="editor.setConnectionStyle('bezier')" class="w-full text-left px-2 py-2 text-sm hover:bg-blue-50 rounded flex items-center gap-2"><i class="fa-solid fa-bezier-curve text-blue-500"></i> Corba (Bézier)</button>
                    <button onclick="editor.setConnectionStyle('straight')" class="w-full text-left px-2 py-2 text-sm hover:bg-blue-50 rounded flex items-center gap-2"><i class="fa-solid fa-minus text-green-500"></i> Recta</button>
                    <button onclick="editor.setConnectionStyle('step')" class="w-full text-left px-2 py-2 text-sm hover:bg-blue-50 rounded flex items-center gap-2"><i class="fa-solid fa-stairs text-purple-500"></i> Pas (Manhattan)</button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- BARRA LATERAL -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col z-40 shadow-md relative">
            <div class="flex border-b border-gray-200">
                <button onclick="ui.switchTab('chars')" id="tab-chars" class="flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50">Personatges</button>
                <button onclick="ui.switchTab('vars')" id="tab-vars" class="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-gray-700">Variables</button>
            </div>
            <div id="panel-chars" class="flex-1 flex flex-col overflow-hidden">
                <div class="p-3 border-b bg-gray-50 text-xs text-gray-500 text-center italic">Gestiona les expressions dels personatges</div>
                <div class="p-2 bg-gray-50 border-b">
                    <button onclick="characterManager.addCharacter()" class="w-full bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded text-sm hover:bg-gray-50 transition flex items-center justify-center gap-2 shadow-sm"><i class="fa-solid fa-user-plus"></i> Nou Personatge</button>
                </div>
                <div id="character-list" class="flex-1 overflow-y-auto p-3 space-y-3 thin-scrollbar"></div>
            </div>
            <div id="panel-vars" class="flex-1 flex flex-col overflow-hidden hidden">
                <div class="p-3 border-b bg-gray-50">
                    <div class="flex gap-2 mb-2"><input type="text" id="new-var-name" placeholder="Nom (ex: or)" class="flex-1 border rounded px-2 py-1 text-sm code-input text-black"><select id="new-var-type" class="border rounded text-sm bg-white"><option value="number">Num</option><option value="boolean">Bool</option><option value="string">Text</option></select></div>
                    <div class="flex gap-2"><input type="text" id="new-var-val" placeholder="Valor inicial" class="flex-1 border rounded px-2 py-1 text-sm"><button onclick="variableManager.addVariable()" class="bg-green-600 text-white px-3 rounded hover:bg-green-500"><i class="fa-solid fa-plus"></i></button></div>
                </div>
                <div id="variable-list" class="flex-1 overflow-y-auto p-3 space-y-2 thin-scrollbar bg-slate-50"></div>
            </div>
        </aside>

        <!-- WORKSPACE -->
        <main class="flex-1 relative overflow-hidden bg-gray-100" id="workspace-container">
            <div id="canvas-area" class="absolute w-[8000px] h-[8000px] cursor-grab" style="top: 0px; left: 0px; transform: translate(-2000px, -2000px) scale(1);">
                <svg id="connections-layer" class="absolute top-0 left-0 w-full h-full z-0 pointer-events-none overflow-visible">
                    <defs>
                        <marker id="arrowhead-normal" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#64748b" />
                        </marker>
                        <marker id="arrowhead-alt" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#a855f7" />
                        </marker>
                    </defs>
                    <path id="temp-connection" class="connection-line-active hidden" d="" marker-end="url(#arrowhead-normal)"></path>
                </svg>
            </div>
            
            <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-30 pointer-events-none"><div class="bg-black/70 text-white px-3 py-1 rounded-full text-xs backdrop-blur-md shadow font-mono"><span id="zoom-level">100%</span></div></div>
            <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-30 pointer-events-auto">
                <button onclick="editor.zoomToFit()" class="bg-white shadow-lg p-3 rounded-full hover:bg-blue-50 text-blue-600 transition" title="Veure Tot"><i class="fa-solid fa-expand"></i></button>
                <button onclick="editor.resetView()" class="bg-white shadow-lg p-3 rounded-full hover:bg-gray-100 text-gray-600 transition" title="Reset 100%"><i class="fa-solid fa-compress"></i></button>
            </div>
            <div id="autosave-indicator" class="absolute top-4 right-4 bg-white/80 backdrop-blur text-gray-500 text-xs px-2 py-1 rounded shadow opacity-0 transition-opacity pointer-events-none"><i class="fa-solid fa-floppy-disk mr-1"></i> Guardat</div>
        </main>
    </div>

    <!-- MODALS & PROMPTS -->
    <div id="preview-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="relative w-full max-w-6xl aspect-video bg-slate-900 rounded-xl shadow-2xl border-4 border-slate-700 overflow-hidden flex flex-col">
            <div id="preview-game-area" class="flex-1 relative flex items-center justify-center bg-cover bg-center transition-all duration-500">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-slate-900/50"></div>
                <i id="preview-default-bg" class="fa-solid fa-gamepad text-slate-700 text-9xl opacity-20 absolute"></i>
                <button onclick="editor.togglePreview()" class="absolute top-4 right-4 text-white/80 hover:text-white hover:bg-red-600/80 bg-black/50 px-4 py-2 rounded-full transition z-50"><i class="fa-solid fa-times mr-2"></i> Tancar</button>
                <div class="absolute top-4 left-4 bg-black/60 text-green-400 p-2 rounded text-xs font-mono pointer-events-none"><div class="font-bold border-b border-gray-600 mb-1">ESTAT</div><div id="preview-debug-vars"></div></div>
            </div>
            <div class="h-auto min-h-[35%] max-h-[50%] bg-slate-900 border-t-4 border-slate-700 p-6 flex gap-8 shrink-0 relative z-10">
                <div class="relative shrink-0"><div id="preview-portrait" class="w-32 h-32 rounded-xl shadow-lg flex items-center justify-center text-5xl font-bold text-white border-4 border-slate-600 bg-slate-800 overflow-hidden -mt-12 transition-all duration-500"><span id="preview-portrait-initial">?</span><img id="preview-portrait-img" src="" class="w-full h-full object-cover hidden"></div></div>
                <div class="flex-1 flex flex-col min-h-0">
                    <div id="preview-text-container" class="mb-4 overflow-y-auto thin-scrollbar pr-2 flex-1 transition-opacity duration-500"><h3 id="preview-char-name" class="text-yellow-400 font-bold text-xl mb-1 retro-text tracking-wide">Personatge</h3><p id="preview-text" class="text-slate-200 text-lg leading-relaxed font-light font-sans">...</p></div>
                    <div id="preview-options" class="grid grid-cols-1 gap-2 w-full mt-auto pt-2 border-t border-slate-800 max-h-[140px] overflow-y-auto thin-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-black/50 z-[150] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><i class="fa-solid fa-exclamation-triangle text-red-600 text-xl"></i></div>
                <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-2">Esborrar?</h3><p id="modal-desc" class="text-sm text-gray-500 mb-6">Estàs segur?</p>
                <div class="flex justify-center gap-3"><button onclick="ui.closeDeleteModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium rounded-md">Cancel·lar</button><button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md shadow">Sí, esborrar</button></div>
            </div>
        </div>
    </div>

    <div id="prompt-modal" class="fixed inset-0 bg-black/50 z-[160] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full">
            <h3 id="prompt-title" class="text-lg font-bold text-gray-900 mb-2">Introdueix dades</h3>
            <input type="text" id="prompt-input" class="w-full border border-gray-300 rounded px-3 py-2 mb-4 focus:outline-none focus:border-blue-500" onkeydown="if(event.key==='Enter') ui.confirmPrompt()">
            <div class="flex justify-end gap-3"><button onclick="ui.closePrompt(null)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm">Cancel·lar</button><button onclick="ui.confirmPrompt()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Acceptar</button></div>
        </div>
    </div>

    <!-- LOGIC BUILDER MODAL -->
    <div id="logic-modal" class="fixed inset-0 bg-black/50 z-[160] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full">
            <h3 id="logic-title" class="text-lg font-bold text-gray-900 mb-4">Constructor de Condicions</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Variable</label>
                    <select id="logic-var" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Operador</label>
                    <select id="logic-op" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Valor</label>
                    <input type="text" id="logic-val" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm" placeholder="Valor...">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="ui.closeLogicBuilder()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium">Cancel·lar</button>
                <button onclick="ui.confirmLogicBuilder()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm font-medium shadow">Inserir</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS TWINE ---
        const TWINE_ENGINE_JS = `window.AdventureEngine = (function() {
    let state = { nodes: [], characters: [], vars: {}, visited: new Set(), currentNodeId: null, containerId: 'dialogue-container' };
    function getCharacter(id) { return state.characters.find(c => c.id === id) || { name: '?', color: '#ccc' }; }
    function evaluate(code) { if (!code || !code.trim()) return true; try { const keys = Object.keys(state.vars); const values = Object.values(state.vars); const fn = new Function(...keys, \`return \${code};\`); return fn(...values); } catch (e) { console.error("Error condició:", code, e); return false; } }
    function execute(code) { if (!code || !code.trim()) return; try { const keys = Object.keys(state.vars); const values = Object.values(state.vars); const fn = new Function(...keys, \`\${code}; return {\${keys.join(',')}};\`); const newVars = fn(...values); state.vars = { ...state.vars, ...newVars }; } catch (e) { console.error("Error efecte:", code, e); } }
    function renderNode() {
        const container = document.getElementById(state.containerId); if (!container) return;
        const node = state.nodes.find(n => n.id === state.currentNodeId); if (!node) { container.innerHTML = ""; toggleActive(false); return; }
        if (node.type === 'end') { container.innerHTML = ""; toggleActive(false); return; }
        if (node.type === 'logic') { 
             const validOpt = node.options.find(o => !o.condition || evaluate(o.condition));
             if (validOpt) { if (validOpt.effect) execute(validOpt.effect); if (validOpt.targetNodeId) { state.currentNodeId = validOpt.targetNodeId; setTimeout(renderNode, 10); return; } }
             container.innerHTML = ""; toggleActive(false); return; 
        }
        const char = getCharacter(node.characterId);
        let avatarImg = char.avatarUrl;
        if (node.characterExpression && char.expressions) {
             const validExp = node.expressionOptions && node.expressionOptions.find(e => !e.condition || evaluate(e.condition));
             if (validExp) {
                 const expData = char.expressions.find(ex => ex.name === validExp.expression);
                 if (expData) avatarImg = expData.url;
             } else {
                 const directExp = char.expressions.find(ex => ex.name === node.characterExpression);
                 if (directExp) avatarImg = directExp.url;
             }
        } else if (node.characterExpression && char.expressions) {
             const directExp = char.expressions.find(ex => ex.name === node.characterExpression);
             if (directExp) avatarImg = directExp.url;
        }

        const textOpts = Array.isArray(node.textOptions) ? node.textOptions : [{ text: node.text || "", condition: "" }];
        let validTexts = textOpts.filter(t => evaluate(t.condition));
        if (validTexts.some(t => t.condition && t.condition.trim() !== "")) validTexts = validTexts.filter(t => t.condition && t.condition.trim() !== "");
        const chosenTextObj = validTexts.length > 0 ? validTexts[Math.floor(Math.random() * validTexts.length)] : { text: "..." };
        let finalText = chosenTextObj.text.replace(/\\{(\\w+)\\}/g, (_, v) => state.vars[v] ?? '?').replace(/\\$(\\w+)/g, (_, v) => state.vars[v] ?? ('$' + v));

        let html = \`<div class="adv-dialogue-box" style="border-top-color: \${char.color}"><div class="adv-portrait" style="background-color: \${char.color}">\${avatarImg ? \`<img src="\${avatarImg}">\` : \`<span>\${char.name[0]}</span>\`}</div><div class="adv-content"><h3 class="adv-name" style="color: \${char.color}">\${char.name}</h3><p class="adv-text">\${finalText}</p><div class="adv-options">\`;
        const availableOptions = node.options.filter((opt, idx) => { const visitedKey = node.id + '_' + idx; if (opt.once && state.visited.has(visitedKey)) return false; if (opt.condition && !evaluate(opt.condition)) return false; return true; });
        if (availableOptions.length === 0 && node.options.length > 0) { html += \`<div class="adv-msg">No hi ha més opcions.</div>\`; } else if (node.options.length === 0) { html += \`<div class="adv-msg">Fi del diàleg.</div>\`; } else { availableOptions.forEach((opt) => { const idx = node.options.indexOf(opt); html += \`<button onclick="AdventureEngine.selectOption('\${node.id}', \${idx})">\${opt.text}</button>\`; }); }
        html += \`</div></div></div>\`; container.innerHTML = html;
    }
    function toggleActive(isActive) { if(isActive) document.documentElement.classList.add('adv-dialogue-active'); else document.documentElement.classList.remove('adv-dialogue-active'); }
    return {
        init: function(jsonData, containerId = 'dialogue-container') { try { const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData; const coreData = data.appState || data; state.nodes = coreData.nodes || []; state.characters = coreData.characters || []; state.vars = coreData.globalVariables || {}; state.visited = new Set(); state.containerId = containerId; if (state.nodes.length === 0) return; state.currentNodeId = state.nodes[0].id; toggleActive(true); setTimeout(renderNode, 10); } catch (e) { console.error("Init Error:", e); } },
        selectOption: function(nodeId, optionIndex) { const node = state.nodes.find(n => n.id === nodeId); const opt = node.options[optionIndex]; if (opt.once) state.visited.add(nodeId + '_' + optionIndex); if (opt.effect) execute(opt.effect); let nextId = opt.targetNodeId; if (opt.altTargetNodeId && opt.targetCondition && evaluate(opt.targetCondition)) nextId = opt.altTargetNodeId; if (nextId) { state.currentNodeId = nextId; renderNode(); } else { const container = document.getElementById(state.containerId); container.innerHTML = ""; if (window.jQuery) jQuery(container).hide(); else container.style.display = 'none'; toggleActive(false); } }
    };
})();`;
        const TWINE_ENGINE_CSS = `#dialogue-container { max-width: 800px; margin: 0 auto; font-family: sans-serif; color: #fff; pointer-events: auto !important; position: relative; z-index: 10000; } .adv-dialogue-box { background-color: #1e293b; border: 2px solid #475569; border-top-width: 6px; border-radius: 12px; padding: 20px; display: flex; gap: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); } .adv-portrait { width: 80px; height: 80px; flex-shrink: 0; border-radius: 8px; border: 3px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 32px; font-weight: bold; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); } .adv-portrait img { width: 100%; height: 100%; object-fit: cover; } .adv-content { flex: 1; display: flex; flex-direction: column; } .adv-name { margin: 0 0 10px 0; font-size: 1.1em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; } .adv-text { margin: 0 0 20px 0; font-size: 1.1em; line-height: 1.5; color: #e2e8f0; } .adv-options { display: flex; flex-direction: column; gap: 8px; } .adv-options button { background-color: #334155; border: 1px solid #475569; color: #f1f5f9; padding: 12px 16px; text-align: left; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 0.95em; } .adv-options button:hover { background-color: #475569; border-color: #94a3b8; transform: translateX(5px); } .adv-msg { font-style: italic; color: #94a3b8; text-align: center; margin-top: 10px; } html.adv-dialogue-active .twine-image-wrapper img, html.adv-dialogue-active map, html.adv-dialogue-active area, html.adv-dialogue-active .hotspot-item { pointer-events: none !important; cursor: default !important; }`;

        // --- ESTAT ---
        const appState = {
            characters: [{ id: 'char_1', name: 'Personatge', color: '#3b82f6', avatarUrl: '', avatarFileName: '', expressions: [] }],
            globalVariables: {},
            nodes: [{
                id: 'node_start', title: "Inici", type: "start", characterId: 'char_1',
                characterExpression: 'Normal', 
                expressionOptions: [{expression: 'Normal', condition: ''}],
                textOptions: [ { text: "", condition: "" } ], options: [], x: 2200, y: 2200, width: 450, height: null 
            }],
            scale: 1, panOffset: { x: -2000, y: -2000 },
            interactionMode: 'default', draggingNodeId: null, resizingNodeId: null, draggingOption: null, dragOffset: { x: 0, y: 0 }, connectionStart: { nodeId: null, optionIndex: null, x: 0, y: 0 },
            dragAllowed: false,
            connectionStyle: 'bezier',
            draggingCP: null // stores {nodeId, optionIndex, pointIndex}
        };

        // --- SISTEMES ---
        const historySystem = {
            past: [], future: [], maxDepth: 50, ignoreChange: false,
            pushState() { if (this.ignoreChange) return; const snap = JSON.stringify({ characters: appState.characters, nodes: appState.nodes, globalVariables: appState.globalVariables }); if (this.past.length > 0 && this.past[this.past.length - 1] === snap) return; this.past.push(snap); if (this.past.length > this.maxDepth) this.past.shift(); this.future = []; ioSystem.autosave(); },
            undo() { if (this.past.length === 0) return; this.future.push(JSON.stringify({ characters: appState.characters, nodes: appState.nodes, globalVariables: appState.globalVariables })); this.load(JSON.parse(this.past.pop())); },
            redo() { if (this.future.length === 0) return; this.past.push(JSON.stringify({ characters: appState.characters, nodes: appState.nodes, globalVariables: appState.globalVariables })); this.load(JSON.parse(this.future.pop())); },
            load(s) { this.ignoreChange=true; appState.characters=s.c; appState.nodes=s.n; appState.globalVariables=s.v; characterManager.renderList(); variableManager.renderList(); editor.renderNodes(); this.ignoreChange=false; }
        };

        const ui = {
            promptCallback: null,
            logicTargetInput: null, 
            logicType: null,

            switchTab(t) { document.getElementById('panel-chars').classList.toggle('hidden', t!=='chars'); document.getElementById('panel-vars').classList.toggle('hidden', t!=='vars'); document.getElementById('tab-chars').className = t==='chars' ? "flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50" : "flex-1 py-3 text-sm font-bold text-gray-500 hover:text-gray-700"; document.getElementById('tab-vars').className = t==='vars' ? "flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50" : "flex-1 py-3 text-sm font-bold text-gray-500 hover:text-gray-700"; },
            showDeleteModal(id, type) { this.itemToDeleteId = id; this.itemToDeleteType = type; document.getElementById('delete-modal').classList.remove('hidden'); document.getElementById('modal-title').innerText = type==='node'?"Esborrar Node?":type==='character'?"Esborrar Personatge?":"Esborrar Variable?"; document.getElementById('modal-desc').innerText = type==='node'?"Es perdran connexions.":type==='character'?"Reassignat al defecte.":"Es pot trencar la lògica."; document.getElementById('confirm-delete-btn').onclick = () => { historySystem.pushState(); if(type==='node') editor.deleteNodeConfirmed(this.itemToDeleteId); else if(type==='character') characterManager.deleteCharacterConfirmed(this.itemToDeleteId); else variableManager.deleteVariableConfirmed(this.itemToDeleteId); this.closeDeleteModal(); }; },
            closeDeleteModal() { document.getElementById('delete-modal').classList.add('hidden'); },
            toggleLogic(btn) { btn.closest('.option-row').querySelector('.logic-row').classList.toggle('open'); btn.classList.toggle('text-blue-600'); },
            showPrompt(title, placeholder, cb) {
                this.promptCallback = cb;
                document.getElementById('prompt-title').innerText = title;
                const inp = document.getElementById('prompt-input');
                inp.value = ''; inp.placeholder = placeholder || '';
                document.getElementById('prompt-modal').classList.remove('hidden');
                setTimeout(()=>inp.focus(), 100);
            },
            confirmPrompt() {
                const val = document.getElementById('prompt-input').value;
                document.getElementById('prompt-modal').classList.add('hidden');
                if(val && this.promptCallback) this.promptCallback(val);
                this.promptCallback = null;
            },
            closePrompt(val) {
                document.getElementById('prompt-modal').classList.add('hidden');
                if(val !== null && this.promptCallback) this.promptCallback(val);
                this.promptCallback = null;
            },
            toggleConfigMenu() {
                document.getElementById('config-menu').classList.toggle('show');
            },
            showLogicBuilder(targetInput, type) {
                this.logicTargetInput = targetInput;
                this.logicType = type;
                const vars = Object.keys(appState.globalVariables);
                if(vars.length === 0) { alert("Primer has de crear variables al panell lateral."); return; }
                const modal = document.getElementById('logic-modal');
                const title = document.getElementById('logic-title');
                const varSelect = document.getElementById('logic-var');
                const opSelect = document.getElementById('logic-op');
                const valInput = document.getElementById('logic-val');
                title.innerText = type === 'condition' ? "Constructor de Condicions" : "Constructor d'Efectes";
                varSelect.innerHTML = vars.map(v => `<option value="${v}">${v}</option>`).join('');
                opSelect.innerHTML = '';
                if (type === 'condition') {
                    const ops = [{ val: '==', txt: 'Igual (==)' }, { val: '>', txt: 'Major (>)' }, { val: '<', txt: 'Menor (<)' }, { val: '>=', txt: 'Major o igual (>=)' }, { val: '<=', txt: 'Menor o igual (<=)' }, { val: '!=', txt: 'No igual (!=)' }];
                    ops.forEach(op => opSelect.innerHTML += `<option value="${op.val}">${op.txt}</option>`);
                } else {
                    const ops = [{ val: '=', txt: 'Assignar (=)' }, { val: '+=', txt: 'Sumar (+=)' }, { val: '-=', txt: 'Restar (-=)' }, { val: '*=', txt: 'Multiplicar (*=)' }, { val: '/=', txt: 'Dividir (/=)' }];
                    ops.forEach(op => opSelect.innerHTML += `<option value="${op.val}">${op.txt}</option>`);
                }
                valInput.value = '';
                modal.classList.remove('hidden');
            },
            confirmLogicBuilder() {
                const v = document.getElementById('logic-var').value;
                const op = document.getElementById('logic-op').value;
                const val = document.getElementById('logic-val').value;
                if (this.logicTargetInput) {
                    this.logicTargetInput.value = `${v} ${op} ${val}`;
                    this.logicTargetInput.dispatchEvent(new Event('change'));
                }
                this.closeLogicBuilder();
            },
            closeLogicBuilder() {
                document.getElementById('logic-modal').classList.add('hidden');
                this.logicTargetInput = null;
            }
        };

        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-menu') && !event.target.closest('button[onclick*="toggleConfigMenu"]')) {
                var dropdowns = document.getElementsByClassName("dropdown-menu");
                for (var i = 0; i < dropdowns.length; i++) { var openDropdown = dropdowns[i]; if (openDropdown.classList.contains('show')) { openDropdown.classList.remove('show'); } }
            }
        }

        const variableManager = {
            init() { this.renderList(); },
            addVariable() { const n=document.getElementById('new-var-name').value.trim().replace(/[^a-zA-Z0-9_$]/g,'_'); if(!n||appState.globalVariables.hasOwnProperty(n))return alert("Error"); let v=document.getElementById('new-var-val').value, t=document.getElementById('new-var-type').value; if(t==='number')v=Number(v)||0;if(t==='boolean')v=(v==='true'); historySystem.pushState(); appState.globalVariables[n]=v; this.renderList(); document.getElementById('new-var-name').value=''; },
            updateVariable(k, v) { historySystem.pushState(); const c=appState.globalVariables[k]; appState.globalVariables[k]=typeof c==='number'?Number(v):typeof c==='boolean'?(v==='true'):v; },
            deleteVariable(k) { ui.showDeleteModal(k, 'variable'); }, deleteVariableConfirmed(k) { delete appState.globalVariables[k]; this.renderList(); },
            renderList() { const c=document.getElementById('variable-list'); c.innerHTML=''; for(const [k,v] of Object.entries(appState.globalVariables)){ const t=typeof v; const inp=t==='boolean'?`<select onchange="variableManager.updateVariable('${k}',this.value)" class="text-xs border rounded p-1 bg-white"><option value="true" ${v?'selected':''}>true</option><option value="false" ${!v?'selected':''}>false</option></select>`:`<input type="${t==='number'?'number':'text'}" value="${v}" onchange="variableManager.updateVariable('${k}',this.value)" class="w-16 text-xs border rounded p-1 text-right code-input text-blue-600">`; const d=document.createElement('div'); d.className="flex items-center justify-between bg-white p-2 rounded border border-gray-200 shadow-sm"; d.innerHTML=`<div class="flex items-center gap-2 overflow-hidden"><span class="text-xs font-mono font-bold text-slate-700 truncate" title="${k}">${k}</span><span class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">${t.substr(0,3)}</span></div><div class="flex items-center gap-2">${inp}<button onclick="variableManager.deleteVariable('${k}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button></div>`; c.appendChild(d); } }
        };

        const characterManager = {
            init() { this.renderList(); },
            addCharacter() { historySystem.pushState(); appState.characters.push({id:'char_'+Date.now(),name:'Nou',color:'#8b5cf6',avatarUrl:'', avatarFileName: '', expressions: []}); this.renderList(); },
            updateCharacter(id,f,v) { const c=appState.characters.find(x=>x.id===id); if(c&&c[f]!==v){ c[f]=v; if(f==='color'||f==='name') editor.renderNodes(); } },
            handleImageSelect(id, input, expName = null) {
                const file = input.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_SIZE = 200; 
                            let w = img.width; let h = img.height;
                            if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE/w; w = MAX_SIZE; } } else { if (h > MAX_SIZE) { w *= MAX_SIZE/h; h = MAX_SIZE; } }
                            canvas.width = w; canvas.height = h;
                            ctx.drawImage(img, 0, 0, w, h);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                            const c = appState.characters.find(x => x.id === id);
                            if(c) {
                                historySystem.pushState();
                                if (!expName) {
                                    c.avatarUrl = dataUrl;
                                    c.avatarFileName = file.name;
                                    if (!c.expressions) c.expressions = [];
                                    const normalExp = c.expressions.find(ex => ex.name === 'Normal');
                                    if (!normalExp) {
                                        c.expressions.unshift({ name: 'Normal', url: dataUrl, fileName: file.name });
                                    }
                                } else {
                                    const exp = c.expressions.find(x => x.name === expName);
                                    if(exp) { exp.url = dataUrl; exp.fileName = file.name; }
                                }
                                this.renderList();
                                editor.renderNodes();
                            }
                        }
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },
            addExpression(id) {
                ui.showPrompt("Nom de l'expressió (ex: Feliç)", "Feliç", (name) => {
                    historySystem.pushState();
                    const c = appState.characters.find(x => x.id === id);
                    if (!c.expressions) c.expressions = [];
                    c.expressions.push({ name: name, url: '', fileName: '' });
                    this.renderList();
                    editor.renderNodes();
                });
            },
            deleteExpression(id, name) {
                historySystem.pushState();
                const c = appState.characters.find(x => x.id === id);
                c.expressions = c.expressions.filter(e => e.name !== name);
                this.renderList();
                editor.renderNodes();
            },
            saveState() { historySystem.pushState(); },
            deleteCharacter(id) { if(appState.characters.length<=1)return alert("Mínim 1."); ui.showDeleteModal(id,'character'); },
            deleteCharacterConfirmed(id) { appState.characters=appState.characters.filter(c=>c.id!==id); const f=appState.characters[0].id; appState.nodes.forEach(n=>{if(n.characterId===id)n.characterId=f;}); this.renderList(); editor.renderNodes(); },
            getCharacter(id) { return appState.characters.find(c=>c.id===id)||appState.characters[0]; },
            draggedIndex: null, handleDragStart(e,i) { this.draggedIndex=i; e.dataTransfer.effectAllowed="move"; }, handleDragOver(e) { e.preventDefault(); }, handleDrop(e,t) { e.stopPropagation(); if(this.draggedIndex!==null&&this.draggedIndex!==t){ historySystem.pushState(); const it=appState.characters.splice(this.draggedIndex,1)[0]; appState.characters.splice(t,0,it); this.renderList(); } },
            renderList() { 
                const c=document.getElementById('character-list'); c.innerHTML=''; 
                appState.characters.forEach((char,i)=>{ 
                    const d=document.createElement('div'); d.className="draggable-item bg-white p-2 rounded border border-gray-200 shadow-sm group mb-2"; 
                    d.innerHTML=`<div class="flex items-center gap-2 mb-2" draggable="true" ondragstart="characterManager.handleDragStart(event,${i})" ondragover="characterManager.handleDragOver(event)" ondrop="characterManager.handleDrop(event,${i})">
                        <i class="fa-solid fa-grip-vertical text-gray-300 cursor-move hover:text-gray-500"></i>
                        <input type="color" value="${char.color}" onchange="characterManager.updateCharacter('${char.id}','color',this.value);characterManager.saveState()" class="w-6 h-6 rounded cursor-pointer border-none p-0 shrink-0">
                        ${char.avatarUrl ? `<img src="${char.avatarUrl}" class="w-6 h-6 rounded object-cover border border-gray-300 shrink-0" title="Imatge Base">` : ''}
                        <input type="text" value="${char.name}" onchange="characterManager.updateCharacter('${char.id}','name',this.value);characterManager.saveState()" class="flex-1 text-sm font-bold border-none focus:ring-0 p-0 min-w-0" placeholder="Nom">
                        <button onclick="characterManager.deleteCharacter('${char.id}')" class="text-gray-300 hover:text-red-500 shrink-0"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 p-1 rounded mb-1">
                        <input type="file" id="file-input-${char.id}" class="hidden" accept="image/*" onchange="characterManager.handleImageSelect('${char.id}', this)">
                        <button onclick="document.getElementById('file-input-${char.id}').click()" class="flex-1 flex items-center gap-2 text-[10px] text-gray-500 hover:text-blue-600 px-1">
                            <i class="fa-regular fa-image"></i>
                            <span class="truncate">${char.avatarFileName ? char.avatarFileName : (char.avatarUrl ? 'Canviar Imatge...' : 'Seleccionar Imatge...')}</span>
                        </button>
                        <button onclick="characterManager.addExpression('${char.id}')" class="text-[10px] bg-blue-100 text-blue-600 px-1 rounded border border-blue-200 hover:bg-blue-200" title="Afegir Expressió"><i class="fa-solid fa-face-smile"></i>+</button>
                    </div>
                    <div class="pl-4 space-y-1">
                        ${(char.expressions||[]).map(exp => `
                            <div class="flex items-center gap-2 text-[10px] bg-gray-50 p-1 rounded border border-gray-100">
                                <span class="font-bold text-gray-600 w-12 truncate" title="${exp.name}">${exp.name}</span>
                                <img src="${exp.url || ''}" class="exp-thumb ${!exp.url?'hidden':''}">
                                <input type="file" id="exp-input-${char.id}-${exp.name}" class="hidden" accept="image/*" onchange="characterManager.handleImageSelect('${char.id}', this, '${exp.name}')">
                                <button onclick="document.getElementById('exp-input-${char.id}-${exp.name}').click()" class="flex-1 text-left text-gray-400 hover:text-blue-500 truncate">${exp.fileName || 'Tria img...'}</button>
                                <button onclick="characterManager.deleteExpression('${char.id}', '${exp.name}')" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                            </div>
                        `).join('')}
                    </div>`; 
                    c.appendChild(d); 
                }); 
            }
        };

        const editor = {
            init() { this.renderNodes(); this.setupCanvasEvents(); this.applyTransform(); document.addEventListener('keydown',(e)=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();historySystem.undo();}if((e.ctrlKey||e.metaKey)&&e.key==='y'){e.preventDefault();historySystem.redo();}}); },
            
            addNode(x,y) { 
                if(x===undefined){const c=document.getElementById('workspace-container');x=(c.clientWidth/2-appState.panOffset.x)/appState.scale;y=(c.clientHeight/2-appState.panOffset.y)/appState.scale;} 
                historySystem.pushState(); 
                const id='node_'+Date.now(); 
                appState.nodes.push({
                    id, title: "Nou Node", type: "normal", characterId: appState.characters[0].id,
                    characterExpression: 'Normal', 
                    expressionOptions: [{expression: "Normal", condition: ""}], 
                    textOptions: [{text: "", condition: ""}],
                    x, y, width: 450, height: null, options: []
                }); 
                this.renderNodes(); 
                return id; 
            },
            deleteNodeConfirmed(id) { appState.nodes=appState.nodes.filter(n=>n.id!==id); appState.nodes.forEach(n=>{n.options.forEach(opt=>{if(opt.targetNodeId===id)opt.targetNodeId=null;if(opt.altTargetNodeId===id)opt.altTargetNodeId=null;});}); this.renderNodes(); },
            updateNode(id,f,v) { const n=appState.nodes.find(x=>x.id===id); if(n){ n[f]=v; if(f==='title')this.updateTitleRefs(id,v); if(f==='characterId'||f==='type')this.renderNodes(); } },
            saveState() { historySystem.pushState(); },
            updateTitleRefs(id,t) { document.querySelectorAll(`.target-opt-${id}`).forEach(e=>e.innerText=t||'Sense Títol'); },
            addTextVar(nid) { const n=appState.nodes.find(x=>x.id===nid); historySystem.pushState(); n.textOptions.push({text:"",condition:""}); this.renderNodes(); },
            deleteTextVar(nid,idx) { const n=appState.nodes.find(x=>x.id===nid); if(n.textOptions.length<=1)return; historySystem.pushState(); n.textOptions.splice(idx,1); this.renderNodes(); },
            updateTextVar(nid,idx,f,v) { const n=appState.nodes.find(x=>x.id===nid); n.textOptions[idx][f]=v; },
            addOption(id) { const n=appState.nodes.find(x=>x.id===id); historySystem.pushState(); n.options.push({text:"Opció...",targetNodeId:null,altTargetNodeId:null,targetCondition:"",once:false,condition:"",effect:""}); this.renderNodes(); },
            deleteOption(id,idx) { const n=appState.nodes.find(x=>x.id===id); historySystem.pushState(); n.options.splice(idx,1); this.renderNodes(); },
            updateOption(id,idx,f,v) { const n=appState.nodes.find(x=>x.id===id); n.options[idx][f]=v; if(['targetNodeId','altTargetNodeId','once'].includes(f))this.drawConnections(); },
            handleOptDragStart(e,nid,idx) { if(!appState.dragAllowed){e.preventDefault();return;} appState.dragAllowed=false; appState.draggingOption={nodeId:nid,index:idx}; e.dataTransfer.effectAllowed="move"; e.dataTransfer.setData('text/plain',nid); e.target.closest('.option-row').classList.add('opacity-50'); },
            handleOptDragOver(e){e.preventDefault();},
            handleOptDrop(e,nid,tidx){ e.stopPropagation(); const s=appState.draggingOption; if(!s||s.nodeId!==nid||s.index===tidx)return; historySystem.pushState(); const n=appState.nodes.find(x=>x.id===nid); const i=n.options.splice(s.index,1)[0]; n.options.splice(tidx,0,i); this.renderNodes(); },
            handleOptDragEnd(e){ appState.draggingOption=null; document.querySelectorAll('.option-row').forEach(el=>el.classList.remove('opacity-50')); },
            handleTargetSelect(nid,idx,val,alt=false) { historySystem.pushState(); const f=alt?'altTargetNodeId':'targetNodeId'; if(val==='NEW'){ const p=appState.nodes.find(x=>x.id===nid); const nid2=this.addNode(p.x+450,p.y+(idx*100)); this.updateOption(nid,idx,f,nid2); } else this.updateOption(nid,idx,f,val||null); },
            handleSearch(q) { q=q.toLowerCase(); document.querySelectorAll('.node-card').forEach(el=>{ if(!q){el.classList.remove('node-search-highlight','opacity-25');return;} const n=appState.nodes.find(x=>x.id===el.id); const match=n.title.toLowerCase().includes(q)||n.textOptions.some(t=>t.text.toLowerCase().includes(q)); if(match){el.classList.add('node-search-highlight');el.classList.remove('opacity-25');}else{el.classList.remove('node-search-highlight');el.classList.add('opacity-25');} }); },
            insertLogic(input, type) { ui.showLogicBuilder(input, type); },
            zoomToFit() {
                if (appState.nodes.length === 0) return;
                let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
                appState.nodes.forEach(n => {
                    minX = Math.min(minX, n.x); minY = Math.min(minY, n.y);
                    maxX = Math.max(maxX, n.x + (n.width||450)); maxY = Math.max(maxY, n.y + (n.height||200));
                });
                const padding = 100; const w = maxX - minX + (padding*2); const h = maxY - minY + (padding*2);
                const c = document.getElementById('workspace-container');
                const cw = c.clientWidth; const ch = c.clientHeight;
                let scale = Math.min(cw/w, ch/h); scale = Math.min(Math.max(scale, 0.2), 1);
                const cx = minX + (maxX - minX)/2; const cy = minY + (maxY - minY)/2;
                appState.scale = scale; appState.panOffset.x = (cw/2) - (cx*scale); appState.panOffset.y = (ch/2) - (cy*scale);
                this.applyTransform();
            },
            setConnectionStyle(style) { appState.connectionStyle = style; this.drawConnections(); },
            updateExpVar(nid,idx,f,v) { const n=appState.nodes.find(x=>x.id===nid); n.expressionOptions[idx][f]=v; this.renderNodes(); },
            addExpVar(nid) { const n=appState.nodes.find(x=>x.id===nid); historySystem.pushState(); if(!n.expressionOptions) n.expressionOptions=[]; n.expressionOptions.push({expression:"",condition:""}); this.renderNodes(); },
            deleteExpVar(nid,idx) { const n=appState.nodes.find(x=>x.id===nid); if(n.expressionOptions.length<=1)return; historySystem.pushState(); n.expressionOptions.splice(idx,1); this.renderNodes(); },
            handleCPDragStart(e, nodeId, optionIndex, pointIndex) {
                e.stopPropagation();
                appState.interactionMode = 'dragging_cp';
                appState.draggingCP = { nodeId, optionIndex, pointIndex };
            },
            resetCP(e, nodeId, optionIndex) {
                e.stopPropagation();
                const n = appState.nodes.find(x => x.id === nodeId);
                if(n && n.options[optionIndex]) {
                    delete n.options[optionIndex].cp1;
                    delete n.options[optionIndex].cp2;
                    this.drawConnections();
                }
            },

            renderNodes() {
                const cv=document.getElementById('canvas-area'); document.querySelectorAll('.node-card').forEach(e=>e.remove());
                let optsHtml='<option value="">(Fi / Res)</option>'; appState.nodes.forEach(n=>optsHtml+=`<option value="${n.id}" class="target-opt-${n.id}">${n.title||'Sense Títol'}</option>`); const newOpt=`<option value="NEW" class="text-blue-600 font-bold">[+ Nou Node]</option>`;

                appState.nodes.forEach(node=>{
                    const char=characterManager.getCharacter(node.characterId); 
                    if (!node.expressionOptions) node.expressionOptions = [{expression: "", condition: ""}];
                    
                    const expVarsHtml = node.expressionOptions.map((expObj, i) => {
                        let options = ``; 
                        if (char.expressions) {
                            options += char.expressions.map(e => `<option value="${e.name}" ${expObj.expression===e.name?'selected':''}>${e.name}</option>`).join('');
                        }
                        return `<div class="flex flex-col gap-1 mb-1 bg-blue-50 p-1 rounded border border-blue-100"><div class="flex gap-1 items-center"><span class="text-[9px] font-bold text-blue-600 uppercase w-6">Cara</span><select onchange="editor.updateExpVar('${node.id}',${i},'expression',this.value);editor.saveState()" class="flex-1 text-[10px] border rounded p-0.5 bg-white">${options}</select><button onclick="editor.deleteExpVar('${node.id}',${i})" class="text-gray-300 hover:text-red-500 ${node.expressionOptions.length===1?'hidden':''}"><i class="fa-solid fa-times text-[10px]"></i></button></div><div class="flex items-center gap-1"><span class="text-[9px] font-bold text-gray-400 w-6 text-right">IF</span><input type="text" value="${expObj.condition||''}" onchange="editor.updateExpVar('${node.id}',${i},'condition',this.value);editor.saveState()" class="flex-1 bg-white border rounded px-1 py-0.5 text-[10px] code-input" placeholder="Condició"><button onclick="editor.insertLogic(this.previousElementSibling, 'condition')" class="text-blue-500 hover:text-blue-700 text-xs px-1" title="Constructor"><i class="fa-solid fa-wand-magic-sparkles"></i></button></div></div>`;
                    }).join('');

                    const typeColors = { normal: 'header-normal', start: 'header-start', end: 'header-end', logic: 'header-logic', decision: 'header-decision' };
                    const typeClass = `node-type-${node.type||'normal'}`;
                    const headerClass = typeColors[node.type||'normal'];
                    const div=document.createElement('div'); div.id=node.id; div.className=`node-card ${typeClass}`;
                    div.style.left=node.x+'px'; div.style.top=node.y+'px'; div.style.width=(node.width||450)+'px'; if(node.height)div.style.height=node.height+'px';
                    
                    const textVarsHtml=node.textOptions.map((t,i)=>`<div class="flex flex-col gap-1 mb-2 bg-yellow-50 p-1.5 rounded border border-yellow-200"><div class="flex gap-1"><span class="text-[10px] font-bold text-yellow-600 mt-1">TXT</span><textarea onchange="editor.updateTextVar('${node.id}',${i},'text',this.value);editor.saveState()" class="w-full p-1 text-xs border rounded resize-y h-12 focus:outline-none focus:border-yellow-400" placeholder="Text...">${t.text}</textarea><button onclick="editor.deleteTextVar('${node.id}',${i})" class="text-gray-300 hover:text-red-500 self-start ${node.textOptions.length===1?'hidden':''}"><i class="fa-solid fa-times"></i></button></div><div class="visual-builder-group"><span class="vb-label w-4">IF</span><input type="text" value="${t.condition||''}" onchange="editor.updateTextVar('${node.id}',${i},'condition',this.value);editor.saveState()" class="flex-1 bg-white border rounded px-1 py-0.5 text-[10px] code-input" placeholder="Condició"><button onclick="editor.insertLogic(this.previousElementSibling, 'condition')" class="text-blue-500 hover:text-blue-700 text-xs px-1" title="Constructor"><i class="fa-solid fa-wand-magic-sparkles"></i></button></div></div>`).join('');
                    
                    const optionsContent=node.options.map((opt,i)=>`<div class="relative group option-row mb-2 p-2 bg-slate-50 rounded border border-slate-200 transition hover:border-blue-300 flex flex-col" data-idx="${i}" draggable="true" ondragstart="editor.handleOptDragStart(event, '${node.id}', ${i})" ondragover="editor.handleOptDragOver(event)" ondrop="editor.handleOptDrop(event, '${node.id}', ${i})" ondragend="editor.handleOptDragEnd(event)">
                        <div class="flex items-center gap-2 mb-1"><div class="cursor-move text-gray-300 hover:text-gray-500 mr-1 self-center grab-handle" onmousedown="appState.dragAllowed=true" onmouseup="appState.dragAllowed=false" onmouseleave="appState.dragAllowed=false"><i class="fa-solid fa-grip-vertical"></i></div><input type="checkbox" ${opt.once?'checked':''} onchange="editor.updateOption('${node.id}',${i},'once',this.checked);editor.saveState()" class="accent-blue-600" title="Només un cop"><input type="text" value="${opt.text}" onchange="editor.updateOption('${node.id}',${i},'text',this.value);editor.saveState()" class="flex-1 text-sm bg-transparent border-b border-transparent focus:border-blue-400 outline-none" placeholder="Text opció..."><button onclick="ui.toggleLogic(this)" class="text-gray-400 hover:text-blue-600 transition" title="Lògica"><i class="fa-solid fa-code"></i></button><button onclick="editor.deleteOption('${node.id}',${i})" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div><div class="logic-row bg-slate-100 rounded px-2 text-xs space-y-1 border-l-2 border-orange-400 mb-2"><div class="visual-builder-group mt-1"><span class="vb-label w-8">IF</span><input type="text" value="${opt.condition||''}" onchange="editor.updateOption('${node.id}',${i},'condition',this.value);editor.saveState()" class="flex-1 bg-white border rounded px-1 code-input"><button onclick="editor.insertLogic(this.previousElementSibling,'condition')" class="text-blue-500 px-1"><i class="fa-solid fa-wand-magic-sparkles"></i></button></div><div class="visual-builder-group"><span class="vb-label w-8">DO</span><input type="text" value="${opt.effect||''}" onchange="editor.updateOption('${node.id}',${i},'effect',this.value);editor.saveState()" class="flex-1 bg-white border rounded px-1 code-input"><button onclick="editor.insertLogic(this.previousElementSibling,'effect')" class="text-blue-500 px-1"><i class="fa-solid fa-wand-magic-sparkles"></i></button></div><div class="visual-builder-group border-t pt-1 mt-1"><span class="vb-label w-8 text-purple-600">ELSE</span><input type="text" value="${opt.targetCondition||''}" onchange="editor.updateOption('${node.id}',${i},'targetCondition',this.value);editor.saveState()" class="flex-1 bg-white border rounded px-1 code-input" placeholder="Condició desviació"><button onclick="editor.insertLogic(this.previousElementSibling,'condition')" class="text-blue-500 px-1"><i class="fa-solid fa-wand-magic-sparkles"></i></button></div><div class="flex items-center gap-2 pb-1"><span class="vb-label w-8 text-purple-600">GOTO</span><select onchange="editor.handleTargetSelect('${node.id}',${i},this.value,true)" class="flex-1 bg-white border rounded px-1 text-[10px]">${optsHtml.replace(`value="${opt.altTargetNodeId}"`,`value="${opt.altTargetNodeId}" selected`)}<option disabled>────────</option> ${newOpt}</select>
                        <button onclick="editor.handleTargetSelect('${node.id}',${i},'',true)" class="text-red-400 hover:text-red-600" title="Desconnectar"><i class="fa-solid fa-link-slash"></i></button></div></div><div class="mt-1 flex items-center gap-1"><i class="fa-solid fa-share-nodes text-gray-300 text-xs"></i><select onchange="editor.handleTargetSelect('${node.id}',${i},this.value)" class="w-full text-xs bg-transparent outline-none text-slate-600 cursor-pointer hover:text-blue-600">${optsHtml.replace(`value="${opt.targetNodeId}"`,`value="${opt.targetNodeId}" selected`)}<option disabled>────────</option> ${newOpt}</select>
                        <button onclick="editor.handleTargetSelect('${node.id}',${i},'')" class="text-red-400 hover:text-red-600" title="Desconnectar"><i class="fa-solid fa-link-slash"></i></button></div><div class="port-out" onmousedown="editor.startConnection(event,'${node.id}',${i})"></div></div>`).join('');
                    
                    let charOpts=''; appState.characters.forEach(c=>charOpts+=`<option value="${c.id}" ${c.id===node.characterId?'selected':''}>${c.name}</option>`);
                    
                    let displayAvatar = char.avatarUrl; 
                    if (node.expressionOptions && node.expressionOptions.length > 0 && node.expressionOptions[0].expression) {
                        const expName = node.expressionOptions[0].expression;
                        const expObj = char.expressions ? char.expressions.find(e => e.name === expName) : null;
                        if (expObj && expObj.url) { displayAvatar = expObj.url; }
                    }

                    div.innerHTML=`
                        <div class="drag-handle p-2 border-b flex items-center gap-2 rounded-t-md cursor-grab active:cursor-grabbing text-white ${headerClass}">
                            <select onchange="editor.updateNode('${node.id}','type',this.value);editor.saveState()" class="bg-transparent text-xs font-bold outline-none border border-white/30 rounded text-white cursor-pointer hover:bg-white/10" title="Tipus de Node">
                                <option value="normal" ${node.type==='normal'?'selected':''} style="color:black">📝</option>
                                <option value="start" ${node.type==='start'?'selected':''} style="color:black">🏁</option>
                                <option value="end" ${node.type==='end'?'selected':''} style="color:black">🛑</option>
                                <option value="logic" ${node.type==='logic'?'selected':''} style="color:black">⚙️</option>
                                <option value="decision" ${node.type==='decision'?'selected':''} style="color:black">🔀</option>
                            </select>
                            <input type="text" value="${node.title}" onchange="editor.updateNode('${node.id}','title',this.value);editor.saveState()" class="flex-1 bg-transparent font-bold text-sm focus:bg-black/20 rounded px-1 outline-none placeholder-white/50" placeholder="Títol">
                            <button onclick="ui.showDeleteModal('${node.id}','node')" class="opacity-50 hover:opacity-100 mr-2"><i class="fa-solid fa-times"></i></button>
                            <!-- MOVE ICON ADDED -->
                            <div class="cursor-move hover:text-gray-200 px-1 border-l border-white/20 pl-2"><i class="fa-solid fa-arrows-up-down-left-right"></i></div>
                        </div>
                        <div class="p-3 flex flex-col flex-1 min-h-0 gap-2">
                            <div class="flex gap-4">
                                <div class="w-24 h-24 rounded-lg shadow-md flex items-center justify-center text-white font-bold text-4xl shrink-0 overflow-hidden border-2 border-gray-100 self-start" style="background-color:${char.color}">
                                    ${displayAvatar ? `<img src="${displayAvatar}" class="w-full h-full object-cover">` : char.name[0]}
                                </div>
                                
                                <div class="flex-1 flex flex-col gap-2 min-w-0">
                                    <div><select onchange="editor.updateNode('${node.id}','characterId',this.value)" class="w-full text-sm border rounded p-1 bg-gray-50 font-bold text-gray-700 shadow-sm">${charOpts}</select></div>
                                    <!-- FLEX-1 for expressions container -->
                                    <div class="flex flex-col border rounded p-1 bg-gray-50/50 flex-1 min-h-[40px] overflow-hidden">
                                        <div class="flex justify-between items-center mb-1 px-1">
                                            <span class="text-[10px] font-bold text-blue-600 uppercase">Expressions</span>
                                            <button onclick="editor.addExpVar('${node.id}')" class="text-[10px] bg-blue-100 text-blue-700 px-2 rounded hover:bg-blue-200 shadow-sm"><i class="fa-solid fa-plus"></i></button>
                                        </div>
                                        <div class="overflow-y-auto thin-scrollbar px-1 space-y-1 h-full">${expVarsHtml}</div>
                                    </div>
                                </div>
                            </div>
                            <!-- FLEX-1 for texts container -->
                            <div class="flex flex-col flex-1 min-h-[60px] overflow-hidden">
                                <div class="flex justify-between items-center mb-1 shrink-0"><span class="text-xs font-bold text-gray-400 uppercase">Textos</span><button onclick="editor.addTextVar('${node.id}')" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 rounded hover:bg-yellow-200"><i class="fa-solid fa-plus"></i></button></div>
                                <div class="overflow-y-auto thin-scrollbar pr-1 h-full">${textVarsHtml}</div>
                            </div>
                            <!-- FLEX-1 for options container -->
                            <div class="flex flex-col flex-1 min-h-[60px] overflow-hidden border-t pt-2">
                                <div class="flex justify-between items-center mb-2 shrink-0"><span class="text-xs font-bold text-gray-400 uppercase">Respostes</span><button onclick="editor.addOption('${node.id}')" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded font-medium"><i class="fa-solid fa-plus"></i></button></div>
                                <div class="overflow-y-auto thin-scrollbar h-full -mr-1 pr-1">${optionsContent}</div>
                            </div>
                        </div>
                        <div class="resize-handle" onmousedown="editor.startResize(event,'${node.id}')"></div>
                    `;
                    
                    div.querySelector('.drag-handle').onmousedown = (e) => {
                        if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                        e.stopPropagation();
                        appState.interactionMode = 'dragging_node';
                        appState.draggingNodeId = node.id;
                        const rect = document.getElementById('workspace-container').getBoundingClientRect();
                        const nodeVisualX = (node.x * appState.scale) + appState.panOffset.x;
                        const nodeVisualY = (node.y * appState.scale) + appState.panOffset.y;
                        const mouseVisualX = e.clientX - rect.left;
                        const mouseVisualY = e.clientY - rect.top;
                        appState.dragOffset = { x: mouseVisualX - nodeVisualX, y: mouseVisualY - nodeVisualY };
                        div.style.zIndex = 50;
                    };
                    cv.appendChild(div);
                });
                this.drawConnections(); 
            },
            startResize(e,nid){e.stopPropagation();appState.interactionMode='resizing_node';appState.resizingNodeId=nid;const n=appState.nodes.find(x=>x.id===nid);appState.resizeStart={x:e.clientX,y:e.clientY};appState.resizeInitialDim={w:n.width||450,h:n.height||(document.getElementById(nid).clientHeight)};},
            drawConnections(){
                const svg=document.getElementById('connections-layer');
                Array.from(svg.children).forEach(c => {
                    if(c.tagName === 'path' && c.id !== 'temp-connection') c.remove();
                    if(c.tagName === 'circle') c.remove();
                    if(c.tagName === 'line') c.remove();
                });

                appState.nodes.forEach(n=>{
                    const el=document.getElementById(n.id);
                    if(!el)return;
                    n.options.forEach((o,i)=>{
                        const r=el.querySelectorAll('.option-row');
                        if(!r[i])return;
                        const p=r[i].querySelector('.port-out');
                        const pr=p.getBoundingClientRect();
                        const nr=el.getBoundingClientRect();
                        const rx=(pr.left-nr.left)/appState.scale;
                        const ry=(pr.top-nr.top)/appState.scale;
                        const x1=n.x+rx+8;
                        const y1=n.y+ry+8;

                        const drawLine = (tid, alt) => {
                            const t=appState.nodes.find(x=>x.id===tid);
                            if(!t)return;
                            const x2=t.x;
                            const y2=t.y+20;
                            const pt=document.createElementNS("http://www.w3.org/2000/svg","path");
                            
                            let d = "";
                            // CHECK FOR TWO CP
                            if (o.cp1 && o.cp2 && !alt) { 
                                d = `M ${x1} ${y1} C ${o.cp1.x} ${o.cp1.y}, ${o.cp2.x} ${o.cp2.y}, ${x2} ${y2}`;
                                
                                // Draw Handle 1
                                const c1 = document.createElementNS("http://www.w3.org/2000/svg","circle");
                                c1.setAttribute("cx", o.cp1.x); c1.setAttribute("cy", o.cp1.y); c1.setAttribute("r", "8"); // Increased size
                                c1.setAttribute("class", "connection-handle");
                                c1.onmousedown = (e) => editor.handleCPDragStart(e, n.id, i, 1);
                                c1.ondblclick = (e) => editor.resetCP(e, n.id, i);
                                svg.appendChild(c1);
                                
                                // Draw Handle 2
                                const c2 = document.createElementNS("http://www.w3.org/2000/svg","circle");
                                c2.setAttribute("cx", o.cp2.x); c2.setAttribute("cy", o.cp2.y); c2.setAttribute("r", "8"); // Increased size
                                c2.setAttribute("class", "connection-handle");
                                c2.onmousedown = (e) => editor.handleCPDragStart(e, n.id, i, 2);
                                c2.ondblclick = (e) => editor.resetCP(e, n.id, i);
                                svg.appendChild(c2);
                                
                                // Draw connectors lines
                                const l1 = document.createElementNS("http://www.w3.org/2000/svg","line");
                                l1.setAttribute("x1", x1); l1.setAttribute("y1", y1); l1.setAttribute("x2", o.cp1.x); l1.setAttribute("y2", o.cp1.y);
                                l1.setAttribute("class", "handle-connector");
                                svg.appendChild(l1);
                                
                                const l2 = document.createElementNS("http://www.w3.org/2000/svg","line");
                                l2.setAttribute("x1", x2); l2.setAttribute("y1", y2); l2.setAttribute("x2", o.cp2.x); l2.setAttribute("y2", o.cp2.y);
                                l2.setAttribute("class", "handle-connector");
                                svg.appendChild(l2);

                            } else {
                                // Default Styles
                                if (appState.connectionStyle === 'straight') { d = `M ${x1} ${y1} L ${x2} ${y2}`; } 
                                else if (appState.connectionStyle === 'step') { const midX = x1 + 20; const midY = y2; d = `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`; } 
                                else { if (Math.abs(y1 - y2) < 50) { d = `M ${x1} ${y1} C ${x1+50} ${y1}, ${x2-50} ${y2}, ${x2} ${y2}`; } else { d = `M ${x1} ${y1} C ${x1+100} ${y1}, ${x2-100} ${y2}, ${x2} ${y2}`; } }

                                // Init Handles if not present (for manual edit start)
                                if (!alt) {
                                    let cp1x, cp1y, cp2x, cp2y;
                                    if (Math.abs(y1 - y2) < 50) { cp1x=x1+50; cp1y=y1; cp2x=x2-50; cp2y=y2; }
                                    else { cp1x=x1+100; cp1y=y1; cp2x=x2-100; cp2y=y2; }
                                    
                                    // Always visible handles for starting drag
                                    const c1 = document.createElementNS("http://www.w3.org/2000/svg","circle");
                                    c1.setAttribute("cx", cp1x); c1.setAttribute("cy", cp1y); c1.setAttribute("r", "6");
                                    c1.setAttribute("class", "connection-handle opacity-50 hover:opacity-100"); // Visible
                                    c1.onmousedown = (e) => {
                                        if(!o.cp1) { o.cp1 = {x: cp1x, y: cp1y}; o.cp2 = {x: cp2x, y: cp2y}; }
                                        editor.handleCPDragStart(e, n.id, i, 1);
                                    };
                                    svg.appendChild(c1);

                                    const c2 = document.createElementNS("http://www.w3.org/2000/svg","circle");
                                    c2.setAttribute("cx", cp2x); c2.setAttribute("cy", cp2y); c2.setAttribute("r", "6");
                                    c2.setAttribute("class", "connection-handle opacity-50 hover:opacity-100"); // Visible
                                    c2.onmousedown = (e) => {
                                        if(!o.cp1) { o.cp1 = {x: cp1x, y: cp1y}; o.cp2 = {x: cp2x, y: cp2y}; }
                                        editor.handleCPDragStart(e, n.id, i, 2);
                                    };
                                    svg.appendChild(c2);
                                }
                            }

                            pt.setAttribute("d", d);
                            let c="connection-line";
                            if(o.once) c+=" dashed";
                            if(alt) c+=" alt";
                            pt.setAttribute("class",c);
                            let marker = alt ? "url(#arrowhead-alt)" : "url(#arrowhead-normal)";
                            pt.setAttribute("marker-end", marker);
                            
                            // Insert path BEFORE circles so circles are on top
                            if (svg.lastChild && (svg.lastChild.tagName === 'circle' || svg.lastChild.tagName === 'line')) {
                                let ref = null;
                                for(let k=0; k<svg.children.length; k++) {
                                    if(svg.children[k].tagName !== 'path' && svg.children[k].tagName !== 'defs') { ref = svg.children[k]; break; }
                                }
                                if(ref) svg.insertBefore(pt, ref); else svg.appendChild(pt);
                            } else {
                                svg.appendChild(pt);
                            }
                        };

                        if(o.targetNodeId) drawLine(o.targetNodeId, false);
                        if(o.altTargetNodeId) drawLine(o.altTargetNodeId, true);
                    });
                });
            },
            setupCanvasEvents(){
                const c=document.getElementById('workspace-container');
                c.addEventListener('wheel',(e)=>{e.preventDefault();const i=0.1,d=-Math.sign(e.deltaY),os=appState.scale,ns=Math.min(Math.max(0.1,os+(d*i)),2);const r=c.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top,lx=(mx-appState.panOffset.x)/os,ly=(my-appState.panOffset.y)/os;appState.panOffset.x=mx-(lx*ns);appState.panOffset.y=my-(ly*ns);appState.scale=ns;this.applyTransform();},{passive:false});
                c.addEventListener('mousedown',(e)=>{if(e.target===c||e.target.id==='canvas-area'||e.target.tagName==='svg'){appState.interactionMode='panning';appState.panStart={x:e.clientX,y:e.clientY};document.body.style.cursor='grabbing';}});
                this.startConnection=(e,nid,idx)=>{e.stopPropagation();appState.interactionMode='connecting';const r=c.getBoundingClientRect(),lx=(e.clientX-r.left-appState.panOffset.x)/appState.scale,ly=(e.clientY-r.top-appState.panOffset.y)/appState.scale;appState.connectionStart={nodeId:nid,optionIndex:idx,x:lx,y:ly};document.getElementById('temp-connection').classList.remove('hidden');};
                window.addEventListener('mousemove',(e)=>{
                    const r=c.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;
                    if(appState.interactionMode==='resizing_node'&&appState.resizingNodeId){
                        const n=appState.nodes.find(x=>x.id===appState.resizingNodeId),dx=(e.clientX-appState.resizeStart.x)/appState.scale,dy=(e.clientY-appState.resizeStart.y)/appState.scale;
                        n.width=Math.max(300,appState.resizeInitialDim.w+dx);n.height=Math.max(200,appState.resizeInitialDim.h+dy);
                        const el=document.getElementById(n.id);el.style.width=n.width+'px';el.style.height=n.height+'px';editor.drawConnections();
                    }
                    else if(appState.interactionMode==='dragging_node'&&appState.draggingNodeId){
                        const n=appState.nodes.find(x=>x.id===appState.draggingNodeId),
                        nx = (mx - appState.dragOffset.x - appState.panOffset.x) / appState.scale,
                        ny = (my - appState.dragOffset.y - appState.panOffset.y) / appState.scale;
                        n.x=Math.round(nx/10)*10;n.y=Math.round(ny/10)*10;const el=document.getElementById(n.id);el.style.left=n.x+'px';el.style.top=n.y+'px';this.drawConnections();
                    }
                    else if(appState.interactionMode==='dragging_cp' && appState.draggingCP) {
                        const lx = (mx - appState.panOffset.x) / appState.scale;
                        const ly = (my - appState.panOffset.y) / appState.scale;
                        const n = appState.nodes.find(x => x.id === appState.draggingCP.nodeId);
                        if(n && n.options[appState.draggingCP.optionIndex]) {
                            if(appState.draggingCP.pointIndex === 1) { n.options[appState.draggingCP.optionIndex].cp1 = {x: lx, y: ly}; } 
                            else { n.options[appState.draggingCP.optionIndex].cp2 = {x: lx, y: ly}; }
                            editor.drawConnections();
                        }
                    }
                    else if(appState.interactionMode==='panning'){const dx=e.clientX-appState.panStart.x,dy=e.clientY-appState.panStart.y;appState.panOffset.x+=dx;appState.panOffset.y+=dy;appState.panStart={x:e.clientX,y:e.clientY};this.applyTransform();}
                    else if(appState.interactionMode==='connecting'){const lx=(mx-appState.panOffset.x)/appState.scale,ly=(my-appState.panOffset.y)/appState.scale,sx=appState.connectionStart.x,sy=appState.connectionStart.y;document.getElementById('temp-connection').setAttribute("d",`M ${sx} ${sy} C ${sx+50} ${sy}, ${lx-50} ${ly}, ${lx} ${ly}`);}
                });
                window.addEventListener('mouseup',(e)=>{
                    if(appState.interactionMode==='resizing_node'){historySystem.pushState();}
                    else if(appState.interactionMode==='dragging_cp'){historySystem.pushState();}
                    else if(appState.interactionMode==='connecting'){const t=document.elementFromPoint(e.clientX,e.clientY),tn=t?t.closest('.node-card'):null,{nodeId,optionIndex}=appState.connectionStart;historySystem.pushState();if(tn&&tn.id!==nodeId){editor.updateOption(nodeId,optionIndex,'targetNodeId',tn.id);}else if(!tn){const r=c.getBoundingClientRect(),lx=(e.clientX-r.left-appState.panOffset.x)/appState.scale,ly=(e.clientY-r.top-appState.panOffset.y)/appState.scale,nid=editor.addNode(lx,ly-20);editor.updateOption(nodeId,optionIndex,'targetNodeId',nid);}document.getElementById('temp-connection').classList.add('hidden');this.renderNodes();}
                    
                    appState.interactionMode='default';appState.draggingNodeId=null;appState.resizingNodeId=null;appState.draggingCP=null;document.body.style.cursor='';
                });
            },
            applyTransform(){const el=document.getElementById('canvas-area');el.style.transform=`translate(${appState.panOffset.x}px,${appState.panOffset.y}px) scale(${appState.scale})`;},
            resetView(){appState.scale=1;appState.panOffset={x:-2000,y:-2000};this.applyTransform();},
            togglePreview(){const m=document.getElementById('preview-modal');if(m.classList.contains('hidden')){m.classList.remove('hidden');previewEngine.start();}else{m.classList.add('hidden');}}
        };

        // --- PREVIEW ---
        const previewEngine = {
            currentId: null, visited: new Set(), runtimeVars: {},
            start(keepState=false){if(appState.nodes.length===0)return alert("Buit!");this.currentId=appState.nodes[0].id;if(!keepState){this.visited.clear();this.runtimeVars=JSON.parse(JSON.stringify(appState.globalVariables));}this.render();},
            evaluate(code){if(!code||!code.trim())return true;try{const k=Object.keys(this.runtimeVars),v=k.map(x=>this.runtimeVars[x]);return new Function(...k,`return ${code};`)(...v);}catch(e){console.error("Logic err",e);return false;}},
            execute(code){if(!code||!code.trim())return;try{const k=Object.keys(this.runtimeVars),v=k.map(x=>this.runtimeVars[x]),nv=new Function(...k,`${code}\n;return {${k.join(',')}};`)(...v);this.runtimeVars={...this.runtimeVars,...nv};}catch(e){console.error("Eff err",e);}},
            render(){
                const n=appState.nodes.find(x=>x.id===this.currentId),c=characterManager.getCharacter(n.characterId);
                const bg=document.getElementById('preview-game-area'),pb=document.getElementById('preview-portrait'),pt=document.getElementById('preview-portrait-initial'),pi=document.getElementById('preview-portrait-img'),ta=document.getElementById('preview-text'),na=document.getElementById('preview-char-name'),oc=document.getElementById('preview-options'),da=document.getElementById('preview-debug-vars');
                
                if(n.type === 'logic') {
                     const validOpt = n.options.find(o => !o.condition || this.evaluate(o.condition));
                     if (validOpt) { 
                        if (validOpt.effect) this.execute(validOpt.effect);
                        if (validOpt.targetNodeId) { this.currentId = validOpt.targetNodeId; setTimeout(()=>this.render(), 10); return; }
                     }
                     pb.style.display='none';document.getElementById('preview-text-container').style.display='none';this.showEnd("Fi lògica."); return;
                }
                if(n.type === 'end') { pb.style.display='none';document.getElementById('preview-text-container').style.display='none';this.showEnd("Fi."); return; }

                pb.style.display='flex';document.getElementById('preview-text-container').style.display='block';
                if(n.bgImage){bg.style.backgroundImage=`url('${n.bgImage}')`;document.getElementById('preview-default-bg').style.display='none';}else{bg.style.backgroundImage='none';document.getElementById('preview-default-bg').style.display='block';}
                pb.style.backgroundColor=c.color;
                
                let avatar = c.avatarUrl;
                if(n.expressionOptions && n.expressionOptions.length > 0) {
                    const validExp = n.expressionOptions.find(e => !e.condition || this.evaluate(e.condition));
                    if (validExp) {
                        const exp = c.expressions && c.expressions.find(e => e.name === validExp.expression);
                        if (exp) avatar = exp.url;
                    }
                }

                if(avatar){pt.classList.add('hidden');pi.src=avatar;pi.classList.remove('hidden');}else{pt.innerText=c.name[0];pt.classList.remove('hidden');pi.classList.add('hidden');}
                na.innerText=c.name;na.style.color=c.color;da.innerHTML=Object.entries(this.runtimeVars).map(([k,v])=>`<div>${k}: <span class="text-white">${v}</span></div>`).join('');
                let vts=n.textOptions.filter(t=>this.evaluate(t.condition));const hasSpec=vts.some(t=>t.condition&&t.condition.trim()!=="");if(hasSpec)vts=vts.filter(t=>t.condition&&t.condition.trim()!=="");
                const txt=vts.length>0?vts[Math.floor(Math.random()*vts.length)].text:"(Sense text)";
                ta.innerText=txt.replace(/\{(\w+)\}/g,(_,v)=>this.runtimeVars[v]??'?').replace(/\$(\w+)/g,(_,v)=>this.runtimeVars[v]??('$'+v));
                oc.innerHTML='';
                const avo=n.options.filter((o,i)=>{const k=n.id+'_'+i;if(o.once&&this.visited.has(k))return false;if(o.condition&&!this.evaluate(o.condition))return false;return true;});
                if(avo.length===0&&n.options.length>0)this.showEnd("No hi ha més opcions.");else if(n.options.length===0)this.showEnd("Fi.");else{
                    n.options.forEach((o,i)=>{
                        const k=n.id+'_'+i;if(o.once&&this.visited.has(k))return;if(o.condition&&!this.evaluate(o.condition))return;
                        const b=document.createElement('button');b.className="w-full text-left bg-slate-800/80 hover:bg-slate-700 border border-slate-600 p-3 rounded text-slate-200 hover:text-white transition flex gap-2";b.innerHTML=`<span class="text-yellow-500">➤</span> ${o.text}`;
                        b.onclick=()=>{
                            if(o.once)this.visited.add(k);if(o.effect)this.execute(o.effect);
                            let nid=o.targetNodeId;if(o.altTargetNodeId&&o.targetCondition&&this.evaluate(o.targetCondition))nid=o.altTargetNodeId;
                            if(nid){this.currentId=nid;this.render();}else{pb.style.display='none';document.getElementById('preview-text-container').style.display='none';this.showEnd("Fi.");}
                        };
                        oc.appendChild(b);
                    });
                }
            },
            showEnd(m){const c=document.getElementById('preview-options');c.innerHTML=`<div class="text-center text-yellow-500 text-xl font-bold mb-4 mt-4">${m}</div><div class="flex justify-center gap-4"><button onclick="previewEngine.start(true)" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow"><i class="fa-solid fa-rotate-left"></i> Nova</button><button onclick="previewEngine.start(false)" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded shadow"><i class="fa-solid fa-power-off"></i> Reiniciar</button></div>`;}
        };
        
        // --- IO ---
        const ioSystem = {
            autosave() { localStorage.setItem('adv_editor_data', JSON.stringify(appState)); const ind = document.getElementById('autosave-indicator'); ind.classList.remove('opacity-0'); setTimeout(() => ind.classList.add('opacity-0'), 2000); },
            autoload() { const data = localStorage.getItem('adv_editor_data'); if (data) { try { const p = JSON.parse(data); appState.nodes = p.nodes||[]; appState.characters = p.characters||[]; appState.globalVariables = p.globalVariables||{}; this.migrate(); historySystem.pushState(); } catch(e) { console.error("Autoload error", e); } } },
            migrate() { 
                appState.nodes.forEach(n => { 
                    if (!n.textOptions) { n.textOptions = [{ text: n.text || "", condition: "" }]; delete n.text; } 
                    if (!n.width) n.width = 450; 
                    if(!n.expressionOptions || n.expressionOptions.length === 0) n.expressionOptions=[{expression: "Normal", condition:""}];
                    if(!n.type) n.type = 'normal';
                }); 
                appState.characters.forEach(c=>{ if(!c.expressions) c.expressions=[]; }); 
            },
            exportJSON() { const s=appState.nodes.find(n=>n.id==='node_start')||appState.nodes[0];const cn=s?characterManager.getCharacter(s.characterId).name:"Unknown";const o={id_dialogue:cn,...appState};const u="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(o,null,2));const a=document.createElement('a');a.href=u;a.download=`adventure_${Date.now()}.json`;a.click();},
            loadFile(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        const d = json.appState || json;
                        appState.nodes=d.nodes||[]; appState.characters=d.characters||[]; appState.globalVariables=d.globalVariables||{};
                        this.postLoad();
                    } catch(err) { alert("Error JSON: "+err.message); }
                };
                reader.readAsText(file);
                input.value = '';
            },
            postLoad() { this.migrate(); historySystem.pushState(); characterManager.renderList(); variableManager.renderList(); editor.renderNodes(); editor.zoomToFit(); }
        };

        window.onload = () => { ioSystem.autoload(); characterManager.init(); variableManager.init(); editor.init(); if (appState.nodes.length === 0) editor.addNode(); editor.zoomToFit(); };
    </script>
</body>
</html>
