<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Diàlegs Interactius Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            user-select: none;
        }
        /* --- Canvas & Grid --- */
        #canvas-area {
            background-image: 
                linear-gradient(rgba(229, 231, 235, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(229, 231, 235, 0.5) 1px, transparent 1px);
            background-size: 40px 40px; /* Graella de 40px */
            transform-origin: 0 0;
        }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        
        /* --- Nodes --- */
        .node-card {
            transition: box-shadow 0.2s, border-color 0.2s; 
            position: absolute;
            /* Width & Height set inline by JS */
            z-index: 10;
            display: flex;
            flex-direction: column;
        }
        .node-card:hover {
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            z-index: 20;
        }
        .node-search-highlight {
            ring: 4px solid #facc15;
            transform: scale(1.05);
            z-index: 30;
        }

        /* --- Resize Handle --- */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
            z-index: 50;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            padding-right: 2px;
            padding-bottom: 2px;
        }
        .resize-handle::after {
            content: '';
            width: 0; 
            height: 0; 
            border-bottom: 8px solid #94a3b8;
            border-left: 8px solid transparent;
        }
        .node-card:hover .resize-handle::after {
            border-bottom-color: #3b82f6; /* Blue on hover */
        }

        /* --- Connexions --- */
        .connection-line {
            stroke: #9ca3af;
            stroke-width: 3;
            fill: none;
            pointer-events: none;
            transition: stroke 0.2s;
        }
        .connection-line.dashed { stroke-dasharray: 10, 5; }
        .connection-line.alt { stroke: #a855f7; stroke-dasharray: 5, 2; } 
        .connection-line:hover { stroke: #3b82f6; z-index: 5; pointer-events: stroke;}

        .port-out {
            width: 16px; height: 16px;
            background-color: #64748b;
            border: 3px solid white;
            border-radius: 50%;
            position: absolute;
            right: -9px; top: 50%; transform: translateY(-50%);
            cursor: crosshair; transition: all 0.2s; z-index: 30;
        }
        .port-out:hover { transform: translateY(-50%) scale(1.3); background-color: #3b82f6; }

        /* --- Minimapa --- */
        #minimap-container {
            position: absolute; bottom: 20px; left: 20px;
            width: 240px; height: 160px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden; z-index: 40;
        }
        #minimap-viewport {
            position: absolute;
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            cursor: move;
        }

        /* --- Utilities --- */
        .retro-text { font-family: 'Courier New', Courier, monospace; text-shadow: 2px 2px 0px #000; }
        .thin-scrollbar::-webkit-scrollbar { width: 6px; }
        .thin-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .thin-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
        
        .logic-row { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .logic-row.open { max-height: 300px; }
        
        .code-input { font-family: 'Consolas', 'Monaco', monospace; font-size: 0.75rem; color: #ea580c; }

        /* Dropdown Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            width: 200px;
            z-index: 60;
        }
        .dropdown-menu.show { display: block; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <!-- CAPÇALERA -->
    <header class="bg-slate-800 text-white h-14 px-4 flex justify-between items-center shadow-lg z-50">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-diagram-project text-xl text-blue-400"></i>
            <h1 class="text-lg font-bold tracking-wide">Editor de Diàlegs Pro <span class="text-xs font-normal opacity-50 ml-2">v3.0</span></h1>
        </div>
        
        <div class="flex gap-2 bg-slate-700 p-1 rounded-lg">
            <button onclick="historySystem.undo()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-600 text-slate-300 hover:text-white transition" title="Desfer (Ctrl+Z)"><i class="fa-solid fa-rotate-left"></i></button>
            <button onclick="historySystem.redo()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-600 text-slate-300 hover:text-white transition" title="Refer (Ctrl+Y)"><i class="fa-solid fa-rotate-right"></i></button>
            <div class="w-px bg-slate-500 mx-1 h-6 self-center"></div>
            <div class="flex items-center bg-slate-800 rounded px-2">
                <i class="fa-solid fa-magnifying-glass text-slate-400 text-xs mr-2"></i>
                <input type="text" id="node-search" placeholder="Cercar..." class="bg-transparent border-none text-xs text-white focus:outline-none w-32" oninput="editor.handleSearch(this.value)">
            </div>
        </div>

        <div class="flex gap-2 relative">
            <label class="bg-slate-600 hover:bg-slate-500 px-3 py-1.5 rounded text-sm font-bold transition cursor-pointer flex items-center gap-2">
                <i class="fa-solid fa-upload"></i> Carregar
                <input type="file" class="hidden" onchange="ioSystem.loadJSON(this)">
            </label>
            <button onclick="editor.addNode()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-sm font-bold transition shadow flex items-center gap-2"><i class="fa-solid fa-plus"></i> Node</button>
            <div class="h-6 w-px bg-slate-600 mx-1 self-center"></div>
            <button onclick="editor.togglePreview()" class="bg-green-600 hover:bg-green-500 px-3 py-1.5 rounded text-sm font-bold transition shadow flex items-center gap-2"><i class="fa-solid fa-play"></i> Provar</button>
            
            <!-- BOTÓ RECUPERAT: DESAR JSON -->
            <button onclick="ioSystem.exportJSON()" class="bg-slate-600 hover:bg-slate-500 px-3 py-1.5 rounded text-sm font-bold transition shadow flex items-center gap-2" title="Desar projecte (JSON) per seguir editant"><i class="fa-solid fa-download"></i> JSON</button>
            
            <button onclick="ioSystem.copyTwine()" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded text-sm font-bold transition shadow flex items-center gap-2" title="Copiar codi diàleg"><i class="fa-solid fa-copy"></i> Copiar per Twine</button>
            
            <!-- Botó Menú Configuració -->
            <div class="relative">
                <button onclick="ui.toggleConfigMenu()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-sm font-bold transition flex items-center gap-2" title="Configuració Twine"><i class="fa-solid fa-gear"></i></button>
                <div id="config-menu" class="dropdown-menu text-slate-800 p-2">
                    <div class="text-xs font-bold text-gray-400 uppercase mb-2 px-2">Recursos Twine</div>
                    <button onclick="ioSystem.copyEngineJS()" class="w-full text-left px-2 py-2 text-sm hover:bg-blue-50 rounded flex items-center gap-2"><i class="fa-brands fa-js text-yellow-500"></i> Copiar Motor JS</button>
                    <button onclick="ioSystem.copyEngineCSS()" class="w-full text-left px-2 py-2 text-sm hover:bg-blue-50 rounded flex items-center gap-2"><i class="fa-brands fa-css3 text-blue-500"></i> Copiar Estils CSS</button>
                    <button onclick="ioSystem.exportJSON()" class="w-full text-left px-2 py-2 text-sm hover:bg-blue-50 rounded flex items-center gap-2 border-t mt-1"><i class="fa-solid fa-download text-gray-500"></i> Descarregar JSON</button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- BARRA LATERAL -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col z-40 shadow-md relative">
            <div class="flex border-b border-gray-200">
                <button onclick="ui.switchTab('chars')" id="tab-chars" class="flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50">Personatges</button>
                <button onclick="ui.switchTab('vars')" id="tab-vars" class="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-gray-700">Variables</button>
            </div>
            <div id="panel-chars" class="flex-1 flex flex-col overflow-hidden">
                <div class="p-3 border-b bg-gray-50"><button onclick="characterManager.addCharacter()" class="w-full bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded text-sm hover:bg-gray-50 transition flex items-center justify-center gap-2 shadow-sm"><i class="fa-solid fa-user-plus"></i> Nou Personatge</button></div>
                <div id="character-list" class="flex-1 overflow-y-auto p-3 space-y-3 thin-scrollbar"></div>
            </div>
            <div id="panel-vars" class="flex-1 flex flex-col overflow-hidden hidden">
                <div class="p-3 border-b bg-gray-50">
                    <div class="flex gap-2 mb-2"><input type="text" id="new-var-name" placeholder="Nom (ex: or)" class="flex-1 border rounded px-2 py-1 text-sm code-input text-black"><select id="new-var-type" class="border rounded text-sm bg-white"><option value="number">Num</option><option value="boolean">Bool</option><option value="string">Text</option></select></div>
                    <div class="flex gap-2"><input type="text" id="new-var-val" placeholder="Valor inicial" class="flex-1 border rounded px-2 py-1 text-sm"><button onclick="variableManager.addVariable()" class="bg-green-600 text-white px-3 rounded hover:bg-green-500"><i class="fa-solid fa-plus"></i></button></div>
                </div>
                <div id="variable-list" class="flex-1 overflow-y-auto p-3 space-y-2 thin-scrollbar bg-slate-50"></div>
            </div>
        </aside>

        <!-- WORKSPACE -->
        <main class="flex-1 relative overflow-hidden bg-gray-100" id="workspace-container">
            <div id="canvas-area" class="absolute w-[8000px] h-[8000px] cursor-grab" style="top: 0px; left: 0px; transform: translate(-2000px, -2000px) scale(1);">
                <svg id="connections-layer" class="absolute top-0 left-0 w-full h-full z-0 pointer-events-none overflow-visible"><path id="temp-connection" class="connection-line-active hidden" d=""></path></svg>
            </div>
            <div id="minimap-container"><canvas id="minimap-canvas" class="w-full h-full"></canvas><div id="minimap-viewport"></div></div>
            <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-30 pointer-events-none"><div class="bg-black/70 text-white px-3 py-1 rounded-full text-xs backdrop-blur-md shadow font-mono"><span id="zoom-level">100%</span></div></div>
            <div class="absolute bottom-4 right-4 flex flex-col gap-2 z-30"><button onclick="editor.resetView()" class="bg-white shadow-lg p-3 rounded-full hover:bg-gray-100 text-gray-600 transition pointer-events-auto" title="Centrar Vista"><i class="fa-solid fa-compress"></i></button></div>
            <div id="autosave-indicator" class="absolute top-4 right-4 bg-white/80 backdrop-blur text-gray-500 text-xs px-2 py-1 rounded shadow opacity-0 transition-opacity pointer-events-none"><i class="fa-solid fa-floppy-disk mr-1"></i> Guardat</div>
        </main>
    </div>

    <!-- MODALS -->
    <div id="preview-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="relative w-full max-w-6xl aspect-video bg-slate-900 rounded-xl shadow-2xl border-4 border-slate-700 overflow-hidden flex flex-col">
            <div id="preview-game-area" class="flex-1 relative flex items-center justify-center bg-cover bg-center transition-all duration-500">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-slate-900/50"></div>
                <i id="preview-default-bg" class="fa-solid fa-gamepad text-slate-700 text-9xl opacity-20 absolute"></i>
                <button onclick="editor.togglePreview()" class="absolute top-4 right-4 text-white/80 hover:text-white hover:bg-red-600/80 bg-black/50 px-4 py-2 rounded-full transition z-50"><i class="fa-solid fa-times mr-2"></i> Tancar</button>
                <div class="absolute top-4 left-4 bg-black/60 text-green-400 p-2 rounded text-xs font-mono pointer-events-none"><div class="font-bold border-b border-gray-600 mb-1">ESTAT (Variables)</div><div id="preview-debug-vars"></div></div>
            </div>
            <div class="h-auto min-h-[35%] max-h-[50%] bg-slate-900 border-t-4 border-slate-700 p-6 flex gap-8 shrink-0 relative z-10">
                <div class="relative shrink-0"><div id="preview-portrait" class="w-32 h-32 rounded-xl shadow-lg flex items-center justify-center text-5xl font-bold text-white border-4 border-slate-600 bg-slate-800 overflow-hidden -mt-12 transition-all duration-500"><span id="preview-portrait-initial">?</span><img id="preview-portrait-img" src="" class="w-full h-full object-cover hidden"></div></div>
                <div class="flex-1 flex flex-col min-h-0">
                    <div id="preview-text-container" class="mb-4 overflow-y-auto thin-scrollbar pr-2 flex-1 transition-opacity duration-500"><h3 id="preview-char-name" class="text-yellow-400 font-bold text-xl mb-1 retro-text tracking-wide">Personatge</h3><p id="preview-text" class="text-slate-200 text-lg leading-relaxed font-light font-sans">...</p></div>
                    <div id="preview-options" class="grid grid-cols-1 gap-2 w-full mt-auto pt-2 border-t border-slate-800 max-h-[140px] overflow-y-auto thin-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-black/50 z-[150] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><i class="fa-solid fa-exclamation-triangle text-red-600 text-xl"></i></div>
                <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-2">Esborrar?</h3><p id="modal-desc" class="text-sm text-gray-500 mb-6">Estàs segur?</p>
                <div class="flex justify-center gap-3"><button onclick="ui.closeDeleteModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium rounded-md">Cancel·lar</button><button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-md shadow">Sí, esborrar</button></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS PLANTILLES TWINE ---
        // Motor JS Actualitzat amb Bloqueig de Mapa (Vanilla JS per robustesa)
        const TWINE_ENGINE_JS = `window.AdventureEngine = (function() {
    let state = { nodes: [], characters: [], vars: {}, visited: new Set(), currentNodeId: null, containerId: 'dialogue-container' };

    function getCharacter(id) { return state.characters.find(c => c.id === id) || { name: '?', color: '#ccc' }; }
    function evaluate(code) { if (!code || !code.trim()) return true; try { const keys = Object.keys(state.vars); const values = Object.values(state.vars); const fn = new Function(...keys, \`return \${code};\`); return fn(...values); } catch (e) { console.error("Error condició:", code, e); return false; } }
    function execute(code) { if (!code || !code.trim()) return; try { const keys = Object.keys(state.vars); const values = Object.values(state.vars); const fn = new Function(...keys, \`\${code}; return {\${keys.join(',')}};\`); const newVars = fn(...values); state.vars = { ...state.vars, ...newVars }; } catch (e) { console.error("Error efecte:", code, e); } }

    function renderNode() {
        const container = document.getElementById(state.containerId);
        if (!container) return;
        const node = state.nodes.find(n => n.id === state.currentNodeId);
        if (!node) { container.innerHTML = ""; toggleActive(false); return; }

        const char = getCharacter(node.characterId);
        const textOpts = Array.isArray(node.textOptions) ? node.textOptions : [{ text: node.text || "", condition: "" }];
        let validTexts = textOpts.filter(t => evaluate(t.condition));
        if (validTexts.some(t => t.condition && t.condition.trim() !== "")) validTexts = validTexts.filter(t => t.condition && t.condition.trim() !== "");
        const chosenTextObj = validTexts.length > 0 ? validTexts[Math.floor(Math.random() * validTexts.length)] : { text: "..." };
        let finalText = chosenTextObj.text.replace(/\\{(\\w+)\\}/g, (_, v) => state.vars[v] ?? '?').replace(/\\$(\\w+)/g, (_, v) => state.vars[v] ?? ('$' + v));

        let html = \`<div class="adv-dialogue-box" style="border-top-color: \${char.color}"><div class="adv-portrait" style="background-color: \${char.color}">\${char.avatarUrl ? \`<img src="\${char.avatarUrl}">\` : \`<span>\${char.name[0]}</span>\`}</div><div class="adv-content"><h3 class="adv-name" style="color: \${char.color}">\${char.name}</h3><p class="adv-text">\${finalText}</p><div class="adv-options">\`;

        const availableOptions = node.options.filter((opt, idx) => {
            const visitedKey = node.id + '_' + idx;
            if (opt.once && state.visited.has(visitedKey)) return false;
            if (opt.condition && !evaluate(opt.condition)) return false;
            return true;
        });

        if (availableOptions.length === 0 && node.options.length > 0) { html += \`<div class="adv-msg">No hi ha més opcions.</div>\`; }
        else if (node.options.length === 0) { html += \`<div class="adv-msg">Fi del diàleg.</div>\`; }
        else { availableOptions.forEach((opt) => { const idx = node.options.indexOf(opt); html += \`<button onclick="AdventureEngine.selectOption('\${node.id}', \${idx})">\${opt.text}</button>\`; }); }
        html += \`</div></div></div>\`; container.innerHTML = html;
    }

    function toggleActive(isActive) {
        // Usem documentElement (html) directament per assegurar compatibilitat sense jQuery
        if(isActive) document.documentElement.classList.add('adv-dialogue-active');
        else document.documentElement.classList.remove('adv-dialogue-active');
    }

    return {
        init: function(jsonData, containerId = 'dialogue-container') {
            try {
                const data = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
                const coreData = data.appState || data; 
                state.nodes = coreData.nodes || []; state.characters = coreData.characters || []; state.vars = coreData.globalVariables || {}; state.visited = new Set(); state.containerId = containerId;
                if (state.nodes.length === 0) return;
                state.currentNodeId = state.nodes[0].id;
                toggleActive(true); // BLOQUEJA EL MAPA IMMEDIATAMENT
                setTimeout(renderNode, 10);
            } catch (e) { console.error("Init Error:", e); }
        },
        selectOption: function(nodeId, optionIndex) {
            const node = state.nodes.find(n => n.id === nodeId); const opt = node.options[optionIndex];
            if (opt.once) state.visited.add(nodeId + '_' + optionIndex);
            if (opt.effect) execute(opt.effect);
            let nextId = opt.targetNodeId;
            if (opt.altTargetNodeId && opt.targetCondition && evaluate(opt.targetCondition)) nextId = opt.altTargetNodeId;
            
            if (nextId) { state.currentNodeId = nextId; renderNode(); } 
            else { 
                const container = document.getElementById(state.containerId); 
                container.innerHTML = ""; 
                if (window.jQuery) jQuery(container).hide(); else container.style.display = 'none';
                toggleActive(false); // DESBLOQUEJA EL MAPA
            }
        }
    };
})();`;

        // CSS Actualitzat amb Bloqueig Específic i Robust
        const TWINE_ENGINE_CSS = `#dialogue-container { max-width: 800px; margin: 0 auto; font-family: sans-serif; color: #fff; pointer-events: auto !important; position: relative; z-index: 10000; }
.adv-dialogue-box { background-color: #1e293b; border: 2px solid #475569; border-top-width: 6px; border-radius: 12px; padding: 20px; display: flex; gap: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); }
.adv-portrait { width: 80px; height: 80px; flex-shrink: 0; border-radius: 8px; border: 3px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 32px; font-weight: bold; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
.adv-portrait img { width: 100%; height: 100%; object-fit: cover; }
.adv-content { flex: 1; display: flex; flex-direction: column; }
.adv-name { margin: 0 0 10px 0; font-size: 1.1em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
.adv-text { margin: 0 0 20px 0; font-size: 1.1em; line-height: 1.5; color: #e2e8f0; }
.adv-options { display: flex; flex-direction: column; gap: 8px; }
.adv-options button { background-color: #334155; border: 1px solid #475569; color: #f1f5f9; padding: 12px 16px; text-align: left; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 0.95em; }
.adv-options button:hover { background-color: #475569; border-color: #94a3b8; transform: translateX(5px); }
.adv-msg { font-style: italic; color: #94a3b8; text-align: center; margin-top: 10px; }

/* BLOQUEIG MAPA QUAN HI HA DIÀLEG */
/* Quan la classe adv-dialogue-active està al html, desactivem el punter als elements del mapa */
html.adv-dialogue-active .twine-image-wrapper img,
html.adv-dialogue-active map,
html.adv-dialogue-active area,
html.adv-dialogue-active .hotspot-item {
    pointer-events: none !important;
    cursor: default !important;
}`;

        // --- ESTAT DE L'APLICACIÓ ---
        const appState = {
            characters: [{ id: 'char_1', name: 'Personatge', color: '#3b82f6', avatarUrl: '' }],
            globalVariables: {},
            nodes: [{
                id: 'node_start', title: "Inici", characterId: 'char_1', x: 2200, y: 2200, width: 450, height: null, bgImage: '',
                textOptions: [ { text: "", condition: "" } ],
                options: []
            }],
            scale: 1, panOffset: { x: -2000, y: -2000 },
            interactionMode: 'default', draggingNodeId: null, resizingNodeId: null, dragOffset: { x: 0, y: 0 }, connectionStart: { nodeId: null, optionIndex: null, x: 0, y: 0 }
        };

        // --- UNDO/REDO ---
        const historySystem = {
            past: [], future: [], maxDepth: 50, ignoreChange: false,
            pushState() {
                if (this.ignoreChange) return;
                const snap = JSON.stringify({ characters: appState.characters, nodes: appState.nodes, globalVariables: appState.globalVariables });
                if (this.past.length > 0 && this.past[this.past.length - 1] === snap) return;
                this.past.push(snap); if (this.past.length > this.maxDepth) this.past.shift(); this.future = []; ioSystem.autosave();
            },
            undo() { if (this.past.length === 0) return; this.future.push(JSON.stringify({ characters: appState.characters, nodes: appState.nodes, globalVariables: appState.globalVariables })); this.loadState(JSON.parse(this.past.pop())); },
            redo() { if (this.future.length === 0) return; this.past.push(JSON.stringify({ characters: appState.characters, nodes: appState.nodes, globalVariables: appState.globalVariables })); this.loadState(JSON.parse(this.future.pop())); },
            loadState(state) { this.ignoreChange = true; appState.characters = state.characters; appState.nodes = state.nodes; appState.globalVariables = state.globalVariables; characterManager.renderList(); variableManager.renderList(); editor.renderNodes(); this.ignoreChange = false; }
        };

        // --- UI HELPERS ---
        const ui = {
            switchTab(tab) { document.getElementById('panel-chars').classList.toggle('hidden', tab !== 'chars'); document.getElementById('panel-vars').classList.toggle('hidden', tab !== 'vars'); document.getElementById('tab-chars').className = tab === 'chars' ? "flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50" : "flex-1 py-3 text-sm font-bold text-gray-500 hover:text-gray-700"; document.getElementById('tab-vars').className = tab === 'vars' ? "flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50" : "flex-1 py-3 text-sm font-bold text-gray-500 hover:text-gray-700"; },
            itemToDeleteId: null, itemToDeleteType: null,
            showDeleteModal(id, type) {
                this.itemToDeleteId = id; this.itemToDeleteType = type;
                const modal = document.getElementById('delete-modal');
                document.getElementById('modal-title').innerText = type === 'node' ? "Esborrar Node?" : type === 'character' ? "Esborrar Personatge?" : "Esborrar Variable?";
                document.getElementById('modal-desc').innerText = type === 'node' ? "Es perdran connexions." : type === 'character' ? "Reassignat al per defecte." : "Es perdrà valor i lògica.";
                modal.classList.remove('hidden');
                document.getElementById('confirm-delete-btn').onclick = () => { historySystem.pushState(); if(type==='node') editor.deleteNodeConfirmed(this.itemToDeleteId); else if(type==='character') characterManager.deleteCharacterConfirmed(this.itemToDeleteId); else variableManager.deleteVariableConfirmed(this.itemToDeleteId); this.closeDeleteModal(); };
            },
            closeDeleteModal() { document.getElementById('delete-modal').classList.add('hidden'); },
            toggleLogic(btn) { btn.closest('.option-row').querySelector('.logic-row').classList.toggle('open'); btn.classList.toggle('text-blue-600'); },
            toggleConfigMenu() {
                document.getElementById('config-menu').classList.toggle('show');
            }
        };

        // Click outside closes menu
        window.onclick = function(event) {
            if (!event.target.matches('.fa-gear') && !event.target.closest('button[onclick*="toggleConfigMenu"]')) {
                var dropdowns = document.getElementsByClassName("dropdown-menu");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // --- MANAGERS ---
        const variableManager = {
            init() { this.renderList(); },
            addVariable() {
                const name = document.getElementById('new-var-name').value.trim().replace(/[^a-zA-Z0-9_$]/g, '_').replace(/^\d/, '_$&');
                if (!name || appState.globalVariables.hasOwnProperty(name)) return alert("Nom invàlid/existent");
                let val = document.getElementById('new-var-val').value, type = document.getElementById('new-var-type').value;
                if (type === 'number') val = Number(val) || 0; if (type === 'boolean') val = (val === 'true');
                historySystem.pushState(); appState.globalVariables[name] = val; this.renderList();
                document.getElementById('new-var-name').value = ''; document.getElementById('new-var-val').value = '';
            },
            updateVariable(key, val) { historySystem.pushState(); const cur = appState.globalVariables[key]; appState.globalVariables[key] = typeof cur === 'number' ? Number(val) : typeof cur === 'boolean' ? (val === 'true') : val; },
            deleteVariable(key) { ui.showDeleteModal(key, 'variable'); },
            deleteVariableConfirmed(key) { delete appState.globalVariables[key]; this.renderList(); },
            renderList() {
                const c = document.getElementById('variable-list'); c.innerHTML = '';
                for (const [k, v] of Object.entries(appState.globalVariables)) {
                    const type = typeof v, input = type === 'boolean' ? `<select onchange="variableManager.updateVariable('${k}', this.value)" class="text-xs border rounded p-1 bg-white"><option value="true" ${v?'selected':''}>true</option><option value="false" ${!v?'selected':''}>false</option></select>` : `<input type="${type==='number'?'number':'text'}" value="${v}" onchange="variableManager.updateVariable('${k}', this.value)" class="w-16 text-xs border rounded p-1 text-right code-input text-blue-600">`;
                    const div = document.createElement('div'); div.className = "flex items-center justify-between bg-white p-2 rounded border border-gray-200 shadow-sm";
                    div.innerHTML = `<div class="flex items-center gap-2 overflow-hidden"><span class="text-xs font-mono font-bold text-slate-700 truncate" title="${k}">${k}</span><span class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">${type.substr(0,3)}</span></div><div class="flex items-center gap-2">${input}<button onclick="variableManager.deleteVariable('${k}')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button></div>`;
                    c.appendChild(div);
                }
            }
        };

        const characterManager = {
            init() { this.renderList(); },
            addCharacter() { historySystem.pushState(); appState.characters.push({ id: 'char_' + Date.now(), name: 'Nou', color: '#8b5cf6', avatarUrl: '' }); this.renderList(); },
            updateCharacter(id, f, v) { const c = appState.characters.find(x => x.id === id); if(c && c[f] !== v) { c[f] = v; if(f === 'color' || f === 'name') editor.renderNodes(); } },
            saveState() { historySystem.pushState(); },
            deleteCharacter(id) { if (appState.characters.length <= 1) return alert("Mínim 1."); ui.showDeleteModal(id, 'character'); },
            deleteCharacterConfirmed(id) { appState.characters = appState.characters.filter(c => c.id !== id); const fallback = appState.characters[0].id; appState.nodes.forEach(n => { if (n.characterId === id) n.characterId = fallback; }); this.renderList(); editor.renderNodes(); },
            getCharacter(id) { return appState.characters.find(c => c.id === id) || appState.characters[0]; },
            draggedIndex: null,
            handleDragStart(e, i) { this.draggedIndex = i; e.dataTransfer.effectAllowed = "move"; },
            handleDragOver(e) { e.preventDefault(); },
            handleDrop(e, t) { e.stopPropagation(); if (this.draggedIndex !== null && this.draggedIndex !== t) { historySystem.pushState(); const it = appState.characters.splice(this.draggedIndex, 1)[0]; appState.characters.splice(t, 0, it); this.renderList(); } },
            renderList() {
                const c = document.getElementById('character-list'); c.innerHTML = '';
                appState.characters.forEach((char, i) => {
                    const d = document.createElement('div'); d.className = "draggable-item bg-white p-2 rounded border border-gray-200 shadow-sm group"; d.draggable = true;
                    d.ondragstart = (e) => this.handleDragStart(e, i); d.ondragover = this.handleDragOver; d.ondrop = (e) => this.handleDrop(e, i);
                    d.innerHTML = `<div class="flex items-center gap-2 mb-2"><i class="fa-solid fa-grip-vertical text-gray-300 cursor-move hover:text-gray-500"></i><input type="color" value="${char.color}" onchange="characterManager.updateCharacter('${char.id}', 'color', this.value); characterManager.saveState()" class="w-6 h-6 rounded cursor-pointer border-none p-0"><input type="text" value="${char.name}" onchange="characterManager.updateCharacter('${char.id}', 'name', this.value); characterManager.saveState()" class="flex-1 text-sm font-bold border-none focus:ring-0 p-0" placeholder="Nom"><button onclick="characterManager.deleteCharacter('${char.id}')" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div><div class="flex items-center gap-2 bg-gray-50 p-1 rounded"><i class="fa-regular fa-image text-gray-400 text-xs"></i><input type="text" value="${char.avatarUrl || ''}" onchange="characterManager.updateCharacter('${char.id}', 'avatarUrl', this.value); characterManager.saveState()" class="flex-1 bg-transparent text-[10px] border-none focus:ring-0 p-0 text-gray-500" placeholder="URL Imatge"></div>`;
                    c.appendChild(d);
                });
            }
        };

        // --- EDITOR VISUAL ---
        const editor = {
            init() { this.renderNodes(); this.setupCanvasEvents(); this.applyTransform(); this.renderMinimap(); document.addEventListener('keydown', (e) => { if((e.ctrlKey||e.metaKey) && e.key==='z') {e.preventDefault(); historySystem.undo();} if((e.ctrlKey||e.metaKey) && e.key==='y') {e.preventDefault(); historySystem.redo();} }); },
            addNode(x, y) {
                if (x === undefined) { const c = document.getElementById('workspace-container'); x = (c.clientWidth/2 - appState.panOffset.x)/appState.scale; y = (c.clientHeight/2 - appState.panOffset.y)/appState.scale; }
                historySystem.pushState();
                const id = 'node_' + Date.now();
                appState.nodes.push({ id, title: "Nou Node", characterId: appState.characters[0].id, textOptions: [{text:"", condition:""}], x, y, width: 450, height: null, bgImage: '', options: [] });
                this.renderNodes(); return id;
            },
            deleteNodeConfirmed(id) {
                appState.nodes = appState.nodes.filter(n => n.id !== id);
                appState.nodes.forEach(n => { n.options.forEach(opt => { if (opt.targetNodeId === id) opt.targetNodeId = null; if (opt.altTargetNodeId === id) opt.altTargetNodeId = null; }); });
                this.renderNodes();
            },
            updateNode(id, f, v) { const n = appState.nodes.find(x => x.id === id); if (n) { n[f] = v; if (f === 'title') this.updateTitleRefs(id, v); if (f === 'characterId') this.renderNodes(); } },
            saveState() { historySystem.pushState(); },
            updateTitleRefs(id, t) { document.querySelectorAll(`.target-opt-${id}`).forEach(e => e.innerText = t || 'Sense Títol'); },
            
            // Text Variations
            addTextVar(nid) { const n = appState.nodes.find(x => x.id === nid); historySystem.pushState(); n.textOptions.push({text:"", condition:""}); this.renderNodes(); },
            deleteTextVar(nid, idx) { const n = appState.nodes.find(x => x.id === nid); if(n.textOptions.length <= 1) return; historySystem.pushState(); n.textOptions.splice(idx, 1); this.renderNodes(); },
            updateTextVar(nid, idx, f, v) { const n = appState.nodes.find(x => x.id === nid); n.textOptions[idx][f] = v; },

            // Options
            addOption(id) { const n = appState.nodes.find(x => x.id === id); historySystem.pushState(); n.options.push({ text: "Opció...", targetNodeId: null, altTargetNodeId: null, targetCondition: "", once: false, condition: "", effect: "" }); this.renderNodes(); },
            deleteOption(id, idx) { const n = appState.nodes.find(x => x.id === id); historySystem.pushState(); n.options.splice(idx, 1); this.renderNodes(); },
            updateOption(id, idx, f, v) { const n = appState.nodes.find(x => x.id === id); n.options[idx][f] = v; if (['targetNodeId','altTargetNodeId','once'].includes(f)) this.drawConnections(); },
            handleTargetSelect(nid, idx, val, alt=false) { historySystem.pushState(); const f = alt ? 'altTargetNodeId' : 'targetNodeId'; if (val === 'NEW') { const p = appState.nodes.find(x => x.id === nid); const nid2 = this.addNode(p.x + 450, p.y + (idx * 100)); this.updateOption(nid, idx, f, nid2); } else this.updateOption(nid, idx, f, val || null); },
            handleSearch(q) { q = q.toLowerCase(); document.querySelectorAll('.node-card').forEach(el => { if(!q){el.classList.remove('node-search-highlight','opacity-25');return;} const n = appState.nodes.find(x=>x.id===el.id); const match = n.title.toLowerCase().includes(q) || n.textOptions.some(t=>t.text.toLowerCase().includes(q)); if(match){el.classList.add('node-search-highlight');el.classList.remove('opacity-25');}else{el.classList.remove('node-search-highlight');el.classList.add('opacity-25');} }); },
            
            renderNodes() {
                const canvas = document.getElementById('canvas-area'); document.querySelectorAll('.node-card').forEach(e => e.remove());
                let optsHtml = `<option value="">(Fi / Res)</option>`; appState.nodes.forEach(n => optsHtml += `<option value="${n.id}" class="target-opt-${n.id}">${n.title || 'Sense Títol'}</option>`);
                const newOpt = `<option value="NEW" class="text-blue-600 font-bold">[+ Nou Node]</option>`;

                appState.nodes.forEach(node => {
                    const char = characterManager.getCharacter(node.characterId);
                    const isEnd = node.options.length === 0;
                    const div = document.createElement('div'); div.id = node.id;
                    div.className = `node-card bg-white rounded-lg shadow-lg flex flex-col border-2 ${isEnd ? 'border-red-400' : 'border-slate-200'}`;
                    
                    // APPLY CUSTOM SIZE
                    div.style.left = node.x + 'px'; div.style.top = node.y + 'px';
                    div.style.width = (node.width || 450) + 'px';
                    if (node.height) div.style.height = node.height + 'px';

                    // Text Variations
                    const textVarsHtml = node.textOptions.map((t, i) => `
                        <div class="flex flex-col gap-1 mb-2 bg-yellow-50 p-1.5 rounded border border-yellow-200">
                            <div class="flex gap-1">
                                <span class="text-[10px] font-bold text-yellow-600 mt-1">TXT</span>
                                <textarea onchange="editor.updateTextVar('${node.id}', ${i}, 'text', this.value); editor.saveState()" class="w-full p-1 text-xs border rounded resize-y h-12 focus:outline-none focus:border-yellow-400" placeholder="Text...">${t.text}</textarea>
                                <button onclick="editor.deleteTextVar('${node.id}', ${i})" class="text-gray-300 hover:text-red-500 self-start ${node.textOptions.length===1?'hidden':''}"><i class="fa-solid fa-times"></i></button>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-gray-400">IF</span>
                                <input type="text" value="${t.condition || ''}" onchange="editor.updateTextVar('${node.id}', ${i}, 'condition', this.value); editor.saveState()" class="flex-1 bg-white border rounded px-1 py-0.5 text-[10px] code-input" placeholder="Condició (opcional)">
                            </div>
                        </div>
                    `).join('');

                    // Options
                    const optionsContent = node.options.map((opt, i) => `
                        <div class="relative group option-row mb-2 p-2 bg-slate-50 rounded border border-slate-200 transition hover:border-blue-300" data-idx="${i}">
                            <div class="flex items-center gap-2 mb-1">
                                <input type="checkbox" ${opt.once ? 'checked' : ''} onchange="editor.updateOption('${node.id}', ${i}, 'once', this.checked); editor.saveState()" class="accent-blue-600" title="Només un cop">
                                <input type="text" value="${opt.text}" onchange="editor.updateOption('${node.id}', ${i}, 'text', this.value); editor.saveState()" class="flex-1 text-sm bg-transparent border-b border-transparent focus:border-blue-400 outline-none" placeholder="Text opció...">
                                <button onclick="ui.toggleLogic(this)" class="text-gray-400 hover:text-blue-600 transition" title="Lògica"><i class="fa-solid fa-code"></i></button>
                                <button onclick="editor.deleteOption('${node.id}', ${i})" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            <div class="logic-row bg-slate-100 rounded px-2 text-xs space-y-2 border-l-2 border-orange-400">
                                <div class="pt-2 font-bold text-gray-400 border-b pb-1">VISIBILITAT & EFECTES</div>
                                <div class="flex items-center gap-2"><span class="font-bold text-gray-500 w-8">IF</span><input type="text" value="${opt.condition || ''}" onchange="editor.updateOption('${node.id}', ${i}, 'condition', this.value); editor.saveState()" class="flex-1 bg-white border rounded px-1 code-input" placeholder="ex: or >= 10"></div>
                                <div class="flex items-center gap-2"><span class="font-bold text-gray-500 w-8">DO</span><input type="text" value="${opt.effect || ''}" onchange="editor.updateOption('${node.id}', ${i}, 'effect', this.value); editor.saveState()" class="flex-1 bg-white border rounded px-1 code-input" placeholder="ex: or -= 10"></div>
                                <div class="pt-2 font-bold text-purple-400 border-b pb-1">DESVIACIÓ CONDICIONAL</div>
                                <div class="flex items-center gap-2"><span class="font-bold text-gray-500 w-8">ELSE IF</span><input type="text" value="${opt.targetCondition || ''}" onchange="editor.updateOption('${node.id}', ${i}, 'targetCondition', this.value); editor.saveState()" class="flex-1 bg-white border rounded px-1 code-input" placeholder="ex: or < 5"></div>
                                <div class="flex items-center gap-2 pb-2"><span class="font-bold text-gray-500 w-8">GOTO</span><select onchange="editor.handleTargetSelect('${node.id}', ${i}, this.value, true)" class="flex-1 bg-white border rounded px-1 text-[10px]">${optsHtml.replace(`value="${opt.altTargetNodeId}"`, `value="${opt.altTargetNodeId}" selected`)}<option disabled>────────</option> ${newOpt}</select></div>
                            </div>
                            <div class="mt-1 flex items-center gap-1"><i class="fa-solid fa-share-nodes text-gray-300 text-xs"></i><select onchange="editor.handleTargetSelect('${node.id}', ${i}, this.value)" class="w-full text-xs bg-transparent outline-none text-slate-600 cursor-pointer hover:text-blue-600">${optsHtml.replace(`value="${opt.targetNodeId}"`, `value="${opt.targetNodeId}" selected`)}<option disabled>────────</option> ${newOpt}</select></div>
                            <div class="port-out" onmousedown="editor.startConnection(event, '${node.id}', ${i})"></div>
                        </div>
                    `).join('');

                    let charOpts = ''; appState.characters.forEach(c => charOpts += `<option value="${c.id}" ${c.id === node.characterId ? 'selected' : ''}>${c.name}</option>`);
                    div.innerHTML = `
                        <div class="drag-handle p-2 border-b flex items-center gap-2 rounded-t-md cursor-grab active:cursor-grabbing text-white" style="background-color: ${char.color}">
                            <i class="fa-solid ${isEnd ? 'fa-flag-checkered' : 'fa-comment-dots'} opacity-75"></i>
                            <input type="text" value="${node.title}" onchange="editor.updateNode('${node.id}', 'title', this.value); editor.saveState()" class="flex-1 bg-transparent font-bold text-sm focus:bg-black/20 rounded px-1 outline-none placeholder-white/50" placeholder="Títol">
                            <button onclick="ui.showDeleteModal('${node.id}', 'node')" class="opacity-50 hover:opacity-100"><i class="fa-solid fa-times"></i></button>
                        </div>
                        
                        <!-- NEW BODY STRUCTURE -->
                        <div class="p-3 flex flex-col flex-1 min-h-0 gap-3">
                            <div class="flex gap-2 shrink-0"><div class="w-8 h-8 rounded shadow flex items-center justify-center text-white font-bold text-xs shrink-0 overflow-hidden" style="background-color: ${char.color}">${char.avatarUrl ? `<img src="${char.avatarUrl}" class="w-full h-full object-cover">` : char.name[0]}</div><div class="flex-1 space-y-1"><select onchange="editor.updateNode('${node.id}', 'characterId', this.value)" class="w-full text-xs border rounded p-1 bg-gray-50">${charOpts}</select><input type="text" value="${node.bgImage || ''}" onchange="editor.updateNode('${node.id}', 'bgImage', this.value); editor.saveState()" class="w-full text-[10px] border rounded p-1 text-gray-500" placeholder="URL Fons (Opcional)"></div></div>
                            
                            <!-- Text Section (Adaptable) -->
                            <!-- Canviat: shrink-0 i max-h-[50%] en lloc de flex-[1.5]. Així no creix buit, però fa scroll si n'hi ha massa. -->
                            <div class="flex flex-col min-h-[80px] shrink-0 max-h-[50%]"> 
                                <div class="flex justify-between items-center mb-1 shrink-0"><span class="text-xs font-bold text-gray-400 uppercase">Variacions de Text</span><button onclick="editor.addTextVar('${node.id}')" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 rounded hover:bg-yellow-200"><i class="fa-solid fa-plus"></i></button></div>
                                <div class="overflow-y-auto thin-scrollbar pr-1 h-full">${textVarsHtml}</div>
                            </div>

                            <!-- Answers Section (Fills remaining space) -->
                            <!-- Canviat: flex-1 perquè ocupi tot l'espai restant -->
                            <div class="flex flex-col min-h-[80px] border-t pt-2 flex-1"> 
                                <div class="flex justify-between items-center mb-2 shrink-0"><span class="text-xs font-bold text-gray-400 uppercase">Respostes</span><button onclick="editor.addOption('${node.id}')" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 px-2 py-1 rounded font-medium"><i class="fa-solid fa-plus"></i></button></div>
                                <div class="overflow-y-auto thin-scrollbar h-full -mr-1 pr-1">${optionsContent}</div>
                            </div>
                        </div>
                        
                        <!-- Resize Handle -->
                        <div class="resize-handle" onmousedown="editor.startResize(event, '${node.id}')"></div>
                    `;
                    div.querySelector('.drag-handle').onmousedown = (e) => { if(e.target.tagName === 'INPUT') return; e.stopPropagation(); appState.interactionMode = 'dragging_node'; appState.draggingNodeId = node.id; const rect = document.getElementById('workspace-container').getBoundingClientRect(); const screenX = (node.x * appState.scale) + appState.panOffset.x; const screenY = (node.y * appState.scale) + appState.panOffset.y; appState.dragOffset = { x: (e.clientX - rect.left) - screenX, y: (e.clientY - rect.top) - screenY }; div.style.zIndex = 50; };
                    canvas.appendChild(div);
                });
                this.drawConnections(); this.renderMinimap();
            },
            startResize(e, nodeId) {
                e.stopPropagation();
                appState.interactionMode = 'resizing_node';
                appState.resizingNodeId = nodeId;
                const node = appState.nodes.find(n => n.id === nodeId);
                appState.resizeStart = { x: e.clientX, y: e.clientY };
                appState.resizeInitialDim = { w: node.width || 450, h: node.height || 0 }; 
                if (!node.height) {
                    const el = document.getElementById(nodeId);
                    appState.resizeInitialDim.h = el.clientHeight;
                } else {
                    appState.resizeInitialDim.h = node.height;
                }
            },
            drawConnections() {
                const svg = document.getElementById('connections-layer'); Array.from(svg.children).forEach(c => { if (c.id !== 'temp-connection') c.remove() });
                appState.nodes.forEach(node => {
                    const nodeEl = document.getElementById(node.id); if (!nodeEl) return;
                    node.options.forEach((opt, i) => {
                        const rows = nodeEl.querySelectorAll('.option-row'); if (!rows[i]) return;
                        const port = rows[i].querySelector('.port-out'); const portRect = port.getBoundingClientRect(); const nodeRect = nodeEl.getBoundingClientRect();
                        const relX = (portRect.left - nodeRect.left) / appState.scale; const relY = (portRect.top - nodeRect.top) / appState.scale;
                        const x1 = node.x + relX + 8; const y1 = node.y + relY + 8;
                        const drawLine = (tid, alt) => {
                            const t = appState.nodes.find(n => n.id === tid); if (!t) return;
                            const x2 = t.x; const y2 = t.y + 20; const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                            const dist = Math.abs(x2 - x1) * 0.5; path.setAttribute("d", `M ${x1} ${y1} C ${x1 + dist} ${y1}, ${x2 - dist} ${y2}, ${x2} ${y2}`);
                            let cls = "connection-line"; if(opt.once) cls += " dashed"; if(alt) cls += " alt"; path.setAttribute("class", cls); svg.appendChild(path);
                        };
                        if (opt.targetNodeId) drawLine(opt.targetNodeId, false);
                        if (opt.altTargetNodeId) drawLine(opt.altTargetNodeId, true);
                    });
                });
            },
            renderMinimap() {
                const canvas = document.getElementById('minimap-canvas'); const ctx = canvas.getContext('2d'); const width = canvas.width = canvas.clientWidth; const height = canvas.height = canvas.clientHeight; ctx.clearRect(0, 0, width, height);
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity; if (appState.nodes.length === 0) return;
                appState.nodes.forEach(n => { minX = Math.min(minX, n.x); minY = Math.min(minY, n.y); maxX = Math.max(maxX, n.x + (n.width||450)); maxY = Math.max(maxY, n.y + 300); });
                minX -= 1000; minY -= 1000; maxX += 1000; maxY += 1000; const mapW = maxX - minX; const mapH = maxY - minY; const ratio = Math.min(width / mapW, height / mapH);
                appState.nodes.forEach(n => { const char = characterManager.getCharacter(n.characterId); ctx.fillStyle = char.color; ctx.fillRect((n.x - minX) * ratio, (n.y - minY) * ratio, (n.width||450) * ratio, (n.height||200) * ratio); });
                const c = document.getElementById('workspace-container'); const vpX = (-appState.panOffset.x / appState.scale); const vpY = (-appState.panOffset.y / appState.scale); const vpW = c.clientWidth / appState.scale; const vpH = c.clientHeight / appState.scale;
                const viewEl = document.getElementById('minimap-viewport'); viewEl.style.left = ((vpX - minX) * ratio) + 'px'; viewEl.style.top = ((vpY - minY) * ratio) + 'px'; viewEl.style.width = (vpW * ratio) + 'px'; viewEl.style.height = (vpH * ratio) + 'px';
            },
            setupCanvasEvents() {
                const c = document.getElementById('workspace-container');
                c.addEventListener('wheel', (e) => { e.preventDefault(); const i = 0.1; const d = -Math.sign(e.deltaY); const oldS = appState.scale; const newS = Math.min(Math.max(0.1, oldS + (d * i)), 2); const r = c.getBoundingClientRect(); const mx = e.clientX - r.left; const my = e.clientY - r.top; const lx = (mx - appState.panOffset.x) / oldS; const ly = (my - appState.panOffset.y) / oldS; appState.panOffset.x = mx - (lx * newS); appState.panOffset.y = my - (ly * newS); appState.scale = newS; this.applyTransform(); }, { passive: false });
                c.addEventListener('mousedown', (e) => { if (e.target === c || e.target.id === 'canvas-area' || e.target.tagName === 'svg') { appState.interactionMode = 'panning'; appState.panStart = { x: e.clientX, y: e.clientY }; document.body.style.cursor = 'grabbing'; } });
                this.startConnection = (e, nodeId, idx) => { e.stopPropagation(); appState.interactionMode = 'connecting'; const rect = c.getBoundingClientRect(); const logicX = (e.clientX - rect.left - appState.panOffset.x) / appState.scale; const logicY = (e.clientY - rect.top - appState.panOffset.y) / appState.scale; appState.connectionStart = { nodeId, optionIndex: idx, x: logicX, y: logicY }; document.getElementById('temp-connection').classList.remove('hidden'); };
                window.addEventListener('mousemove', (e) => {
                    const r = c.getBoundingClientRect(); const mx = e.clientX - r.left; const my = e.clientY - r.top;
                    
                    if (appState.interactionMode === 'resizing_node' && appState.resizingNodeId) {
                        const node = appState.nodes.find(n => n.id === appState.resizingNodeId);
                        const deltaX = (e.clientX - appState.resizeStart.x) / appState.scale;
                        const deltaY = (e.clientY - appState.resizeStart.y) / appState.scale;
                        
                        node.width = Math.max(300, appState.resizeInitialDim.w + deltaX); // Min width 300
                        node.height = Math.max(200, appState.resizeInitialDim.h + deltaY); // Min height 200
                        
                        const el = document.getElementById(node.id);
                        el.style.width = node.width + 'px';
                        el.style.height = node.height + 'px';
                        editor.drawConnections();
                    }
                    else if (appState.interactionMode === 'dragging_node' && appState.draggingNodeId) { const n = appState.nodes.find(x => x.id === appState.draggingNodeId); let nx = (mx - appState.dragOffset.x - appState.panOffset.x) / appState.scale; let ny = (my - appState.dragOffset.y - appState.panOffset.y) / appState.scale; n.x = Math.round(nx / 20) * 20; n.y = Math.round(ny / 20) * 20; const el = document.getElementById(n.id); el.style.left = n.x + 'px'; el.style.top = n.y + 'px'; this.drawConnections(); } else if (appState.interactionMode === 'panning') { const dx = e.clientX - appState.panStart.x; const dy = e.clientY - appState.panStart.y; appState.panOffset.x += dx; appState.panOffset.y += dy; appState.panStart = { x: e.clientX, y: e.clientY }; this.applyTransform(); } else if (appState.interactionMode === 'connecting') { const lx = (mx - appState.panOffset.x) / appState.scale; const ly = (my - appState.panOffset.y) / appState.scale; const sx = appState.connectionStart.x; const sy = appState.connectionStart.y; document.getElementById('temp-connection').setAttribute("d", `M ${sx} ${sy} C ${sx + 50} ${sy}, ${lx - 50} ${ly}, ${lx} ${ly}`); } });
                window.addEventListener('mouseup', (e) => {
                    if (appState.interactionMode === 'resizing_node') {
                        historySystem.pushState();
                    }
                    else if (appState.interactionMode === 'connecting') { const t = document.elementFromPoint(e.clientX, e.clientY); const tn = t ? t.closest('.node-card') : null; const { nodeId, optionIndex } = appState.connectionStart; historySystem.pushState(); if (tn && tn.id !== nodeId) { editor.updateOption(nodeId, optionIndex, 'targetNodeId', tn.id); } else if (!tn) { const r = c.getBoundingClientRect(); const lx = (e.clientX - r.left - appState.panOffset.x) / appState.scale; const ly = (e.clientY - r.top - appState.panOffset.y) / appState.scale; const nid = editor.addNode(lx, ly - 20); editor.updateOption(nodeId, optionIndex, 'targetNodeId', nid); } document.getElementById('temp-connection').classList.add('hidden'); this.renderNodes(); } else if (appState.interactionMode === 'dragging_node') { historySystem.pushState(); editor.renderMinimap(); } appState.interactionMode = 'default'; appState.draggingNodeId = null; appState.resizingNodeId = null; document.body.style.cursor = ''; });
            },
            applyTransform() { const el = document.getElementById('canvas-area'); el.style.transform = `translate(${appState.panOffset.x}px, ${appState.panOffset.y}px) scale(${appState.scale})`; document.getElementById('zoom-level').innerText = Math.round(appState.scale * 100) + '%'; this.renderMinimap(); },
            resetView() { appState.scale = 1; appState.panOffset = { x: -2000, y: -2000 }; this.applyTransform(); },
            togglePreview() { const m = document.getElementById('preview-modal'); if (m.classList.contains('hidden')) { m.classList.remove('hidden'); previewEngine.start(); } else { m.classList.add('hidden'); } }
        };

        // --- PREVIEW ---
        const previewEngine = {
            currentId: null, visited: new Set(), runtimeVars: {},
            start(keepState = false) { if (appState.nodes.length === 0) return alert("Buit!"); this.currentId = appState.nodes[0].id; if (!keepState) { this.visited.clear(); this.runtimeVars = JSON.parse(JSON.stringify(appState.globalVariables)); } this.render(); },
            evaluate(code) { if (!code || !code.trim()) return true; try { const safeKeys = Object.keys(this.runtimeVars).filter(k => /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(k)); const values = safeKeys.map(k => this.runtimeVars[k]); return new Function(...safeKeys, `return ${code};`)(...values); } catch (e) { console.error("Error Logic:", e); return false; } },
            execute(code) { if (!code || !code.trim()) return; try { const safeKeys = Object.keys(this.runtimeVars).filter(k => /^[a-zA-Z_$][a-zA-Z0-9_$]*$/.test(k)); const values = safeKeys.map(k => this.runtimeVars[k]); const newVars = new Function(...safeKeys, `${code}\n; return {${safeKeys.join(',')}};`)(...values); this.runtimeVars = { ...this.runtimeVars, ...newVars }; } catch (e) { console.error("Error Effect:", e); } },
            render() {
                const node = appState.nodes.find(n => n.id === this.currentId); const char = characterManager.getCharacter(node.characterId);
                const bgArea = document.getElementById('preview-game-area'); const portraitBox = document.getElementById('preview-portrait'); const portraitTxt = document.getElementById('preview-portrait-initial'); const portraitImg = document.getElementById('preview-portrait-img'); const textArea = document.getElementById('preview-text'); const nameArea = document.getElementById('preview-char-name'); const optContainer = document.getElementById('preview-options'); const debugArea = document.getElementById('preview-debug-vars');
                portraitBox.style.display = 'flex'; document.getElementById('preview-text-container').style.display = 'block';
                if (node.bgImage) { bgArea.style.backgroundImage = `url('${node.bgImage}')`; document.getElementById('preview-default-bg').style.display = 'none'; } else { bgArea.style.backgroundImage = 'none'; document.getElementById('preview-default-bg').style.display = 'block'; }
                portraitBox.style.backgroundColor = char.color; if (char.avatarUrl) { portraitTxt.classList.add('hidden'); portraitImg.src = char.avatarUrl; portraitImg.classList.remove('hidden'); } else { portraitTxt.innerText = char.name[0]; portraitTxt.classList.remove('hidden'); portraitImg.classList.add('hidden'); }
                nameArea.innerText = char.name; nameArea.style.color = char.color; debugArea.innerHTML = Object.entries(this.runtimeVars).map(([k, v]) => `<div>${k}: <span class="text-white">${v}</span></div>`).join('');
                
                // Logic Text Selection
                let validTexts = node.textOptions.filter(t => this.evaluate(t.condition));
                const hasSpecific = validTexts.some(t => t.condition && t.condition.trim() !== "");
                if (hasSpecific) { validTexts = validTexts.filter(t => t.condition && t.condition.trim() !== ""); }
                const chosenText = validTexts.length > 0 ? validTexts[Math.floor(Math.random() * validTexts.length)].text : "(Sense text vàlid)";
                
                // INTERPOLACIÓ VARIABLES: Reconeix tant {var} com $var
                textArea.innerText = chosenText
                    .replace(/\{(\w+)\}/g, (_, v) => this.runtimeVars[v] ?? '?')
                    .replace(/\$(\w+)/g, (_, v) => this.runtimeVars[v] ?? ('$' + v));

                optContainer.innerHTML = '';
                const availableOpts = node.options.filter((opt, idx) => { const visitedKey = node.id + '_' + idx; if (opt.once && this.visited.has(visitedKey)) return false; if (opt.condition && !this.evaluate(opt.condition)) return false; return true; });
                if (availableOpts.length === 0 && node.options.length > 0) this.showEnd("No hi ha més opcions disponibles."); else if (node.options.length === 0) this.showEnd("Fi de l'aventura."); else {
                    node.options.forEach((opt, idx) => {
                        const visitedKey = node.id + '_' + idx; if (opt.once && this.visited.has(visitedKey)) return; if (opt.condition && !this.evaluate(opt.condition)) return;
                        const btn = document.createElement('button'); btn.className = "w-full text-left bg-slate-800/80 hover:bg-slate-700 border border-slate-600 p-3 rounded text-slate-200 hover:text-white transition flex gap-2"; btn.innerHTML = `<span class="text-yellow-500">➤</span> ${opt.text}`;
                        btn.onclick = () => {
                            if (opt.once) this.visited.add(visitedKey); if (opt.effect) this.execute(opt.effect);
                            let nextId = opt.targetNodeId; if (opt.altTargetNodeId && opt.targetCondition && this.evaluate(opt.targetCondition)) nextId = opt.altTargetNodeId;
                            if (nextId) { this.currentId = nextId; this.render(); } else { portraitBox.style.display = 'none'; document.getElementById('preview-text-container').style.display = 'none'; this.showEnd("Has acabat la conversa."); }
                        };
                        optContainer.appendChild(btn);
                    });
                }
            },
            showEnd(msg) { const c = document.getElementById('preview-options'); c.innerHTML = `<div class="text-center text-yellow-500 text-xl font-bold mb-4 mt-4">${msg}</div><div class="flex justify-center gap-4"><button onclick="previewEngine.start(true)" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow"><i class="fa-solid fa-rotate-left"></i> Nova conversa (Manté Estat)</button><button onclick="previewEngine.start(false)" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded shadow"><i class="fa-solid fa-power-off"></i> Reiniciar Tot</button></div>`; }
        };

        // --- IO ---
        const ioSystem = {
            autosave() { localStorage.setItem('adv_editor_data', JSON.stringify(appState)); const ind = document.getElementById('autosave-indicator'); ind.classList.remove('opacity-0'); setTimeout(() => ind.classList.add('opacity-0'), 2000); },
            autoload() { const data = localStorage.getItem('adv_editor_data'); if (data) { try { const p = JSON.parse(data); appState.nodes = p.nodes||[]; appState.characters = p.characters||[]; appState.globalVariables = p.globalVariables||{}; this.migrate(); historySystem.pushState(); } catch(e) { console.error("Autoload error", e); } } },
            migrate() { appState.nodes.forEach(n => { if (!n.textOptions) { n.textOptions = [{ text: n.text || "", condition: "" }]; delete n.text; } if (!n.width) n.width = 450; }); },
            
            exportJSON() { 
                // Obtenir nom del personatge inicial
                const startNode = appState.nodes.find(n => n.id === 'node_start') || appState.nodes[0];
                const charName = startNode ? characterManager.getCharacter(startNode.characterId).name : "Unknown";

                // Crear objecte amb id_dialogue al principi
                const exportObj = {
                    id_dialogue: charName,
                    ...appState
                };

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2)); 
                const a = document.createElement('a'); a.href = dataStr; a.download = `adventure_${Date.now()}.json`; a.click(); 
            },
            
            loadJSON(input) { const reader = new FileReader(); reader.onload = (e) => { try { const json = JSON.parse(e.target.result); const data = json.appState || json; appState.nodes = data.nodes||[]; appState.characters = data.characters||[]; appState.globalVariables = data.globalVariables||{}; this.migrate(); historySystem.pushState(); characterManager.renderList(); variableManager.renderList(); editor.renderNodes(); editor.resetView(); } catch (err) { alert("Error JSON: " + err.message); } }; if (input.files[0]) reader.readAsText(input.files[0]); input.value = ''; },
            
            // COPIAR CODI DE DIÀLEG (PASSATGE)
            copyTwine() {
                const clean = (obj) => {
                    if (Array.isArray(obj)) return obj.map(clean);
                    if (obj && typeof obj === 'object') {
                        const newObj = {};
                        for (const key in obj) {
                            if (['x', 'y', 'width', 'height', 'interactionMode', 'draggingNodeId', 'resizingNodeId', 'dragOffset', 'connectionStart', 'scale', 'panOffset'].includes(key)) continue; 
                            const val = obj[key];
                            if (val === null || val === "" || val === undefined) continue;
                            newObj[key] = clean(val);
                        }
                        return newObj;
                    }
                    return obj;
                };

                // Obtenir nom del personatge inicial
                const startNode = appState.nodes.find(n => n.id === 'node_start') || appState.nodes[0];
                const charName = startNode ? characterManager.getCharacter(startNode.characterId).name : "Unknown";

                const exportData = {
                    id_dialogue: charName, // Afegeix id_dialogue al principi
                    characters: clean(appState.characters),
                    globalVariables: appState.globalVariables,
                    nodes: clean(appState.nodes)
                };
                
                let jsonStr = JSON.stringify(exportData, null, 2).replace(/`/g, '\\`').replace(/\$\{/g, '\\${');

                const template = `<!-- CODI DIÀLEG PER ENGANXAR AL PASSATGE -->
<script>
    // 1. Dades
    var jsonDiàleg = \`
${jsonStr}
    \`;

    // 2. Contenidor (adaptat al teu projecte)
    var containerId = 'twineImageInfoDisplay';
    var container = document.getElementById(containerId);

    // 3. Inicialització
    if (container && window.AdventureEngine) {
        container.style.display = 'block'; // Mostrar contenidor
        AdventureEngine.init(jsonDiàleg, containerId);
    } else {
        console.error("Error: Falta AdventureEngine o el contenidor '" + containerId + "'");
    }
<\/script>
<!-- Recorda: AdventureEngine gestiona la classe .adv-dialogue-active automàticament -->`;

                this.copyToClipboard(template);
            },

            // COPIAR MOTOR JS
            copyEngineJS() { this.copyToClipboard(TWINE_ENGINE_JS); },

            // COPIAR CSS
            copyEngineCSS() { this.copyToClipboard(TWINE_ENGINE_CSS); },

            // Helper Copiar
            copyToClipboard(text) {
                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                
                const ind = document.getElementById('autosave-indicator');
                const originalText = ind.innerHTML;
                ind.innerHTML = '<i class="fa-solid fa-check mr-1"></i> Copiat al portapapers!';
                ind.classList.remove('opacity-0', 'text-gray-500');
                ind.classList.add('text-green-600');
                
                setTimeout(() => {
                    ind.classList.add('opacity-0');
                    setTimeout(() => {
                        ind.innerHTML = originalText;
                        ind.classList.replace('text-green-600', 'text-gray-500');
                    }, 500);
                }, 2000);
            }
        };

        window.onload = () => { ioSystem.autoload(); characterManager.init(); variableManager.init(); editor.init(); if (appState.nodes.length === 0) editor.addNode(); editor.resetView(); };
    </script>
</body>
</html>
