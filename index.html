<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Hotspots per Twine (Harlowe)</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
            font-size: 0.95em;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #imageEditor {
            flex: 2;
            min-width: 400px;
            position: relative;
            cursor: crosshair;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 0;
            height: auto;
            min-height: 400px;
            border: 1px dashed #ccc;
            overflow: hidden;
            box-sizing: border-box;
            touch-action: none;
        }
        #imageDisplay {
            max-width: 100%;
            height: auto;
            display: none;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: none;
        }
        #drawingInstructions {
            text-align: center;
            margin-top: 50px;
            color: #666;
        }
        .hotspot-area {
            position: absolute;
            border: 2px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.2);
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 14px;
            box-sizing: border-box;
            z-index: 10; 
            touch-action: none;
        }
        .hotspot-overlay-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
            z-index: -1;
            opacity: 0.8;
        }
        .hotspot-name-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 2px 5px;
            background: rgba(0,0,0,0.7);
            border-radius: 3px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 15;
        }
        .hotspot-area:hover {
            background-color: rgba(0, 123, 255, 0.4);
            border-color: #0056b3;
        }
        #hotspotsConfig {
            flex: 1;
            min-width: 300px;
        }
        .hotspot-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .hotspot-item label {
            display: block;
            margin-bottom: 5px;
            font-size: 1.05em;
        }
        .hotspot-item label.bold-label {
            font-weight: bold;
        }
        .hotspot-item input[type="text"],
        .hotspot-item select,
        .hotspot-item textarea,
        .hotspot-item input[type="number"] {
            width: calc(100% - 12px);
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        .hotspot-item textarea {
            resize: vertical;
            min-height: 60px;
        }
        .hotspot-item button.delete-config-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .hotspot-item button.delete-config-button:hover {
            background-color: #c82333;
        }
        #outputCode {
            width: calc(100% - 40px);
            height: 300px;
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #e9ecef;
            resize: vertical;
        }
        .button-group {
            margin-top: 10px;
        }
        .button-group button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .button-group button:hover {
            background-color: #0056b3;
        }
        #copyFeedback {
            display: none;
            margin-left: 10px;
            color: green;
            font-weight: bold;
        }
        .hotspot-delete-button-visual {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            z-index: 20;
        }
        .hotspot-delete-button-visual:hover {
            background-color: #c82333;
        }
        .hotspot-resize-handle {
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 20px;
            height: 20px;
            background-color: white;
            border: 1px solid #007bff;
            border-radius: 50%;
            cursor: nwse-resize;
            z-index: 25;
            touch-action: none;
        }
        .hidden-field {
            display: none;
        }
        #editorImageInfoDisplay {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 1em;
            display: none;
            z-index: 100;
            pointer-events: none;
        }
        .condition-label-container label,
        .column label {
            color: #333;
        }
        .column .condition-label {
            color: darkred;
        }
        .column .limit-label {
            color: darkorange;
        }
        .column .darkblue-label {
            color: darkblue;
        }
        .column .darkyellow-label {
            color: darkorange;
        }
        .hotspot-section {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #e0e0e0;
        }
        .hotspot-section:last-of-type {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        .two-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .column {
            display: flex;
            flex-direction: column;
        }
        .condition-inputs-wrapper {
            display: block !important;
        }
        .condition-inputs-wrapper label,
        .condition-inputs-wrapper input,
        .condition-inputs-wrapper textarea {
            margin-bottom: 10px;
        }
        .secondary-variable-toggle-container,
        .condition-toggle-container,
        .visit-limit-toggle-container {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .condition-toggle-container label {
            color: #8B0000 !important;
            display: flex;
            align-items: center;
            font-weight: bold;
        }
        .secondary-variable-toggle-container label,
        .visit-limit-toggle-container label {
            display: flex;
            align-items: center;
            font-weight: bold;
        }
        .secondary-variable-toggle-container input[type="checkbox"],
        .condition-toggle-container input[type="checkbox"],
        .visit-limit-toggle-container input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
            margin-bottom: 0;
        }
        .strong-red-label {
            color: #8B0000 !important;
        }
        .hotspot-item .button-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .hotspot-item .button-row button {
            display: inline-block;
            margin: 0;
        }
        .scroll-to-top-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .scroll-to-top-button:hover {
            background-color: #218838;
        }
        .json-upload-btn {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .json-upload-btn:hover {
            background-color: #59359a;
        }
        .generate-dialog-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .generate-dialog-btn:hover {
            background-color: #218838;
        }
        .overlay-config-section {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid #90caf9;
        }
        .overlay-preview-img {
            max-width: 100px;
            max-height: 100px;
            display: block;
            margin: 5px 0;
            border: 1px solid #ccc;
        }
        .remove-overlay-btn {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 0.8em;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .json-file-status {
            font-size: 0.9em;
            color: #666;
            margin-left: 10px;
            font-style: italic;
        }
        #confirmationModal, #folderRequestModal {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
        }
        #confirmationModal > div, #folderRequestModal > div {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 300px;
            width: 90%;
        }
        #confirmationModal button, #folderRequestModal button {
            padding: 10px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 44px;
            cursor: pointer;
            color: white;
        }
        #confirmationModal #cancelDeleteButton, #folderRequestModal #cancelFolderButton {
            background-color: #6c757d;
        }
        #confirmationModal #confirmDeleteButton {
            background-color: #dc3545;
        }
        #folderRequestModal #confirmFolderButton {
             background-color: #007bff;
        }

        /* Styling for the new conditional builder */
        .conditional-builder, .setter-builder {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            align-items: center;
        }
        .setter-builder input, .conditional-builder input, .conditional-builder select {
             margin-bottom: 0px !important;
        }
        .setter-builder input[data-field$="Value"] {
            grid-column: span 2;
        }
        .overlay-toggle-container {
             margin-bottom: 10px;
        }
        .overlay-toggle-container label {
             font-weight: bold;
             display: flex;
             align-items: center;
        }
        .overlay-toggle-container input[type="checkbox"] {
             margin-right: 8px;
             width: auto;
        }
    </style>
</head>
<body>
    <h1>Editor de Hotspots per a Històries de Twine (Harlowe)</h1>
    <p>1. Carrega una imatge. 2. Dibuixa rectangles sobre les àrees que vulguis fer interactives. 3. Configura cada hotspot. 4. Copia el codi generat i enganxa'l al passatge de Twine.</p>

    <div class="container">
        <div class="panel" id="imageConfig">
            <h2>Configuració de la Imatge</h2>
            <label for="imageUpload">Carregar Imatge:</label>
            <input type="file" id="imageUpload" accept="image/*">
            
            <!-- Hidden input for loading image folder -->
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">

            <div id="imageEditor">
                <img id="imageDisplay" src="" alt="Imatge de la història" style="display: none;">
                <p id="drawingInstructions">Carrega una imatge i dibuixa un hotspot!</p>
                <div id="editorImageInfoDisplay"></div>
            </div>
        </div>

        <div class="panel" id="hotspotsConfig">
            <h2>Hotspots Configurats</h2>
            <div id="hotspotsContainer">
                <p>No hi ha hotspots creats.</p>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>Codi Twine (Harlowe) Generat</h2>
        <textarea id="outputCode"></textarea>
        <div class="button-group">
            <button id="copyCodeButton">Copiar Codi</button>
            <button id="loadCodeButton">Carregar Codi existent</button>
            <span id="copyFeedback">Codi copiat!</span>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const CONDITION_OPERATORS = [
            { value: 'is', label: 'Igual (is)' },
            { value: '==', label: 'Igual (==)' },
            { value: '>', label: 'Major (>)' },
            { value: '<', label: 'Menor (<)' },
            { value: '>=', label: 'Major o igual (>=)' },
            { value: '<=', label: 'Menor o igual (<=)' },
            { value: 'not', label: 'No igual (not)' },
            { value: '!=', label: 'No igual (!=)' }
        ];

        const SETTER_OPERATORS = [
            { value: 'to', label: 'Assignar (=)' },
            { value: '=', label: 'Assignar (old)' },
            { value: '+=', label: 'Sumar (+=)' },
            { value: '-=', label: 'Restar (-=)' },
            { value: '*=', label: 'Multiplicar (*=)' },
            { value: '/=', label: 'Dividir (/=)' }
        ];

        // --- DOM Elements ---
        const imageUpload = document.getElementById('imageUpload');
        const imageDisplay = document.getElementById('imageDisplay');
        const imageEditor = document.getElementById('imageEditor');
        const hotspotsContainerEl = document.getElementById('hotspotsContainer');
        const outputCode = document.getElementById('outputCode');
        const copyCodeButton = document.getElementById('copyCodeButton');
        const drawingInstructions = document.getElementById('drawingInstructions');
        const editorImageInfoDisplay = document.getElementById('editorImageInfoDisplay');
        const copyFeedback = document.getElementById('copyFeedback');
        const loadCodeButton = document.getElementById('loadCodeButton');
        const folderInput = document.getElementById('folderInput');

        // --- State Variables ---
        let isDrawing = false;
        let isDragging = false;
        let isResizing = false;
        let activeHotspotElement = null; 
        let dragOffsetX, dragOffsetY;
        let initialHotspotWidth, initialHotspotHeight;
        let initialMouseX, initialMouseY;
        let startX, startY;
        let currentRect = null;
        let hotspots = [];
        let hotspotIdCounter = 0;
        let hasMovedDuringInteraction = false;
        let initialInteractionTarget = null;
        
        // Modal State Variables
        let confirmationModal = null;
        let folderRequestModal = null;
        let currentHotspotToDeleteId = null;
        
        // Overlay & Folder State
        let projectImages = {};
        let pendingParseCode = null; // Store code to parse after loading folder
        let mainImageFilename = null; // New variable to store the main image file name when loading existing code
        
        const TAP_THRESHOLD = 8;

        // --- UTILS ---
        function hideCopyFeedback() {
            copyFeedback.classList.remove('show');
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                return unsafe; 
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/`/g, "&#x60;");
        }
        
        function escapeForTemplateLiteral(str) {
            if (typeof str !== 'string') {
                str = String(str || '');
            }
            return str.replace(/`/g, '\\`');
        }

        function formatVariable(varName) {
            if (varName && typeof varName === 'string' && !varName.startsWith('$')) {
                return '$' + varName;
            }
            return varName;
        }
        
        // Build the condition string for Harlowe (e.g., "$clau is 'espasa'")
        function buildConditionString(variable, operator, value) {
            if (!variable || !operator || !value) return "";
            
            const formattedVariable = formatVariable(variable.trim());
            const trimmedValue = value.trim();

            let formattedValue = trimmedValue;
            
            // Si el valor no és numèric, o si s'utilitza l'operador 'is', s'ha de posar entre cometes
            // Excepció: si s'utilitza un operador de comparació (>, <, >=, <=) amb un número
            const isNumeric = !isNaN(trimmedValue) && trimmedValue !== '';
            const needsQuotes = !isNumeric || ['is', 'not'].includes(operator.toLowerCase()); // For non-numeric or explicit text comparisons
            const isLogical = ['is', 'not', '==', '!=', '>=', '<=', '>', '<'].includes(operator.toLowerCase()); // Check for comparison operators

            // In Harlowe, numeric comparisons usually don't need quotes if the value is purely numeric
            if (needsQuotes && !/^(["']).*\1$/.test(trimmedValue)) {
                // If it's a numeric comparison operator but the value isn't numeric, we quote it
                if (isLogical && !isNumeric) {
                     formattedValue = `'${trimmedValue.replace(/'/g, "\\'")}'`; // Use single quotes internally
                }
                // If it's 'is' or 'not', we always quote the value unless it starts with a $ (variable)
                if (['is', 'not'].includes(operator.toLowerCase()) && !formattedValue.startsWith('$')) {
                     formattedValue = `'${trimmedValue.replace(/'/g, "\\'")}'`; 
                }
            }


            // Harlowe style: (if: $var is 'value')
            if (['is', 'not'].includes(operator.toLowerCase())) {
                return `${formattedVariable} ${operator} ${formattedValue}`;
            }

            // Standard comparison style: (if: $var > 10)
            return `${formattedVariable} ${operator} ${formattedValue}`;
        }
        
        // Build the setter string for Harlowe (e.g., "$var to 10" or "$var += 5")
        function buildSetterValue(variable, operator, value) {
             if (!variable || !operator || !value) return "";

            const formattedVariable = formatVariable(variable.trim());
            const trimmedValue = value.trim();
            const arithmeticOperators = ['+=', '-=', '*=', '/='];

            // Valor de la dreta
            let formattedValue = trimmedValue;
            const isNumeric = !isNaN(trimmedValue) && trimmedValue !== '';

            // Si és assignació simple (to, =), posem cometes al text, però no als números ni a variables (que haurien de començar per $)
            if (operator === 'to' || operator === '=') {
                if (!isNumeric && !formattedValue.startsWith('$') && !/^(["']).*\1$/.test(formattedValue)) {
                    formattedValue = `'${trimmedValue.replace(/'/g, "\\'")}'`; // Use single quotes internally
                }
            }
            
            // Si és una operació aritmètica (+=, -=, etc.)
            if (arithmeticOperators.includes(operator)) {
                return `${formattedVariable} ${operator} ${trimmedValue}`;
            }

            // Assignació simple (to/set o =)
            return `${formattedVariable} ${operator} ${formattedValue}`;
        }


        // --- MODAL LOGIC ---
        function setupConfirmationModal() {
            // Confirmation Modal
            confirmationModal = document.createElement('div');
            confirmationModal.id = 'confirmationModal';
            confirmationModal.style.display = 'none';

            const modalContent = document.createElement('div');
            const confirmMessage = document.createElement('p');
            confirmMessage.id = 'confirmMessage';
            confirmMessage.style.marginBottom = '20px';
            modalContent.appendChild(confirmMessage);

            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.justifyContent = 'space-around';

            const cancelDeleteButton = document.createElement('button');
            cancelDeleteButton.id = 'cancelDeleteButton';
            cancelDeleteButton.textContent = 'No!';
            cancelDeleteButton.addEventListener('click', hideConfirmationModal);
            buttonContainer.appendChild(cancelDeleteButton);

            const confirmDeleteButton = document.createElement('button');
            confirmDeleteButton.id = 'confirmDeleteButton';
            confirmDeleteButton.textContent = 'Eliminar';
            confirmDeleteButton.addEventListener('click', () => {
                if (currentHotspotToDeleteId !== null) {
                    removeHotspot(currentHotspotToDeleteId);
                }
                hideConfirmationModal();
            });
            buttonContainer.appendChild(confirmDeleteButton);

            modalContent.appendChild(buttonContainer);
            confirmationModal.appendChild(modalContent);
            document.body.appendChild(confirmationModal);

            // Folder Request Modal
            folderRequestModal = document.createElement('div');
            folderRequestModal.id = 'folderRequestModal';
            folderRequestModal.style.display = 'none';
            folderRequestModal.innerHTML = `
                <div>
                    <p style="margin-bottom:20px;">S'han detectat imatges en el codi. Si us plau, selecciona la carpeta on es troben per visualitzar-les correctament.</p>
                    <div style="display:flex; justify-content:space-around;">
                        <button id="cancelFolderButton">Ometre</button>
                        <button id="confirmFolderButton">Seleccionar Carpeta</button>
                    </div>
                </div>
            `;
            document.body.appendChild(folderRequestModal);
            
            document.getElementById('confirmFolderButton').addEventListener('click', () => {
                 folderInput.click();
            });
            
            document.getElementById('cancelFolderButton').addEventListener('click', () => {
                 // Close modal and process code without local images
                 folderRequestModal.style.display = 'none';
                 if (pendingParseCode) {
                     processTwineCode(pendingParseCode);
                     pendingParseCode = null; // Clear after use
                 }
            });
        }

        function showConfirmationModal(hotspotId, hotspotName) {
            currentHotspotToDeleteId = hotspotId;
            document.getElementById('confirmMessage').textContent = `Segur que vols eliminar el hotspot ${hotspotName}?`;
            confirmationModal.style.display = 'flex';
        }

        function hideConfirmationModal() {
            confirmationModal.style.display = 'none';
            currentHotspotToDeleteId = null;
        }

        // --- EVENT LISTENERS ---

        // Image Upload
        imageUpload.addEventListener('change', (e) => {
            hideCopyFeedback(); 
            const file = e.target.files[0];
            if (file) {
                mainImageFilename = file.name; // Store the filename when uploading manually
                const reader = new FileReader();
                reader.onload = (event) => {
                    // IMPORTANT: Reset logic only for manual image upload
                    imageDisplay.onload = () => {
                        const extraSpace = 80;
                        imageEditor.style.minHeight = imageDisplay.offsetHeight + extraSpace + 'px';
                        imageEditor.style.height = imageDisplay.offsetHeight + extraSpace + 'px';
                        
                        // Only clear hotspots when uploading a NEW image manually
                        hotspots = []; 
                        renderHotspots();
                        generateTwineCode();
                    };
                    
                    imageDisplay.src = event.target.result;
                    imageDisplay.style.display = 'block';
                    drawingInstructions.style.display = 'none';
                    editorImageInfoDisplay.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                imageDisplay.src = '';
                imageDisplay.style.display = 'none';
                drawingInstructions.style.display = 'block';
                imageEditor.style.height = 'auto';
                imageEditor.style.minHeight = '400px';
                hotspots = [];
                mainImageFilename = null; // Clear filename if image is removed
                renderHotspots();
                generateTwineCode();
            }
        });

        // Folder Input
        folderInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                         projectImages[file.name] = URL.createObjectURL(file);
                    }
                }
                
                if (pendingParseCode) {
                    document.getElementById('folderRequestModal').style.display = 'none';
                    processTwineCode(pendingParseCode);
                    pendingParseCode = null; // Clear after use
                }
            }
        });

        function getCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
            }
            return { clientX: e.clientX, clientY: e.clientY };
        }

        function findParentWithClass(element, className) {
            let currentElement = element;
            while (currentElement && currentElement !== imageEditor) {
                if (currentElement.classList.contains(className)) {
                    return currentElement;
                }
                currentElement = currentElement.parentElement;
            }
            return null;
        }

        function findHotspotAreaParent(element) {
            return findParentWithClass(element, 'hotspot-area');
        }
        
        // Interaction Handlers
        imageEditor.addEventListener('mousedown', startInteraction);
        imageEditor.addEventListener('touchstart', startInteraction);

        function startInteraction(e) {
            hideCopyFeedback(); 
            if (imageDisplay.style.display === 'none' || !imageDisplay.src) return; 
            
            const { clientX, clientY } = getCoords(e);

            startX = clientX;
            startY = clientY;
            hasMovedDuringInteraction = false; 
            initialInteractionTarget = e.target; 

            // Check Delete Buttons
            if (e.target.classList.contains('hotspot-delete-button-visual')) {
                const hotspotElement = findHotspotAreaParent(e.target);
                if (hotspotElement) {
                    const hotspotId = parseInt(hotspotElement.dataset.hotspotId);
                    const hotspot = hotspots.find(h => h.id === hotspotId);
                    if (hotspot) {
                        showConfirmationModal(hotspot.id, hotspot.name || `Hotspot ${hotspot.id}`);
                    }
                }
                e.stopPropagation(); 
                e.preventDefault(); 
                return;
            }
            
            // Check Resize Handles
            if (e.target.classList.contains('hotspot-resize-handle')) {
                isResizing = true;
                activeHotspotElement = findHotspotAreaParent(e.target); 
                startResize(clientX, clientY);
                e.stopPropagation(); 
                e.preventDefault(); 
                return;
            } 
            
            // Check Draggables
            const clickedHotspotArea = findHotspotAreaParent(e.target);
            
            if (clickedHotspotArea) {
                isDragging = true;
                activeHotspotElement = clickedHotspotArea;
                startDrag(clientX, clientY);
                e.stopPropagation(); 
                e.preventDefault(); 
            } else if (imageEditor.contains(e.target) && (e.target === imageDisplay || e.target === imageEditor || e.target.parentElement === imageEditor || e.target.parentElement.parentElement === imageEditor ) ) {
                // Drawing new hotspot
                isDrawing = true;
                const imageRect = imageDisplay.getBoundingClientRect();
                startX = clientX - imageRect.left;
                startY = clientY - imageRect.top;

                currentRect = document.createElement('div');
                currentRect.classList.add('hotspot-area');
                const editorRect = imageEditor.getBoundingClientRect();
                currentRect.style.left = `${clientX - editorRect.left}px`;
                currentRect.style.top = `${clientY - editorRect.top}px`;
                currentRect.style.width = '0px';
                currentRect.style.height = '0px';
                currentRect.style.cursor = 'crosshair';
                imageEditor.appendChild(currentRect);
                imageEditor.style.cursor = 'grabbing';
                e.preventDefault(); 
            }
        }
        
        function startResize(clientX, clientY) {
            if (activeHotspotElement) {
                initialHotspotWidth = activeHotspotElement.offsetWidth;
                initialHotspotHeight = activeHotspotElement.offsetHeight;
                initialMouseX = clientX;
                initialMouseY = clientY;
                activeHotspotElement.style.cursor = 'nwse-resize'; 
            }
        }
        
        function startDrag(clientX, clientY) {
            if (activeHotspotElement) {
                const rect = activeHotspotElement.getBoundingClientRect();
                dragOffsetX = clientX - rect.left;
                dragOffsetY = clientY - rect.top;
                activeHotspotElement.style.cursor = 'grabbing';
            }
        }

        document.addEventListener('mousemove', handleInteractionMove);
        document.addEventListener('touchmove', handleInteractionMove, { passive: false }); 

        function handleInteractionMove(e) {
            const { clientX, clientY } = getCoords(e);

            if (Math.abs(clientX - startX) > TAP_THRESHOLD || Math.abs(clientY - startY) > TAP_THRESHOLD) {
                hasMovedDuringInteraction = true;
            }

            if (isDrawing && currentRect) {
                const imageRect = imageDisplay.getBoundingClientRect(), editorRect = imageEditor.getBoundingClientRect();
                let currentMouseEventX_onImage = clientX - imageRect.left, currentMouseEventY_onImage = clientY - imageRect.top;
                let rLeft = Math.min(startX, currentMouseEventX_onImage), rTop = Math.min(startY, currentMouseEventY_onImage),
                    rRight = Math.max(startX, currentMouseEventX_onImage), rBottom = Math.max(startY, currentMouseEventY_onImage);
                
                rLeft = Math.max(0, rLeft);
                rTop = Math.max(0, rTop);
                rRight = Math.min(imageRect.width, rRight);
                rBottom = Math.min(imageRect.height, rBottom);
                
                let rWidth = rRight - rLeft, rHeight = rBottom - rTop;

                if (rWidth < 0) rWidth = 0;
                if (rHeight < 0) rHeight = 0;

                currentRect.style.left = `${(imageRect.left - editorRect.left) + rLeft}px`;
                currentRect.style.top = `${(imageRect.top - editorRect.top) + rTop}px`;
                currentRect.style.width = `${rWidth}px`;
                currentRect.style.height = `${rHeight}px`;
                e.preventDefault(); 
            } else if (isDragging && activeHotspotElement) {
                const imageRect = imageDisplay.getBoundingClientRect(), editorRect = imageEditor.getBoundingClientRect();
                let newLeftInEditor = clientX - editorRect.left - dragOffsetX, newTopInEditor = clientY - editorRect.top - dragOffsetY;
                const hotspotWidth = activeHotspotElement.offsetWidth, hotspotHeight = activeHotspotElement.offsetHeight,
                      imageLeftInEditor = imageRect.left - editorRect.left, imageTopInEditor = imageRect.top - editorRect.top,
                      imageRightInEditor = imageLeftInEditor + imageRect.width, imageBottomInEditor = imageTopInEditor + imageRect.height;
                
                // Clamp
                newLeftInEditor = Math.max(imageLeftInEditor, Math.min(newLeftInEditor, imageRightInEditor - hotspotWidth));
                newTopInEditor = Math.max(imageTopInEditor, Math.min(newTopInEditor, imageBottomInEditor - hotspotHeight));
                
                activeHotspotElement.style.left = `${newLeftInEditor}px`;
                activeHotspotElement.style.top = `${newTopInEditor}px`;
                e.preventDefault(); 
            } else if (isResizing && activeHotspotElement) {
                const imageRect = imageDisplay.getBoundingClientRect(), editorRect = imageEditor.getBoundingClientRect();
                const imageLeftInEditor = imageRect.left - editorRect.left;
                const imageTopInEditor = imageRect.top - editorRect.top;
                const imageRightInEditor = imageLeftInEditor + imageRect.width;
                const imageBottomInEditor = imageTopInEditor + imageRect.height;

                let newWidth = initialHotspotWidth + (clientX - initialMouseX);
                let newHeight = initialHotspotHeight + (clientY - initialMouseY);

                const currentLeft = parseFloat(activeHotspotElement.style.left);
                const currentTop = parseFloat(activeHotspotElement.style.top);

                newWidth = Math.max(5, Math.min(newWidth, imageRightInEditor - currentLeft));
                newHeight = Math.max(5, Math.min(newHeight, imageBottomInEditor - currentTop));

                activeHotspotElement.style.width = `${newWidth}px`;
                activeHotspotElement.style.height = `${newHeight}px`;
                e.preventDefault(); 
            }
        }

        document.addEventListener('mouseup', endInteraction);
        document.addEventListener('touchend', endInteraction);
        document.addEventListener('touchcancel', endInteraction); 

        function endInteraction(e) {
            const { clientX, clientY } = getCoords(e);
            const movedSignificantly = Math.abs(clientX - startX) > TAP_THRESHOLD || Math.abs(clientY - startY) > TAP_THRESHOLD;

            const wasDrawing = isDrawing;
            const wasDragging = isDragging;
            const wasResizing = isResizing;

            isDrawing = false;
            isDragging = false;
            isResizing = false;
            imageEditor.style.cursor = 'crosshair';

            if (wasDrawing && currentRect) {
                const natW = imageDisplay.naturalWidth, natH = imageDisplay.naturalHeight,
                      dispW = imageDisplay.offsetWidth, dispH = imageDisplay.offsetHeight;

                const hotspotRectVis = currentRect.getBoundingClientRect(), imageRectVis = imageDisplay.getBoundingClientRect();
                let l_disp = hotspotRectVis.left - imageRectVis.left, t_disp = hotspotRectVis.top - imageRectVis.top,
                    w_disp = hotspotRectVis.width, h_disp = hotspotRectVis.height;
                currentRect.remove(); 
                currentRect = null; 

                if (w_disp >= 5 && h_disp >= 5 && dispW && dispH) { 
                    const sX = natW / dispW, sY = natH / dispH;
                    const fL = l_disp * sX, fT = t_disp * sY, fW = w_disp * sX, fH = h_disp * sY;

                    const coords = [Math.round(fL),Math.round(fT),Math.round(fL+fW),Math.round(fT+fH)].join(',');
                    hotspotIdCounter++;
                    hotspots.push({
                        id: hotspotIdCounter,
                        name: `Hotspot ${hotspotIdCounter}`,
                        type: 'passage',
                        coords: coords,
                        value: '',
                        titleText: '', sound: '', soundClick: '', infoText: '', infoText2: '',
                        transition: '', transitionArrive: '',
                        
                        // Setter Builder fields
                        setterVariable: '', setterOperator: 'to', setterValue: '',
                        
                        // Secondary Variable fields
                        variable2: '', operator2: 'to', valor2: '', 

                        // Dialog fields
                        characterName: '',
                        jsonContent: '',
                        jsonFileName: '',
                        infoTextDialog: '', soundDialog: '', titleTextDialog: '',
                        
                        // Conditional Builder fields:
                        dialogConditionVariable: '', dialogConditionOperator: 'is', dialogConditionValue: '', dialogFailInfo: '', dialogFailInfoEnter: '',
                        dialogSoundFail: '', dialogSoundClickFail: '',
                        
                        passageConditionVariable: '', passageConditionOperator: 'is', passageConditionValue: '', passageFailInfo: '', passageFailInfoEnter: '',
                        passageSoundFail: '', passageSoundClickFail: '',
                        setterConditionVariable: '', setterConditionOperator: 'is', setterConditionValue: '', setterFailInfo: '', setterFailInfoEnter: '',
                        setterSoundFail: '', setterSoundClickFail: '',
                        
                        visitLimit: '', visitLimitTextEnter: '', visitLimitTextClic: '', enableVisitLimit: false,
                        enableSecondaryVariable: false, enableConditionVariable: false,
                        
                        // Overlay fields
                        enableOverlay: false, // NEW: Overlay toggle
                        overlayImage: null, // Base64
                        overlayFilename: null,
                        overlayConditionVariable: '',
                        overlayConditionOperator: 'is',
                        overlayConditionValue: ''
                    });
                }
                renderHotspots();
                generateTwineCode(); 
            } else if ((wasDragging || wasResizing) && activeHotspotElement) { 
                // It was a hotspot
                const hotspotId = parseInt(activeHotspotElement.dataset.hotspotId);
                const hotspot = hotspots.find(h => h.id === hotspotId);

                if (hotspot) {
                    if (!movedSignificantly) {
                        const configElement = document.querySelector(`#hotspotsContainer .hotspot-item[data-hotspot-id="${hotspotId}"]`);
                        if (configElement) {
                            configElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    } else {
                        const natW = imageDisplay.naturalWidth, natH = imageDisplay.naturalHeight,
                            dispW = imageDisplay.offsetWidth, dispH = imageDisplay.offsetHeight;
                        if (dispW && dispH) {
                            const hotspotRectVis = activeHotspotElement.getBoundingClientRect(), imageRectVis = imageDisplay.getBoundingClientRect();
                            const l_disp = hotspotRectVis.left - imageRectVis.left, t_disp = hotspotRectVis.top - imageRectVis.top,
                                  w_disp = hotspotRectVis.width, h_disp = hotspotRectVis.height;
                            const sX = natW / dispW, sY = natH / dispH;
                            const fL = l_disp * sX, fT = t_disp * sY, fW = w_disp * sX, fH = h_disp * sY;
                            hotspot.coords = [Math.round(fL), Math.round(fT), Math.round(fL + fW), Math.round(fT + fH)].join(',');
                            generateTwineCode(); 
                        }
                    }
                }
            }
            activeHotspotElement = null;
            initialInteractionTarget = null;
        }

        // Function to update visibility of inner fields (secondary variable, condition, visit limit)
        function updateInnerFieldVisibility(hotspot, itemElement) {
            // Get all sections
            const passageSection = itemElement.querySelector('.passage-specific-fields');
            const setterSection = itemElement.querySelector('.setter-specific-fields');
            const dialogSection = itemElement.querySelector('.dialog-specific-fields');
            const overlayContent = itemElement.querySelector('.overlay-content-area'); // New selector for overlay content

            // Overlay visibility
            if (overlayContent) {
                overlayContent.classList.toggle('hidden-field', !hotspot.enableOverlay);
            }

            // Generic function to update visibility for any section
            const updateSectionVisibility = (section) => {
                if (!section) return;

                const secondaryFieldsContainer = section.querySelector('.secondary-variable-fields');
                const enableSecondaryCheckbox = section.querySelector('[data-field="enableSecondaryVariable"]');
                if (secondaryFieldsContainer && enableSecondaryCheckbox) {
                    secondaryFieldsContainer.classList.toggle('hidden-field', !hotspot.enableSecondaryVariable);
                    enableSecondaryCheckbox.checked = hotspot.enableSecondaryVariable;
                }

                const conditionFieldsContainer = section.querySelector('.condition-fields-container');
                const enableConditionCheckbox = section.querySelector('[data-field="enableConditionVariable"]');
                if (conditionFieldsContainer && enableConditionCheckbox) {
                    conditionFieldsContainer.classList.toggle('hidden-field', !hotspot.enableConditionVariable);
                    enableConditionCheckbox.checked = hotspot.enableConditionVariable;
                }
                
                const visitLimitSectionContainer = section.querySelector('.visit-limit-section-container');
                const enableVisitLimitCheckbox = section.querySelector('[data-field="enableVisitLimit"]');
                if (visitLimitSectionContainer && enableVisitLimitCheckbox) {
                    visitLimitSectionContainer.classList.toggle('hidden-field', !hotspot.enableVisitLimit);
                    enableVisitLimitCheckbox.checked = hotspot.enableVisitLimit;
                }
            };

            updateSectionVisibility(passageSection);
            updateSectionVisibility(setterSection);
            updateSectionVisibility(dialogSection);
        }

        // Helper to generate operator options HTML
        function getOperatorOptionsHtml(options, selectedValue) {
            return options.map(op => 
                `<option value="${op.value}" ${op.value === selectedValue ? 'selected' : ''}>${op.label}</option>`
            ).join('');
        }
        
        // Helper to generate secondary variable builder HTML (NEW)
        const generateSecondaryVariableBuilder = (prefix, hotspot) => `
            <div style="margin-bottom: 5px;">
                <label class="darkblue-label">Assignació Secundària:</label>
                <div class="setter-builder">
                    <input type="text" data-field="variable2" value="${escapeHtml(hotspot.variable2 || '')}" placeholder="Variable (sense $)" style="grid-column: 1 / 2;">
                    <select data-field="operator2" style="grid-column: 2 / 3;">
                        ${getOperatorOptionsHtml(SETTER_OPERATORS, hotspot.operator2 || 'to')}
                    </select>
                    <input type="text" data-field="valor2" value="${escapeHtml(hotspot.valor2 || '')}" placeholder="Valor" style="grid-column: 3 / 4;">
                </div>
            </div>
        `;

        // Function to render hotspots in the image editor and configuration panel
        function renderHotspots() {
            hotspotsContainerEl.innerHTML = ''; 
            // Remove visual hotspot elements from the image editor
            document.querySelectorAll('#imageEditor .hotspot-area').forEach(el => { if (el !== currentRect) el.remove(); });
            
            if (hotspots.length === 0) hotspotsContainerEl.innerHTML = '<p>No hi ha hotspots creats.</p>';

            if (imageDisplay.src && imageDisplay.naturalWidth && imageDisplay.naturalHeight) {
                const dispW = imageDisplay.offsetWidth, dispH = imageDisplay.offsetHeight,
                      natW = imageDisplay.naturalWidth, natH = imageDisplay.naturalHeight;
                const imgRectGlob = imageDisplay.getBoundingClientRect(), editorRectGlob = imageEditor.getBoundingClientRect(),
                      offsetXinEd = imgRectGlob.left - editorRectGlob.left, offsetYinEd = imgRectGlob.top - editorRectGlob.top,
                      scaleX = dispW / natW, scaleY = dispH / natH;
                
                hotspots.forEach(hotspot => {
                    const coordsArr = hotspot.coords.split(',').map(Number),
                          visRect = document.createElement('div');
                    visRect.classList.add('hotspot-area');
                    visRect.dataset.hotspotId = hotspot.id;
                    visRect.style.left = `${(coordsArr[0] * scaleX) + offsetXinEd}px`;
                    visRect.style.top = `${(coordsArr[1] * scaleY) + offsetYinEd}px`;
                    visRect.style.width = `${(coordsArr[2] - coordsArr[0]) * scaleX}px`;
                    visRect.style.height = `${(coordsArr[3] - coordsArr[1]) * scaleY}px`;

                    // Render overlay image if enabled and exists inside the hotspot div
                    if (hotspot.enableOverlay && hotspot.overlayImage) {
                        const img = document.createElement('img');
                        img.src = hotspot.overlayImage;
                        img.className = 'hotspot-overlay-img';
                        visRect.appendChild(img);
                    }

                    const nameDisplay = document.createElement('div');
                    nameDisplay.classList.add('hotspot-name-display');
                    nameDisplay.textContent = hotspot.name || `Hotspot ${hotspot.id}`;
                    visRect.appendChild(nameDisplay);

                    const delBtn = document.createElement('div');
                    delBtn.classList.add('hotspot-delete-button-visual');
                    delBtn.textContent = 'X'; 
                    delBtn.title = `Eliminar aquest hotspot (${hotspot.name || `Hotspot ${hotspot.id}`})`; 
                    visRect.appendChild(delBtn);

                    const resizeHandle = document.createElement('div');
                    resizeHandle.classList.add('hotspot-resize-handle');
                    resizeHandle.title = "Redimensionar hotspot";
                    visRect.appendChild(resizeHandle);

                    imageEditor.appendChild(visRect);
                });
            }

            const transitionOptions = `
                <option value="">Cap</option>
                <option value="instant">Instantani</option>
                <option value="dissolve">Dissoldre</option>
                <option value="fade">Esvaïment</option>
                <option value="rumble">Tremolor</option>
                <option value="shudder">Estremiment</option>
                <option value="pulse">Pulsació</option>
                <option value="zoom">Zoom</option>
                <option value="flicker">Parpelleig</option>
                <option value="slide-left">Lliscar Esquerra</option>
                <option value="slide-right">Lliscar Dreta</option>
                <option value="slide-up">Lliscar Amunt</option>
                <option value="slide-down">Lliscar Avall</option>
                <option value="fade-left">Esvaïment Esquerra</option>
                <option value="fade-right">Esvaïment Dreta</option>
                <option value="fade-up">Esvaïment Amunt</option>
                <option value="fade-down">Esvaïment Avall</option>
            `;
            
            // Helper function to generate conditional builder HTML
            const generateConditionBuilder = (prefix, hotspot) => `
                <div style="margin-bottom: 5px;">
                    <label>Constructor de condicionals:</label>
                    <div class="conditional-builder">
                        <input type="text" data-field="${prefix}ConditionVariable" value="${escapeHtml(hotspot[`${prefix}ConditionVariable`] || '')}" placeholder="Variable (sense $)">
                        <select data-field="${prefix}ConditionOperator">
                            ${getOperatorOptionsHtml(CONDITION_OPERATORS, hotspot[`${prefix}ConditionOperator`] || 'is')}
                        </select>
                        <input type="text" data-field="${prefix}ConditionValue" value="${escapeHtml(hotspot[`${prefix}ConditionValue`] || '')}" placeholder="Valor">
                    </div>
                </div>
            `;
            
            // Helper function to generate setter builder HTML
            const generateSetterBuilder = (prefix, hotspot) => `
                <div style="margin-bottom: 5px;">
                    <label>Valor de la variable:</label>
                    <div class="setter-builder">
                        <input type="text" data-field="${prefix}Variable" value="${escapeHtml(hotspot[`${prefix}Variable`] || '')}" placeholder="Variable (sense $)" style="grid-column: 1 / 2;">
                        <select data-field="${prefix}Operator" style="grid-column: 2 / 3;">
                            ${getOperatorOptionsHtml(SETTER_OPERATORS, hotspot[`${prefix}Operator`] || 'to')}
                        </select>
                        <input type="text" data-field="${prefix}Value" value="${escapeHtml(hotspot[`${prefix}Value`] || '')}" placeholder="Valor" style="grid-column: 3 / 4;">
                    </div>
                </div>
            `;


            // Render configuration items for each hotspot
            hotspots.forEach(hotspot => {
                const item = document.createElement('div');
                item.classList.add('hotspot-item');
                item.dataset.hotspotId = hotspot.id;

                let overlaySectionHtml = `
                    <div class="overlay-toggle-container">
                        <label>
                            <input type="checkbox" data-field="enableOverlay" ${hotspot.enableOverlay ? 'checked' : ''}>
                            Afegir personatge/objecte
                        </label>
                    </div>
                    <div class="overlay-config-section overlay-content-area ${hotspot.enableOverlay ? '' : 'hidden-field'}">
                        <label class="bold-label">Imatge Superposada:</label>
                        ${hotspot.overlayImage ? 
                            `<img src="${hotspot.overlayImage}" class="overlay-preview-img">
                             <button class="remove-overlay-btn">Eliminar imatge</button>` : 
                            `<input type="file" class="overlay-file-input" accept="image/*">`
                        }
                        <div style="margin-top: 15px;">
                            <label>Condició de visibilitat (imtg/hotspot):</label>
                            <div class="conditional-builder">
                                <input type="text" data-field="overlayConditionVariable" value="${escapeHtml(hotspot.overlayConditionVariable || '')}" placeholder="Variable (sense $)">
                                <select data-field="overlayConditionOperator">
                                    ${getOperatorOptionsHtml(CONDITION_OPERATORS, hotspot.overlayConditionOperator || 'is')}
                                </select>
                                <input type="text" data-field="overlayConditionValue" value="${escapeHtml(hotspot.overlayConditionValue || '')}" placeholder="Valor">
                            </div>
                        </div>
                    </div>
                `;

                item.innerHTML = `
                    <div class="hotspot-section general-settings">
                        <label>Nom Hotspot:</label><input type="text" data-field="name" value="${escapeHtml(hotspot.name || '')}" placeholder="Ej: Puerta">
                        <label>Acció:</label><select data-field="type">
                            <option value="passage" ${hotspot.type==='passage'?'selected':''}>Anar Passatge</option>
                            <option value="setter" ${hotspot.type==='setter'?'selected':''}>Canviar Variable</option>
                            <option value="dialog" ${hotspot.type==='dialog'?'selected':''}>Iniciar diàleg</option>
                        </select>
                    </div>
                    
                    ${overlaySectionHtml}

                    <div class="hotspot-section setter-specific-fields ${hotspot.type==='setter'?'':'hidden-field'}">
                        <div class="two-column-layout">
                            <div class="column">
                                <div style="height: 1.5em;"></div> <div style="height: 1.5em;"></div> 
                                ${generateSetterBuilder('setter', hotspot)}
                                
                                <label>Text (mouse enter):</label><textarea data-field="infoTextSetter">${escapeHtml(hotspot.infoTextSetter)}</textarea>
                                <label class="text-alternatiu-label">Text al fer clic (sota imatge - suporta Harlowe):</label><textarea data-field="infoTextSetter2">${escapeHtml(hotspot.infoTextSetter2)}</textarea>
                                <label>So (clic - nom àudio enregistrat a hal.tracks):</label><input type="text" data-field="soundClickSetter" value="${escapeHtml(hotspot.soundClickSetter || '')}">
                                <label>So (mouse enter - nom de l'àudio registrat a hal.tracks):</label><input type="text" data-field="soundSetter" value="${escapeHtml(hotspot.soundSetter || '')}">
                                <label>Etiqueta (apareix quan t'atures sobre):</label><input type="text" data-field="titleTextSetter" value="${escapeHtml(hotspot.titleTextSetter || '')}">
                            </div>
                            <div class="column condition-inputs-wrapper">
                                <div class="condition-toggle-container">
                                    <label class="strong-red-label">
                                        <input type="checkbox" data-field="enableConditionVariable" ${hotspot.enableConditionVariable ? 'checked' : ''}> Activar Condició
                                    </label>
                                </div>
                                <div class="condition-fields-container ${hotspot.enableConditionVariable ? '' : 'hidden-field'}">
                                    <label class="condition-label">Condició:</label>
                                    ${generateConditionBuilder('setter', hotspot)}
                                    <label class="condition-label">Text de condició no assolida (mouse enter):</label><textarea data-field="setterFailInfoEnter">${escapeHtml(hotspot.setterFailInfoEnter)}</textarea>
                                    <label class="condition-label">Text de condició no assolida (clic):</label><textarea data-field="setterFailInfo">${escapeHtml(hotspot.setterFailInfo)}</textarea>
                                    <label class="condition-label">So (clic - mentre no s'assoleix la condició):</label><input type="text" data-field="setterSoundClickFail" value="${escapeHtml(hotspot.setterSoundClickFail || '')}">
                                    <label class="condition-label">So (mouse enter - mentre no s'assoleix la condició):</label><input type="text" data-field="setterSoundFail" value="${escapeHtml(hotspot.setterSoundFail || '')}">
                                </div>
                                <div class="visit-limit-toggle-container">
                                    <label class="darkyellow-label">
                                        <input type="checkbox" data-field="enableVisitLimit" ${hotspot.enableVisitLimit ? 'checked' : ''}> Límit de visites
                                    </label>
                                </div>
                                <div class="visit-limit-section-container ${hotspot.enableVisitLimit ? '' : 'hidden-field'}">
                                    <label class="limit-label">Número de visites:</label><input type="number" data-field="visitLimit" value="${escapeHtml(hotspot.visitLimit || '')}" placeholder="">
                                    <label class="limit-label">Text de límit de visites (mouse enter):</label><textarea data-field="visitLimitTextEnter">${escapeHtml(hotspot.visitLimitTextEnter)}</textarea>
                                    <label class="limit-label">Text de límit de visites (clic):</label><textarea data-field="visitLimitTextClic">${escapeHtml(hotspot.visitLimitTextClic)}</textarea>
                                </div>
                                <div class="secondary-variable-toggle-container">
                                    <label class="darkblue-label">
                                        <input type="checkbox" data-field="enableSecondaryVariable" ${hotspot.enableSecondaryVariable ? 'checked' : ''}> Variable secundària
                                    </label>
                                </div>
                                <div class="secondary-variable-fields ${hotspot.enableSecondaryVariable ? '' : 'hidden-field'}">
                                    ${generateSecondaryVariableBuilder('setter', hotspot)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="hotspot-section dialog-specific-fields ${hotspot.type==='dialog'?'':'hidden-field'}">
                        <label class="bold-label">Diàleg:</label>
                        <div style="margin-bottom: 10px; display: flex; align-items: center;">
                            <button class="json-upload-btn">Carregar diàleg</button>
                            <button class="generate-dialog-btn">Generar diàleg</button>
                            <input type="file" class="json-file-input" accept=".json" style="display: none;">
                            <span class="json-file-status" style="margin-left: 10px; font-size: 0.9em; color: #666; font-style: italic;">${escapeHtml(hotspot.jsonFileName || 'Cap fitxer carregat')}</span>
                        </div>
                        <input type="text" data-field="characterName" value="${escapeHtml(hotspot.characterName || '')}" placeholder="S'omplirà automàticament (id_dialogue)" readonly style="background-color: #e9ecef; cursor: not-allowed;">
                        
                        <div class="two-column-layout">
                            <div class="column">
                                <label>Text (mouse enter):</label><textarea data-field="infoTextDialog">${escapeHtml(hotspot.infoTextDialog)}</textarea>
                                <label>So (mouse enter - nom de l'àudio registrat a hal.tracks):</label><input type="text" data-field="soundDialog" value="${escapeHtml(hotspot.soundDialog || '')}">
                                <label>Etiqueta (apareix quan t'atures sobre):</label><input type="text" data-field="titleTextDialog" value="${escapeHtml(hotspot.titleTextDialog || '')}">
                            </div>
                            <div class="column condition-inputs-wrapper">
                                <div class="condition-toggle-container">
                                    <label class="strong-red-label">
                                        <input type="checkbox" data-field="enableConditionVariable" ${hotspot.enableConditionVariable ? 'checked' : ''}> Activar Condició
                                    </label>
                                </div>
                                <div class="condition-fields-container ${hotspot.enableConditionVariable ? '' : 'hidden-field'}">
                                    <label class="condition-label">Condició:</label>
                                    ${generateConditionBuilder('dialog', hotspot)}
                                    <label class="condition-label">Text de condició no assolida (mouse enter):</label><textarea data-field="dialogFailInfoEnter">${escapeHtml(hotspot.dialogFailInfoEnter)}</textarea>
                                    <label class="condition-label">Text de condició no assolida (clic):</label><textarea data-field="dialogFailInfo">${escapeHtml(hotspot.dialogFailInfo)}</textarea>
                                    <label class="condition-label">So (clic - mentre no s'assoleix la condició):</label><input type="text" data-field="dialogSoundClickFail" value="${escapeHtml(hotspot.dialogSoundClickFail || '')}">
                                    <label class="condition-label">So (mouse enter - mentre no s'assoleix la condició):</label><input type="text" data-field="dialogSoundFail" value="${escapeHtml(hotspot.dialogSoundFail || '')}">
                                </div>
                                <div class="visit-limit-toggle-container">
                                    <label class="darkyellow-label">
                                        <input type="checkbox" data-field="enableVisitLimit" ${hotspot.enableVisitLimit ? 'checked' : ''}> Límit de visites
                                    </label>
                                </div>
                                <div class="visit-limit-section-container ${hotspot.enableVisitLimit ? '' : 'hidden-field'}">
                                    <label class="limit-label">Número de visites:</label><input type="number" data-field="visitLimit" value="${escapeHtml(hotspot.visitLimit || '')}" placeholder="">
                                    <label class="limit-label">Text de límit de visites (mouse enter):</label><textarea data-field="visitLimitTextEnter">${escapeHtml(hotspot.visitLimitTextEnter)}</textarea>
                                    <label class="limit-label">Text de límit de visites (clic):</label><textarea data-field="visitLimitTextClic">${escapeHtml(hotspot.visitLimitTextClic)}</textarea>
                                </div>
                                <div class="secondary-variable-toggle-container">
                                    <label class="darkblue-label">
                                        <input type="checkbox" data-field="enableSecondaryVariable" ${hotspot.enableSecondaryVariable ? 'checked' : ''}> Variable secundària
                                    </label>
                                </div>
                                <div class="secondary-variable-fields ${hotspot.enableSecondaryVariable ? '' : 'hidden-field'}">
                                    ${generateSecondaryVariableBuilder('dialog', hotspot)}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="hotspot-section passage-specific-fields ${hotspot.type==='passage'?'':'hidden-field'}">
                        <div class="two-column-layout">
                            <div class="column">
                                <div style="height: 1.5em;"></div> <div style="height: 1.5em;"></div> <label>Passatge destí:</label><input type="text" data-field="value" value="${escapeHtml(hotspot.value || '')}" placeholder="Ej: Bosc">
                                
                                <label>Transició de sortida:</label>
                                <select data-field="transition">
                                    ${transitionOptions}
                                </select>
                                <label>Transició d'arribada:</label>
                                <select data-field="transitionArrive">
                                    ${transitionOptions}
                                </select>
                                <label>Text (mouse enter):</label><textarea data-field="infoText">${escapeHtml(hotspot.infoText)}</textarea>
                                <label class="text-alternatiu-label">Text al fer clic (sota imatge - suporta Harlowe):</label><textarea data-field="infoText2">${escapeHtml(hotspot.infoText2)}</textarea>
                                <label>So (clic - nom àudio enregistrat a hal.tracks):</label><input type="text" data-field="soundClick" value="${escapeHtml(hotspot.soundClick || '')}">
                                <label>So (mouse enter - nom de l'àudio registrat a hal.tracks):</label><input type="text" data-field="sound" value="${escapeHtml(hotspot.sound || '')}">
                                <label>Etiqueta (apareix quan t'atures sobre):</label><input type="text" data-field="titleText" value="${escapeHtml(hotspot.titleText || '')}">
                            </div>
                            <div class="column condition-inputs-wrapper">
                                <div class="condition-toggle-container">
                                    <label class="strong-red-label">
                                        <input type="checkbox" data-field="enableConditionVariable" ${hotspot.enableConditionVariable ? 'checked' : ''}> Activar Condició
                                    </label>
                                </div>
                                <div class="condition-fields-container ${hotspot.enableConditionVariable ? '' : 'hidden-field'}">
                                    <label class="condition-label">Condició:</label>
                                    ${generateConditionBuilder('passage', hotspot)}
                                    <label class="condition-label">Text de condició no assolida (mouse enter):</label><textarea data-field="passageFailInfoEnter">${escapeHtml(hotspot.passageFailInfoEnter)}</textarea>
                                    <label class="condition-label">Text de condició no assolida (clic):</label><textarea data-field="passageFailInfo">${escapeHtml(hotspot.passageFailInfo)}</textarea>
                                    <label class="condition-label">So (clic - mentre no s'assoleix la condició):</label><input type="text" data-field="passageSoundClickFail" value="${escapeHtml(hotspot.passageSoundClickFail || '')}">
                                    <label class="condition-label">So (mouse enter - mentre no s'assoleix la condició):</label><input type="text" data-field="passageSoundFail" value="${escapeHtml(hotspot.passageSoundFail || '')}">
                                </div>
                                <div class="visit-limit-toggle-container">
                                    <label class="darkyellow-label">
                                        <input type="checkbox" data-field="enableVisitLimit" ${hotspot.enableVisitLimit ? 'checked' : ''}> Límit de visites
                                    </label>
                                </div>
                                <div class="visit-limit-section-container ${hotspot.enableVisitLimit ? '' : 'hidden-field'}">
                                    <label class="limit-label">Número de visites:</label><input type="number" data-field="visitLimit" value="${escapeHtml(hotspot.visitLimit || '')}" placeholder="">
                                    <label class="limit-label">Text de límit de visites (mouse enter):</label><textarea data-field="visitLimitTextEnter">${escapeHtml(hotspot.visitLimitTextEnter)}</textarea>
                                    <label class="limit-label">Text de límit de visites (clic):</label><textarea data-field="visitLimitTextClic">${escapeHtml(hotspot.visitLimitTextClic)}</textarea>
                                </div>
                                <div class="secondary-variable-toggle-container">
                                    <label class="darkblue-label">
                                        <input type="checkbox" data-field="enableSecondaryVariable" ${hotspot.enableSecondaryVariable ? 'checked' : ''}> Variable secundària
                                    </label>
                                </div>
                                <div class="secondary-variable-fields ${hotspot.enableSecondaryVariable ? '' : 'hidden-field'}">
                                    ${generateSecondaryVariableBuilder('passage', hotspot)}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="button-row">
                        <button class="delete-config-button">Eliminar ${escapeHtml(hotspot.name || `Hotspot ${hotspot.id}`)}</button>
                        <button class="scroll-to-top-button">Anar a la imatge</button>
                    </div>`;
                hotspotsContainerEl.appendChild(item);

                const pFields = item.querySelector('.passage-specific-fields');
                const sFields = item.querySelector('.setter-specific-fields');
                const dFields = item.querySelector('.dialog-specific-fields');
                
                if (hotspot.type === 'passage') {
                    pFields.querySelector(`select[data-field="transition"]`).value = hotspot.transition;
                    pFields.querySelector(`select[data-field="transitionArrive"]`).value = hotspot.transitionArrive;
                }

                const toggle = type => {
                    pFields.classList.toggle('hidden-field', type !== 'passage');
                    sFields.classList.toggle('hidden-field', type !== 'setter');
                    dFields.classList.toggle('hidden-field', type !== 'dialog');
                    updateInnerFieldVisibility(hotspot, item);
                };

                toggle(hotspot.type);

                const deleteConfigButton = item.querySelector('.delete-config-button');

                const overlayContentArea = item.querySelector('.overlay-content-area');

                const enableOverlayCheckbox = item.querySelector('[data-field="enableOverlay"]');
                if (enableOverlayCheckbox) {
                    enableOverlayCheckbox.addEventListener('change', (e) => {
                        hotspot.enableOverlay = e.target.checked;
                        if (!e.target.checked) {
                            // Clear content if deactivated
                            hotspot.overlayImage = null;
                            hotspot.overlayFilename = null;
                            hotspot.overlayConditionVariable = '';
                            hotspot.overlayConditionOperator = 'is';
                            hotspot.overlayConditionValue = '';
                        }
                        renderHotspots(); // Re-render to update the visual state and UI controls
                        generateTwineCode();
                    });
                }


                const overlayInput = item.querySelector('.overlay-file-input');
                const removeOverlayBtn = item.querySelector('.remove-overlay-btn');
                
                if (overlayInput) {
                    overlayInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                hotspot.overlayImage = ev.target.result;
                                hotspot.overlayFilename = file.name;
                                renderHotspots();
                                generateTwineCode();
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
                
                if (removeOverlayBtn) {
                    removeOverlayBtn.addEventListener('click', () => {
                        hotspot.overlayImage = null;
                        hotspot.overlayFilename = null;
                        renderHotspots();
                        generateTwineCode();
                    });
                }
                
                // --- Overlay Condition Listeners ---
                ['overlayConditionVariable', 'overlayConditionOperator', 'overlayConditionValue'].forEach(f => {
                    const element = item.querySelector(`[data-field="${f}"]`);
                    if (element) {
                        element.addEventListener(element.tagName === 'SELECT' ? 'change' : 'input', e => {
                            hotspot[f] = e.target.value;
                            generateTwineCode();
                            hideCopyFeedback();
                        });
                    }
                });

                // --- Common Hotspot Listeners ---
                const charNameInput = dFields.querySelector('input[data-field="characterName"]');
                if (charNameInput) {
                    charNameInput.addEventListener('input', e => {
                        hotspot.characterName = e.target.value;
                        generateTwineCode();
                        hideCopyFeedback();
                    });
                }

                const jsonBtn = dFields.querySelector('.json-upload-btn');
                const jsonInput = dFields.querySelector('.json-file-input');
                const jsonStatus = dFields.querySelector('.json-file-status');

                if (jsonBtn && jsonInput) {
                    jsonBtn.addEventListener('click', () => {
                        jsonInput.click();
                    });

                    jsonInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                const content = ev.target.result;
                                try {
                                    const json = JSON.parse(content);
                                    const updateAvatarURLs = (obj) => {
                                        if (Array.isArray(obj)) {
                                            obj.forEach(updateAvatarURLs);
                                        } else if (typeof obj === 'object' && obj !== null) {
                                            if (obj.avatarFileName && typeof obj.avatarFileName === 'string') {
                                                obj.avatarUrl = `imatges/${obj.avatarFileName}`;
                                            }
                                            if (obj.url && typeof obj.url === 'string' && obj.url.startsWith('data:image')) {
                                                if (obj.fileName && typeof obj.fileName === 'string') {
                                                    obj.url = `imatges/${obj.fileName}`;
                                                }
                                            }
                                            for (const key in obj) {
                                                if (typeof obj[key] === 'object') {
                                                    updateAvatarURLs(obj[key]);
                                                }
                                            }
                                        }
                                    };

                                    updateAvatarURLs(json);

                                    if (json && json.id_dialogue) {
                                        hotspot.characterName = json.id_dialogue;
                                        const charInput = dFields.querySelector('input[data-field="characterName"]');
                                        if (charInput) charInput.value = hotspot.characterName;
                                    }
                                    
                                    hotspot.jsonContent = JSON.stringify(json, null, 2);
                                    hotspot.jsonFileName = file.name;
                                    jsonStatus.textContent = file.name;
                                    generateTwineCode();
                                    hideCopyFeedback();
                                } catch (err) {
                                    alert("Error al llegir el fitxer JSON. Assegura't que és un format vàlid.");
                                    console.error(err);
                                }
                            };
                            reader.readAsText(file);
                        }
                    });
                }

                const generateDialogBtn = dFields.querySelector('.generate-dialog-btn');
                if (generateDialogBtn) {
                    generateDialogBtn.addEventListener('click', () => {
                        window.open('dialegs.html', '_blank');
                    });
                }

                item.querySelector('input[data-field="name"]').addEventListener('input', e => {
                    hotspot.name = e.target.value;
                    generateTwineCode();
                    hideCopyFeedback();
                    const hotspotElement = document.querySelector(`.hotspot-area[data-hotspot-id="${hotspot.id}"] .hotspot-name-display`);
                    if (hotspotElement) {
                        hotspotElement.textContent = e.target.value;
                    }
                    deleteConfigButton.textContent = `Eliminar ${e.target.value || `Hotspot ${hotspot.id}`}`;
                });
                item.querySelector('select[data-field="type"]').addEventListener('change', e => {
                    hotspot.type = e.target.value;
                    toggle(hotspot.type);
                    generateTwineCode();
                    hideCopyFeedback();
                });
                
                // --- Passage Fields Listeners ---
                ['value','sound','soundClick', 'titleText', 'infoText', 'infoText2', 'transition', 'transitionArrive'].forEach(f => {
                    const element = item.querySelector(`.passage-specific-fields [data-field="${f}"]`);
                    if (element) {
                        element.addEventListener(element.tagName === 'SELECT' ? 'change' : 'input', e => {
                            hotspot[f] = e.target.value;
                            generateTwineCode();
                            hideCopyFeedback();
                        });
                    }
                });

                // --- Setter Fields Listeners ---
                ['setterVariable', 'setterOperator', 'setterValue', 'soundSetter','soundClickSetter', 'titleTextSetter', 'infoTextSetter', 'infoTextSetter2'].forEach(f => {
                    const element = item.querySelector(`.setter-specific-fields [data-field="${f}"]`);
                    if (element) {
                        element.addEventListener(element.tagName === 'SELECT' ? 'change' : 'input', e => {
                            hotspot[f] = e.target.value;
                            generateTwineCode();
                            hideCopyFeedback();
                        });
                    }
                });
                
                // --- Dialog Info Fields Listeners ---
                ['infoTextDialog', 'soundDialog', 'titleTextDialog'].forEach(f => {
                    const element = item.querySelector(`.dialog-specific-fields [data-field="${f}"]`);
                    if (element) {
                        element.addEventListener('input', e => {
                            hotspot[f] = e.target.value;
                            generateTwineCode();
                            hideCopyFeedback();
                        });
                    }
                });

                // --- Conditional/Fail Fields Listeners (Dialog, Passage, Setter) ---
                const conditionFields = [
                    { prefix: 'dialog', fields: ['ConditionVariable', 'ConditionOperator', 'ConditionValue', 'FailInfo', 'FailInfoEnter', 'SoundFail', 'SoundClickFail'] },
                    { prefix: 'passage', fields: ['ConditionVariable', 'ConditionOperator', 'ConditionValue', 'FailInfo', 'FailInfoEnter', 'SoundFail', 'SoundClickFail'] },
                    { prefix: 'setter', fields: ['ConditionVariable', 'ConditionOperator', 'ConditionValue', 'FailInfo', 'FailInfoEnter', 'SoundFail', 'SoundClickFail'] }
                ];
                
                conditionFields.forEach(({ prefix, fields }) => {
                    fields.forEach(field => {
                        const element = item.querySelector(`[data-field="${prefix}${field}"]`);
                        if (element) {
                            element.addEventListener(element.tagName === 'SELECT' ? 'change' : 'input', e => {
                                hotspot[`${prefix}${field}`] = e.target.value;
                                generateTwineCode();
                                hideCopyFeedback();
                            });
                        }
                    });
                });

                // --- Secondary Variable Listeners (Common) ---
                const enableSecondaryCheckboxSelector = '[data-field="enableSecondaryVariable"]';
                [pFields, sFields, dFields].forEach(section => {
                    const checkbox = section ? section.querySelector(enableSecondaryCheckboxSelector) : null;
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            hotspot.enableSecondaryVariable = e.target.checked;
                            updateInnerFieldVisibility(hotspot, item);
                            generateTwineCode();
                            hideCopyFeedback();
                        });
                    }
                });

                // Secondary Variable Builder Listeners
                ['variable2', 'operator2', 'valor2'].forEach(f => {
                    [pFields, sFields, dFields].forEach(section => {
                        const element = section ? section.querySelector(`[data-field="${f}"]`) : null;
                        if (element) {
                            element.addEventListener(element.tagName === 'SELECT' ? 'change' : 'input', e => {
                                hotspot[f] = e.target.value;
                                generateTwineCode();
                                hideCopyFeedback();
                            });
                        }
                    });
                });

                // --- Visit Limit Listeners (Common) ---
                const enableVisitLimitCheckboxSelector = '[data-field="enableVisitLimit"]';
                [pFields, sFields, dFields].forEach(section => {
                    const checkbox = section ? section.querySelector(enableVisitLimitCheckboxSelector) : null;
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            hotspot.enableVisitLimit = e.target.checked;
                            updateInnerFieldVisibility(hotspot, item);
                            generateTwineCode();
                            hideCopyFeedback();
                        });
                    }
                });

                const visitLimitInputs = ['visitLimit', 'visitLimitTextEnter', 'visitLimitTextClic'];
                [pFields, sFields, dFields].forEach(section => {
                    visitLimitInputs.forEach(f => {
                        const element = section ? section.querySelector(`[data-field="${f}"]`) : null;
                        if (element) {
                            element.addEventListener('input', e => { hotspot[f] = e.target.value; generateTwineCode(); hideCopyFeedback(); });
                        }
                    });
                });

                // --- Enable Condition Listeners (Common) ---
                const enableConditionCheckboxSelector = '[data-field="enableConditionVariable"]';
                [pFields, sFields, dFields].forEach(section => {
                    const checkbox = section ? section.querySelector(enableConditionCheckboxSelector) : null;
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            hotspot.enableConditionVariable = e.target.checked;
                            updateInnerFieldVisibility(hotspot, item);
                            generateTwineCode();
                            hideCopyFeedback();
                        });
                    }
                });

                // --- General Buttons ---
                item.querySelector('.delete-config-button').addEventListener('click', () => { 
                    showConfirmationModal(hotspot.id, hotspot.name || `Hotspot ${hotspot.id}`);
                    hideCopyFeedback();
                });

                item.querySelector('.scroll-to-top-button').addEventListener('click', () => {
                    imageEditor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
        }
        
        function removeHotspot(id) {
            hotspots = hotspots.filter(h => h.id !== id);
            renderHotspots();
            generateTwineCode();
        }

        function generateTwineCode() {
            // Use mainImageFilename if loading existing code, otherwise use the uploaded file name
            const currentFileName = mainImageFilename || (imageUpload.files[0] ? imageUpload.files[0].name : null);

            if (!imageDisplay.src || !imageDisplay.naturalWidth || !currentFileName) {
                outputCode.value = "<p>Carga una imagen para generar el código.</p>";
                return;
            }
            
            let twineCode = '';
            
            twineCode += `<div class="twine-image-wrapper" style="min-width:${imageDisplay.naturalWidth}px;">\n`;
            twineCode += `    <img src="imatges/${currentFileName.replace(/"/g, '&quot;')}" usemap="#hotspotmap" alt="Imatge amb hotspots">\n`;
            
            const dispW = imageDisplay.naturalWidth;
            const dispH = imageDisplay.naturalHeight;

            hotspots.forEach(hotspot => {
                // --- Overlay Image Generation ---
                if (hotspot.enableOverlay && hotspot.overlayImage && dispW && dispH) {
                    const coords = hotspot.coords.split(',').map(Number);
                    const width = coords[2] - coords[0];
                    const height = coords[3] - coords[1];
                    const left = coords[0];
                    const top = coords[1];

                    const leftPercent = (left / dispW * 100).toFixed(2);
                    const topPercent = (top / dispH * 100).toFixed(2);
                    const widthPercent = (width / dispW * 100).toFixed(2);
                    const heightPercent = (height / dispH * 100).toFixed(2);
                    
                    const filename = hotspot.overlayFilename || 'overlay.png';
                    
                    let imgTag = `    <img src="imatges/${filename}" class="twine-overlay" data-hotspot-id="${hotspot.id}" style="position:absolute; left:${leftPercent}%; top:${topPercent}%; width:${widthPercent}%; height:${heightPercent}%; pointer-events:none;">\n`;
                    
                    const overlayConditionString = buildConditionString(hotspot.overlayConditionVariable, hotspot.overlayConditionOperator, hotspot.overlayConditionValue);

                    if (overlayConditionString) {
                        imgTag = `(if: ${overlayConditionString})[${imgTag}]`;
                    }
                    
                    twineCode += imgTag;
                }
            });

            twineCode += '    <map name="hotspotmap">\n';
            hotspots.forEach(hotspot => {
                const coords = hotspot.coords;

                const altText = escapeHtml(hotspot.name || `Hotspot ${hotspot.id}`);
                
                twineCode += `    <!-- ${escapeHtml(hotspot.name) || `Hotspot ${hotspot.id}`} -->\n`; 
                let areaTag = `        <area shape="rect"\n`;
                areaTag += `            coords="${coords}"\n`;
                areaTag += `            alt="${altText}"\n`;
                areaTag += `            class="hotspot-item"\n`;
                
                // --- Overlay Data ---
                if (hotspot.enableOverlay && hotspot.overlayFilename) {
                    let finalOverlayName = hotspot.overlayFilename;
                    if (!finalOverlayName.startsWith('imatges/')) {
                        finalOverlayName = `imatges/${finalOverlayName}`;
                    }
                    areaTag += `            data-overlay-filename="${escapeHtml(finalOverlayName)}"\n`;
                }

                // Global Condition Vars (saved for parsing/editing)
                if (hotspot.enableOverlay) {
                    // Overlay activation status
                    areaTag += `            data-overlay-enabled="true"\n`;

                    // Overlay Condition for Interaction (Hotspot activation)
                    const overlayConditionString = buildConditionString(hotspot.overlayConditionVariable, hotspot.overlayConditionOperator, hotspot.overlayConditionValue);
                    if (overlayConditionString) {
                        areaTag += `            data-overlay-condition="${escapeHtml(overlayConditionString)}"\n`;
                    }
                    
                    // Vars for re-parsing
                    if (hotspot.overlayConditionVariable) areaTag += `            data-overlay-condition-var="${escapeHtml(hotspot.overlayConditionVariable)}"\n`;
                    if (hotspot.overlayConditionOperator) areaTag += `            data-overlay-condition-op="${escapeHtml(hotspot.overlayConditionOperator)}"\n`;
                    if (hotspot.overlayConditionValue) areaTag += `            data-overlay-condition-val="${escapeHtml(hotspot.overlayConditionValue)}"\n`;
                }


                // --- Secondary Variable (Common) ---
                if (hotspot.enableSecondaryVariable && hotspot.variable2 && hotspot.operator2 && hotspot.valor2) {
                    const secondarySetter = buildSetterValue(hotspot.variable2, hotspot.operator2, hotspot.valor2);
                    areaTag += `            data-variable-2-setter="${escapeHtml(secondarySetter)}"\n`;
                    
                    // Vars for re-parsing
                    areaTag += `            data-variable-2-var="${escapeHtml(hotspot.variable2)}"\n`;
                    areaTag += `            data-variable-2-op="${escapeHtml(hotspot.operator2)}"\n`;
                    areaTag += `            data-variable-2-val="${escapeHtml(hotspot.valor2)}"\n`;
                }
                
                // --- Dialog Action ---
                if (hotspot.type === 'dialog') {
                     areaTag += `            data-action="dialog"\n`;
                     if (hotspot.characterName) areaTag += `            data-character="${escapeHtml(hotspot.characterName)}"\n`;
                     
                     if (hotspot.infoTextDialog) areaTag += `            data_info="${escapeHtml(hotspot.infoTextDialog)}"\n`;
                     if (hotspot.soundDialog) areaTag += `            data-sound="${escapeHtml(hotspot.soundDialog)}"\n`; 
                     if (hotspot.titleTextDialog) areaTag += `            title="${escapeHtml(hotspot.titleTextDialog)}"\n`;

                     if (hotspot.enableConditionVariable && hotspot.dialogConditionVariable && hotspot.dialogConditionOperator && hotspot.dialogConditionValue) {
                        const conditionString = buildConditionString(hotspot.dialogConditionVariable, hotspot.dialogConditionOperator, hotspot.dialogConditionValue);
                        areaTag += `            data-condition="${escapeHtml(conditionString)}"\n`;
                        
                        // Vars for re-parsing
                        areaTag += `            data-condition-var="${escapeHtml(hotspot.dialogConditionVariable)}"\n`;
                        areaTag += `            data-condition-op="${escapeHtml(hotspot.dialogConditionOperator)}"\n`;
                        areaTag += `            data-condition-val="${escapeHtml(hotspot.dialogConditionValue)}"\n`;
                        
                        if (hotspot.dialogFailInfo) areaTag += `            text_fail_clic="${escapeHtml(hotspot.dialogFailInfo)}"\n`;
                        if (hotspot.dialogFailInfoEnter) areaTag += `            text_fail_enter="${escapeHtml(hotspot.dialogFailInfoEnter)}"\n`;
                        if (hotspot.dialogSoundFail) areaTag += `            data-sound-fail="${escapeHtml(hotspot.dialogSoundFail)}"\n`;
                        if (hotspot.dialogSoundClickFail) areaTag += `            data-sound-click-fail="${escapeHtml(hotspot.dialogSoundClickFail)}"\n`;
                    }
                }
                
                // --- Passage Action ---
                if (hotspot.type === 'passage') {
                    if (hotspot.enableConditionVariable && hotspot.passageConditionVariable && hotspot.passageConditionOperator && hotspot.passageConditionValue) {
                        const conditionString = buildConditionString(hotspot.passageConditionVariable, hotspot.passageConditionOperator, hotspot.passageConditionValue);
                        areaTag += `            data-condition="${escapeHtml(conditionString)}"\n`;
                        
                        // Vars for re-parsing
                        areaTag += `            data-condition-var="${escapeHtml(hotspot.passageConditionVariable)}"\n`;
                        areaTag += `            data-condition-op="${escapeHtml(hotspot.passageConditionOperator)}"\n`;
                        areaTag += `            data-condition-val="${escapeHtml(hotspot.passageConditionValue)}"\n`;
                        
                        if (hotspot.passageFailInfo) areaTag += `            text_fail_clic="${escapeHtml(hotspot.passageFailInfo)}"\n`;
                        if (hotspot.passageFailInfoEnter) areaTag += `            text_fail_enter="${escapeHtml(hotspot.passageFailInfoEnter)}"\n`;
                        if (hotspot.passageSoundFail) areaTag += `            data-sound-fail="${escapeHtml(hotspot.passageSoundFail)}"\n`;
                        if (hotspot.passageSoundClickFail) areaTag += `            data-sound-click-fail="${escapeHtml(hotspot.passageSoundClickFail)}"\n`;
                    }
                    if (hotspot.sound) areaTag += `            data-sound="${escapeHtml(hotspot.sound)}"\n`;
                    if (hotspot.soundClick) areaTag += `            data-sound-click="${escapeHtml(hotspot.soundClick)}"\n`;
                    if (hotspot.value) areaTag += `            data-passage="${escapeHtml(hotspot.value)}"\n`;
                    if (hotspot.infoText) areaTag += `            data_info="${escapeHtml(hotspot.infoText)}"\n`;
                    if (hotspot.infoText2) areaTag += `            data_info_2="${escapeHtml(hotspot.infoText2)}"\n`;
                    if (hotspot.transition) areaTag += `            data-transition-depart="${escapeHtml(hotspot.transition)}"\n`; 
                    if (hotspot.transitionArrive) areaTag += `            data-transition-arrive="${escapeHtml(hotspot.transitionArrive)}"\n`;
                    if (hotspot.titleText) areaTag += `            title="${escapeHtml(hotspot.titleText)}"\n`;
                } 
                
                // --- Setter Action ---
                else if (hotspot.type === 'setter') {
                    if (hotspot.enableConditionVariable && hotspot.setterConditionVariable && hotspot.setterConditionOperator && hotspot.setterConditionValue) {
                        const conditionString = buildConditionString(hotspot.setterConditionVariable, hotspot.setterConditionOperator, hotspot.setterConditionValue);
                        areaTag += `            data-condition="${escapeHtml(conditionString)}"\n`;
                        
                        // Vars for re-parsing
                        areaTag += `            data-condition-var="${escapeHtml(hotspot.setterConditionVariable)}"\n`;
                        areaTag += `            data-condition-op="${escapeHtml(hotspot.setterConditionOperator)}"\n`;
                        areaTag += `            data-condition-val="${escapeHtml(hotspot.setterConditionValue)}"\n`;
                        
                        if (hotspot.setterFailInfo) areaTag += `            text_fail_clic="${escapeHtml(hotspot.setterFailInfo)}"\n`;
                        if (hotspot.setterFailInfoEnter) areaTag += `            text_fail_enter="${escapeHtml(hotspot.setterFailInfoEnter)}"\n`;
                        if (hotspot.setterSoundFail) areaTag += `            data-sound-fail="${escapeHtml(hotspot.setterSoundFail)}"\n`;
                        if (hotspot.setterSoundClickFail) areaTag += `            data-sound-click-fail="${escapeHtml(hotspot.setterSoundClickFail)}"\n`;
                    }
                    if (hotspot.soundSetter) areaTag += `            data-sound="${escapeHtml(hotspot.soundSetter)}"\n`;
                    if (hotspot.soundClickSetter) areaTag += `            data-sound-click="${escapeHtml(hotspot.soundClickSetter)}"\n`;
                    
                    // Setter Macro Content
                    if (hotspot.setterVariable && hotspot.setterOperator && hotspot.setterValue) {
                        const setMacroContent = buildSetterValue(hotspot.setterVariable, hotspot.setterOperator, hotspot.setterValue);
                        areaTag += `            data-setter="${escapeHtml(setMacroContent)}"\n`;
                    }
                    
                    // Vars for re-parsing
                    if (hotspot.setterVariable) areaTag += `            data-variable-name="${escapeHtml(hotspot.setterVariable)}"\n`;
                    if (hotspot.setterOperator) areaTag += `            data-setter-op="${escapeHtml(hotspot.setterOperator)}"\n`;
                    if (hotspot.setterValue) areaTag += `            data-setter-val="${escapeHtml(hotspot.setterValue)}"\n`;
                    
                    if (hotspot.infoTextSetter) areaTag += `            data_info="${escapeHtml(hotspot.infoTextSetter)}"\n`;
                    if (hotspot.infoTextSetter2) areaTag += `            data_info_2="${escapeHtml(hotspot.infoTextSetter2)}"\n`;
                    if (hotspot.titleTextSetter) areaTag += `            title="${escapeHtml(hotspot.titleTextSetter)}"\n`;
                }

                // --- Visit Limit (Common) ---
                if (hotspot.enableVisitLimit) {
                    if (hotspot.visitLimit) areaTag += `            data-visit-limit="${escapeHtml(hotspot.visitLimit)}"\n`;
                    if (hotspot.visitLimitTextEnter) areaTag += `            data-visit-limit-enter="${escapeHtml(hotspot.visitLimitTextEnter)}"\n`;
                    if (hotspot.visitLimitTextClic) areaTag += `            data-visit-limit-clic="${escapeHtml(hotspot.visitLimitTextClic)}"\n`;
                }

                areaTag += `        >\n`;
                twineCode += areaTag;
                twineCode += `\n`;
            });
            twineCode += '    </map>\n';
            twineCode += `    <div id="twineImageInfoDisplay" style="display: none;">(live: 0.1s)[(print: $tempInfoDisplay)]</div>\n`;
            twineCode += '</div>\n\n';

            // --- Harlowe Link Block (for Passage) ---
            twineCode += '(live: 0.1s)[\n';
            twineCode += '    <span id="Ocult" style="display:none;">\n';
            hotspots.forEach(hotspot => {
                if (hotspot.type === 'passage' && hotspot.value) {
                    const passageNameForLink = hotspot.value.replace(/"/g, '\\"');
                    const transitionParts = [];

                    if (hotspot.transitionArrive && hotspot.transitionArrive !== 'Cap' && hotspot.transitionArrive !== 'instant') {
                        transitionParts.push(`(t8n-arrive: "${hotspot.transitionArrive.replace(/"/g, '\\"')}")`);
                    }
                    if (hotspot.transition && hotspot.transition !== 'Cap' && hotspot.transition !== 'instant') {
                        transitionParts.push(`(t8n-depart: "${hotspot.transition.replace(/"/g, '\\"')}")`);
                    }
                    
                    let harloweLinkContent = '';
                    if (transitionParts.length > 0) {
                        harloweLinkContent = transitionParts.join('+') + `(goto: "${passageNameForLink}")`;
                    } else {
                        harloweLinkContent = `(goto: "${passageNameForLink}")`;
                    }

                    let harloweLink = '';
                    
                    let activeCondition = "";
                    
                    if (hotspot.enableConditionVariable && hotspot.passageConditionVariable && hotspot.passageConditionOperator && hotspot.passageConditionValue) {
                        activeCondition = buildConditionString(hotspot.passageConditionVariable, hotspot.passageConditionOperator, hotspot.passageConditionValue);
                    }
                    
                    const overlayConditionString = buildConditionString(hotspot.overlayConditionVariable, hotspot.overlayConditionOperator, hotspot.overlayConditionValue);
                    
                    if (hotspot.enableOverlay && overlayConditionString) {
                        if (activeCondition) {
                            activeCondition = `(${activeCondition}) and (${overlayConditionString})`;
                        } else {
                            activeCondition = overlayConditionString;
                        }
                    }

                    if (activeCondition) {
                        harloweLink = `    (if: ${activeCondition})[(link: "${passageNameForLink}")[${harloweLinkContent}]]`;
                    } else {
                        harloweLink = `    (link: "${passageNameForLink}")[${harloweLinkContent}]`;
                    }
                    twineCode += `${harloweLink}\n`;
                }
            });
            twineCode += '    </span>\n';
            twineCode += ']\n';

            // --- JSON Dialog Block ---
            const DIALOG_LAYOUT_KEYS_TO_REMOVE = [
                "scale", "panOffset", "interactionMode", "draggingNodeId", 
                "resizingNodeId", "draggingOption", "dragOffset", "connectionStart", 
                "dragAllowed", "connectionStyle", "draggingCP", "panStart", 
                "resizeStart", "resizeInitialDim"
            ];


            hotspots.forEach(h => {
                if (h.type === 'dialog' && h.jsonContent) {
                    twineCode += `\n<!-- Dades de diàleg per a ${escapeHtml(h.characterName)} -->\n`;
                    twineCode += `<script type="application/json" id="${escapeHtml(h.characterName)}">\n`;
                    
                    try {
                        let jsonRaw = JSON.parse(h.jsonContent);
                        
                        const removeLayoutProps = (obj) => {
                            if (Array.isArray(obj)) {
                                return obj.map(removeLayoutProps);
                            } else if (typeof obj === 'object' && obj !== null) {
                                const newObj = {};
                                Object.keys(obj).forEach(key => {
                                    if (key !== 'x' && key !== 'y' && key !== 'width' && key !== 'height' && !DIALOG_LAYOUT_KEYS_TO_REMOVE.includes(key)) {
                                        
                                        // Specific recursive check for sub-objects
                                        if (key === 'connectionStart' || key === 'resizeInitialDim') {
                                             // Ensure these are removed, even if defined as sub-objects
                                             return;
                                        }

                                        newObj[key] = removeLayoutProps(obj[key]);
                                    }
                                });
                                return newObj;
                            }
                            return obj;
                        };
                        
                        const cleanJsonData = (obj) => {
                            if (Array.isArray(obj)) {
                                return obj.map(cleanJsonData);
                            } else if (typeof obj === 'object' && obj !== null) {
                                
                                // Clean avatarUrl/url paths for Twine
                                if (obj.avatarUrl && typeof obj.avatarUrl === 'string' && obj.avatarUrl.startsWith('data:image')) {
                                     if (obj.avatarFileName && typeof obj.avatarFileName === 'string') {
                                         obj.avatarUrl = `imatges/${obj.avatarFileName}`;
                                     }
                                }
                                if (obj.url && typeof obj.url === 'string' && obj.url.startsWith('data:image')) {
                                     if (obj.fileName && typeof obj.fileName === 'string') {
                                         obj.url = `imatges/${obj.fileName}`;
                                     }
                                }
                                
                                // Recursively clean nested objects
                                for (const key in obj) {
                                    if (typeof obj[key] === 'object' && obj[key] !== null) {
                                        obj[key] = cleanJsonData(obj[key]);
                                    }
                                }
                                return obj;
                            }
                            return obj;
                        };

                        let jsonClean = removeLayoutProps(jsonRaw);
                        jsonClean = cleanJsonData(jsonClean);
                        
                        twineCode += JSON.stringify(jsonClean, null, 4);
                    } catch (e) {
                        console.warn("Could not clean JSON for export, using raw content", e);
                        twineCode += h.jsonContent;
                    }

                    twineCode += `\n<\/script>\n`;
                }
            });

            outputCode.value = twineCode;
        }
        
        // --- Code Parsing Logic ---
        function copySetterValue(dataSetter) {
            if (!dataSetter || typeof dataSetter !== 'string') return { variable: '', operator: 'to', value: '' };

            const pattern = /^\$(\w+)\s*(to|set|==|!=|>=|<=|>|<|\+=|-=|\*=|(?:\/=|)=?)\s*(.*)/i;
            const match = dataSetter.match(pattern);

            if (match) {
                let variable = match[1] || '';
                let operator = (match[2] || 'to').toLowerCase();
                let value = match[3] || '';

                // Clean quotes from value
                if (value.startsWith('"') && value.endsWith('"') || value.startsWith("'") && value.endsWith("'")) {
                    value = value.slice(1, -1);
                }
                
                // Special case for 'set' -> 'to'
                if (operator === 'set') operator = 'to';
                // Special case for simple '=' (old style)
                if (operator === '=') operator = 'to';


                return { variable, operator, value };
            }
            // If it doesn't match the standard pattern, fall back to simple assignment
            return { variable: dataSetter, operator: 'to', value: '' };
        }

        function copyConditionValue(dataCondition) {
            if (!dataCondition || typeof dataCondition !== 'string') return { variable: '', operator: 'is', value: '' };

            const conditionPattern = /^\s*(\$[\w\d]+)\s*(is|==|!=|>=|<=|>|<|not)\s*(.*)/i;
            const match = dataCondition.match(conditionPattern);

            if (match) {
                let variable = match[1] ? match[1].substring(1) : ''; // Remove $
                let operator = (match[2] || 'is').toLowerCase();
                let value = match[3] || '';

                // Clean quotes from value
                if (value.startsWith('"') && value.endsWith('"') || value.startsWith("'") && value.endsWith("'")) {
                    value = value.slice(1, -1);
                }

                return { variable, operator, value };
            }
            return { variable: '', operator: 'is', value: '' };
        }


        copyCodeButton.addEventListener('click', () => {
            outputCode.select(); 
            document.execCommand('copy'); 
            copyFeedback.style.display = 'inline-block'; 
            setTimeout(() => {
                copyFeedback.style.display = 'none'; 
            }, 2000);
        });

        loadCodeButton.addEventListener('click', () => {
            hideCopyFeedback(); 
            const codeToParse = outputCode.value;
            if (codeToParse.trim() === "") {
                alert("El campo de código está vacío. Pega el código HTML/Harlowe para cargar.");
                return;
            }
            parseTwineCode(codeToParse);
            // Clear the input value after successful parsing attempt, regardless of whether folder was asked
            outputCode.value = ""; 
        });

        function parseTwineCode(code) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(code, 'text/html'); 

            const imgElement = doc.querySelector('.twine-image-wrapper img[usemap]'); 
            if (!imgElement) {
                alert("No se ha encontrado ninguna etiqueta <img> con usemap dentro de .twine-image-wrapper.");
                return;
            }

            const mapName = imgElement.getAttribute('usemap').substring(1); 
            const mapElement = doc.querySelector(`map[name="${mapName}"]`);

            if (!mapElement) {
                alert(`No se ha encontrado la etiqueta <map name="${mapName}"> asociada a la imagen.`);
                return;
            }

            const hasOverlays = doc.querySelectorAll('.twine-overlay').length > 0;
            const hasMainImage = doc.querySelector('.twine-image-wrapper img[usemap]');
            
            let missingImages = false;
            // Check for missing overlay images
            if (hasOverlays) {
                 const overlays = doc.querySelectorAll('.twine-overlay');
                 for (let img of overlays) {
                     const src = img.getAttribute('src');
                     if (src) {
                         const filename = src.split(/[/\\]/).pop();
                         if (!projectImages[filename]) {
                             missingImages = true;
                             break;
                         }
                     }
                 }
            }
            
            // Check for missing main image
            if (hasMainImage) {
                const src = hasMainImage.getAttribute('src');
                if (src) {
                    const filename = src.split(/[/\\]/).pop();
                    if (!projectImages[filename] && !imageDisplay.src) {
                         missingImages = true;
                    }
                }
            }
            
            // IMPORTANT: If we need images OR the image src is defined but not yet visible, ask for folder
            if (missingImages) {
                pendingParseCode = code;
                document.getElementById('folderRequestModal').style.display = 'flex';
                // The code will be processed by folderInput listener or cancelFolderButton handler
            } else {
                // If no images are missing (all images either local or not needed)
                processTwineCode(code);
            }
        }
        
        function processTwineCode(code) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(code, 'text/html'); 

            const imgElement = doc.querySelector('.twine-image-wrapper img[usemap]'); 
            if (!imgElement) {
                alert("No se ha encontrado ninguna etiqueta <img> con usemap dentro de .twine-image-wrapper.");
                return;
            }
            
            // --- 1. Load Main Image ---
            const mainSrc = imgElement.getAttribute('src');
            let needsRerender = false; 
            let currentMainFilename = null; 

            if (mainSrc) {
                currentMainFilename = mainSrc.split(/[/\\]/).pop(); 
                
                // Determine the correct source: local file or direct path
                const newImageSrc = projectImages[currentMainFilename] || mainSrc;
                
                if (imageDisplay.src !== newImageSrc) {
                     imageDisplay.style.display = 'block';
                     imageDisplay.src = newImageSrc;
                     needsRerender = true;
                } else {
                    imageDisplay.style.display = 'block';
                }
            } else {
                imageDisplay.src = '';
                imageDisplay.style.display = 'none';
                drawingInstructions.style.display = 'block';
                imageEditor.style.height = 'auto';
                imageEditor.style.minHeight = '400px';
            }

            // --- 2. Hotspot Parsing Logic ---
            const parseAndRender = (mainFilename) => {
                const mapName = imgElement.getAttribute('usemap').substring(1); 
                const mapElement = doc.querySelector(`map[name="${mapName}"]`);

                if (!mapElement) {
                    alert(`No se ha encontrado la etiqueta <map name="${mapName}"> asociada a la imagen.`);
                    return;
                }

                hotspots = [];
                let maxHotspotId = 0;
                const areaElements = mapElement.querySelectorAll('area'); 
                
                let tempHotspotIdCounter = 0;

                areaElements.forEach(area => { // Línia 2718 (aproximada, inici del forEach)
                    tempHotspotIdCounter++;
                    maxHotspotId = Math.max(maxHotspotId, tempHotspotIdCounter);

                    // --- Common Data Attributes ---
                    const coords = area.getAttribute('coords');
                    const altText = area.getAttribute('alt');
                    const title = area.getAttribute('title');
                    const dataPassage = area.getAttribute('data-passage');
                    const dataSetter = area.getAttribute('data-setter'); 
                    const dataAction = area.getAttribute('data-action'); 
                    const dataSound = area.getAttribute('data-sound'); 
                    const dataSoundClick = area.getAttribute('data-sound-click'); 
                    const dataInfo = area.getAttribute('data_info');
                    const dataInfo2 = area.getAttribute('data_info_2');
                    
                    // --- Dialog Specific ---
                    const dataCharacter = area.getAttribute('data-character'); 
                    
                    // --- Overlay Condition ---
                    const overlayEnabled = area.getAttribute('data-overlay-enabled') === 'true'; // NEW: overlay enabled
                    
                    let overlayFilename = area.getAttribute('data-overlay-filename');
                    if (overlayFilename && overlayFilename.startsWith('imatges/')) {
                        overlayFilename = overlayFilename.substring(8); 
                    }
                    
                    const overlayCondVar = area.getAttribute('data-overlay-condition-var') || '';
                    const overlayCondOp = area.getAttribute('data-overlay-condition-op') || 'is';
                    const overlayCondVal = area.getAttribute('data-overlay-condition-val') || '';
                    
                    let overlayImageSrc = null;
                    if (overlayFilename && projectImages[overlayFilename]) {
                         overlayImageSrc = projectImages[overlayFilename];
                    } else if (overlayFilename) {
                        overlayImageSrc = `imatges/${overlayFilename}`;
                    }

                    // --- Secondary Variables ---
                    const dataVariable2Var = area.getAttribute('data-variable-2-var');
                    const dataVariable2Op = area.getAttribute('data-variable-2-op');
                    const dataVariable2Val = area.getAttribute('data-variable-2-val');
                    
                    // --- Visit Limit ---
                    const visitLimit = area.getAttribute('data-visit-limit');
                    const visitLimitTextEnter = area.getAttribute('data-visit-limit-enter');
                    const visitLimitTextClic = area.getAttribute('data-visit-limit-clic');
                    
                    // --- General Conditional Fields ---
                    const dataConditionVar = area.getAttribute('data-condition-var');
                    const dataConditionOp = area.getAttribute('data-condition-op');
                    const dataConditionVal = area.getAttribute('data-condition-val');
                    // Fallback for old system (data-condition)
                    const dataCondition = area.getAttribute('data-condition');

                    // --- Setter Builder Fields ---
                    const dataVariableName = area.getAttribute('data-variable-name');
                    const dataSetterOp = area.getAttribute('data-setter-op');
                    const dataSetterVal = area.getAttribute('data-setter-val');


                    let newHotspot = {
                        id: tempHotspotIdCounter,
                        coords: coords,
                        name: altText || `Hotspot ${tempHotspotIdCounter}`,
                        type: 'passage', 
                        value: '',
                        titleText: '', sound: '', soundClick: '', infoText: '', infoText2: '',
                        transition: '', transitionArrive: '',
                        
                        // Setter Builder defaults:
                        setterVariable: '', setterOperator: 'to', setterValue: '', 
                        
                        // Secondary Variable fields (UPDATED)
                        variable2: dataVariable2Var || '', 
                        operator2: dataVariable2Op || 'to', 
                        valor2: dataVariable2Val || '', 

                        characterName: '',
                        jsonContent: '',
                        jsonFileName: '',
                        infoTextDialog: '', soundDialog: '', titleTextDialog: '',
                        
                        // Conditional Builder fields (Dialog)
                        dialogConditionVariable: dataConditionVar || '', dialogConditionOperator: dataConditionOp || 'is', dialogConditionValue: dataConditionVal || '', 
                        dialogFailInfo: '', dialogFailInfoEnter: '', dialogSoundFail: '', dialogSoundClickFail: '',
                        
                        // Conditional Builder fields (Passage)
                        passageConditionVariable: dataConditionVar || '', passageConditionOperator: dataConditionOp || 'is', passageConditionValue: dataConditionVal || '', 
                        passageFailInfo: '', passageFailInfoEnter: '', passageSoundFail: '', passageSoundClickFail: '',
                        
                        // Conditional Builder fields (Setter)
                        setterConditionVariable: dataConditionVar || '', setterConditionOperator: dataConditionOp || 'is', setterConditionValue: dataConditionVal || '', 
                        setterFailInfo: '', setterFailInfoEnter: '', setterSoundFail: '', setterSoundClickFail: '',
                        
                        visitLimit: visitLimit || '', visitLimitTextEnter: visitLimitTextEnter || '', visitLimitTextClic: visitLimitTextClic || '', 
                        enableVisitLimit: (visitLimit || visitLimitTextEnter || visitLimitTextClic) ? true : false,
                        enableSecondaryVariable: (dataVariable2Var || dataVariable2Val) ? true : false, 
                        enableConditionVariable: (dataConditionVar || dataConditionVal || dataCondition) ? true : false,
                        
                        // Overlay Fields
                        enableOverlay: overlayEnabled || (overlayFilename ? true : false), // NEW: Load status (activate if filename is present)
                        overlayFilename: overlayFilename || null,
                        overlayConditionVariable: overlayCondVar,
                        overlayConditionOperator: overlayCondOp,
                        overlayConditionValue: overlayCondVal,
                        overlayImage: overlayImageSrc 
                    };
                    
                    if (dataAction === 'dialog') {
                        newHotspot.type = 'dialog';
                        newHotspot.characterName = dataCharacter || '';
                        
                        if (dataCharacter) { 
                             const scriptTag = doc.getElementById(dataCharacter);
                             if (scriptTag) {
                                 newHotspot.jsonContent = scriptTag.textContent.trim();
                                 newHotspot.jsonFileName = 'Dades carregades del codi';
                             }
                        }
                        newHotspot.infoTextDialog = dataInfo || '';
                        newHotspot.soundDialog = dataSound || '';
                        newHotspot.titleTextDialog = title || '';
                        
                        // Conditional (override defaults)
                        if (dataCondition) {
                            const { variable, operator, value } = copyConditionValue(dataCondition);
                            newHotspot.dialogConditionVariable = dataConditionVar ? dataConditionVar.substring(1) : variable;
                            newHotspot.dialogConditionOperator = dataConditionOp || operator;
                            newHotspot.dialogConditionValue = dataConditionVal || value;
                        }
                        newHotspot.dialogFailInfo = area.getAttribute('text_fail_clic') || '';
                        newHotspot.dialogFailInfoEnter = area.getAttribute('text_fail_enter') || '';
                        newHotspot.dialogSoundFail = area.getAttribute('data-sound-fail') || '';
                        newHotspot.dialogSoundClickFail = area.getAttribute('data-sound-click-fail') || '';
                        newHotspot.enableConditionVariable = (dataConditionVar || dataConditionVal || dataCondition) ? true : false;
                        

                    } else if (dataPassage) {
                        newHotspot.type = 'passage';
                        newHotspot.value = dataPassage;
                        newHotspot.titleText = title || '';
                        newHotspot.sound = dataSound || ''; 
                        newHotspot.soundClick = dataSoundClick || ''; 
                        newHotspot.infoText = dataInfo || '';
                        newHotspot.infoText2 = dataInfo2 || '';
                        newHotspot.transition = area.getAttribute('data-transition-depart') || '';
                        newHotspot.transitionArrive = area.getAttribute('data-transition-arrive') || ''; 
                        
                        // Conditional (override defaults)
                        if (dataCondition) {
                            const { variable, operator, value } = copyConditionValue(dataCondition);
                            newHotspot.passageConditionVariable = dataConditionVar ? dataConditionVar.substring(1) : variable;
                            newHotspot.passageConditionOperator = dataConditionOp || operator;
                            newHotspot.passageConditionValue = dataConditionVal || value;
                        }
                        newHotspot.passageFailInfo = area.getAttribute('text_fail_clic') || '';
                        newHotspot.passageFailInfoEnter = area.getAttribute('text_fail_enter') || '';
                        newHotspot.passageSoundFail = area.getAttribute('data-sound-fail') || '';
                        newHotspot.passageSoundClickFail = area.getAttribute('data-sound-click-fail') || '';
                        newHotspot.enableConditionVariable = (dataConditionVar || dataConditionVal || dataCondition) ? true : false;

                    } else if (dataSetter) {
                        newHotspot.type = 'setter';
                        newHotspot.titleTextSetter = title || '';
                        newHotspot.soundSetter = dataSound || ''; 
                        newHotspot.soundClickSetter = dataSoundClick || ''; 
                        newHotspot.infoTextSetter = dataInfo || '';
                        newHotspot.infoTextSetter2 = dataInfo2 || '';
                        
                        // Setter Builder Fields
                        const { variable: oldVar, operator: oldOp, value: oldVal } = copySetterValue(dataSetter);
                        
                        // CORRECCIÓ: Si dataVariableName existeix, ja ve sense el $ (perquè l'usuari l'hauria introduit sense)
                        // Si no existeix, utilitzem oldVar, que ja ve netejat de $ per copySetterValue si la va trobar.
                        newHotspot.setterVariable = dataVariableName || oldVar; 
                        newHotspot.setterOperator = dataSetterOp || oldOp;
                        newHotspot.setterValue = dataSetterVal || oldVal;
                        
                        // Conditional (override defaults)
                        if (dataCondition) {
                            const { variable, operator, value } = copyConditionValue(dataCondition);
                            newHotspot.setterConditionVariable = dataConditionVar ? dataConditionVar.substring(1) : variable;
                            newHotspot.setterConditionOperator = dataConditionOp || operator;
                            newHotspot.setterConditionValue = dataConditionVal || value;
                        }
                        newHotspot.setterFailInfo = area.getAttribute('text_fail_clic') || '';
                        newHotspot.setterFailInfoEnter = area.getAttribute('text_fail_enter') || '';
                        newHotspot.setterSoundFail = area.getAttribute('data-sound-fail') || '';
                        newHotspot.setterSoundClickFail = area.getAttribute('data-sound-click-fail') || '';
                        newHotspot.enableConditionVariable = (dataConditionVar || dataConditionVal || dataCondition) ? true : false;
                    }
                    
                    hotspots.push(newHotspot);
                });
                hotspotIdCounter = maxHotspotId;

                // Set mainImageFilename for correct Twine output if loading from existing code
                if (mainFilename) {
                     mainImageFilename = mainFilename;
                }
                
                // Finally render inputs and code
                renderHotspots();
                generateTwineCode();
            };

            // If the image source changed, wait for it to load before calculating visual coordinates
            if (needsRerender) {
                // Ensure the previous onload is handled, then set the new one
                 imageDisplay.onload = () => {
                     imageDisplay.onload = null; // Clear handler
                     const extraSpace = 80;
                     imageEditor.style.minHeight = imageDisplay.offsetHeight + extraSpace + 'px';
                     imageEditor.style.height = imageDisplay.offsetHeight + extraSpace + 'px';
                     parseAndRender(currentMainFilename); 
                 };
            } else {
                // Image source did not change, or it's already loaded (first time load, etc.)
                // Need to ensure the dimensions are set if it was previously hidden/empty
                if (imageDisplay.src && imageDisplay.style.display !== 'none') {
                    imageDisplay.style.display = 'block';
                    drawingInstructions.style.display = 'none';
                    editorImageInfoDisplay.style.display = 'none';
                }
                parseAndRender(currentMainFilename); 
            }
        }

        // Call setupConfirmationModal on page load
        document.addEventListener('DOMContentLoaded', setupConfirmationModal);
        // --- FI DEL JAVASCRIPT ---
    </script>
</body>
</html>
